      <!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bradaa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" defer></script>

    <meta name="description" content="AI Bradaa Strategic Command surfaces Malaysia-first AI laptop intelligence, comparisons, and operations tooling.">
    <link rel="canonical" href="https://ai-bradaa.com/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Bradaa Strategic Command">
    <meta property="og:description" content="Malaysia-first AI laptop intelligence, matchup analysis, and advanced ops tooling by AI Bradaa.">
    <meta property="og:url" content="https://ai-bradaa.com/">
    <meta property="og:image" content="/icons/icon-1024.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Bradaa Strategic Command">
    <meta name="twitter:description" content="Malaysia-first AI laptop intel and tooling by AI Bradaa.">
    <meta name="twitter:image" content="/icons/icon-1024.png">
    <link rel="manifest" href="/pwa/manifest.json">
    <meta name="theme-color" content="#010409">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        :root {
            --c-bg: #010409;
            --c-glass: rgba(13, 17, 23, 0.6);
            --c-border: rgba(48, 54, 61, 0.8);
            --c-glow: rgba(0, 240, 255, 0.7);
            --c-accent-pink: #D83F87;
            --c-accent-cyan: #00F0FF;
            --c-text-primary: #E6EDF3;
            --c-text-secondary: #A8B2CC;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Share Tech Mono', monospace;
        }
        body { font-family: var(--font-body); background-color: var(--c-bg); color: var(--c-text-primary); }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background-image:
                radial-gradient(circle at 10% 20%, var(--c-accent-cyan), transparent 30%),
                radial-gradient(circle at 90% 80%, var(--c-accent-pink), transparent 30%),
                radial-gradient(circle at 50% 50%, #4A00E0, transparent 40%);
            background-size: 200% 200%; filter: blur(100px); opacity: 0.15; z-index: -1;
            animation: aurora 25s linear infinite;
        }
        @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .font-display { font-family: var(--font-display); text-shadow: 0 0 5px var(--c-accent-cyan), 0 0 10px var(--c-accent-cyan); }
        .card { background-color: var(--c-glass); backdrop-filter: blur(24px); border: 1px solid var(--c-border); border-radius: 0.75rem; position: relative; overflow: hidden; }
        .card::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; z-index: 0;
            background: conic-gradient(from 180deg at 50% 50%, var(--c-accent-cyan), var(--c-accent-pink), var(--c-accent-cyan));
            transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.5s ease-in-out; animation: rotate 8s linear infinite;
        }
        .card:hover::before { opacity: 0.5; }
        @keyframes rotate { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .card-content { position: relative; z-index: 1; padding: 1.5rem; }
        .nav-sticky { position: sticky; top: 0; z-index: 50; background-color: rgba(1, 4, 9, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid var(--c-border); }
        .nav-button { border-bottom: 2px solid transparent; transition: all 0.3s; }
        .nav-button:hover, .nav-button.active { color: var(--c-accent-cyan); border-bottom-color: var(--c-accent-cyan); text-shadow: 0 0 5px var(--c-accent-cyan); }
        .filter-button.active { background-color: var(--c-accent-pink); border-color: var(--c-accent-pink); color: var(--c-text-primary); }
        .tool-selector-btn { text-align: left; width: 100%; padding: 0.75rem; border-radius: 0.375rem; transition: all 0.2s; border: 1px solid transparent;}
        .tool-selector-btn:hover { background-color: var(--c-border); }
        .tool-selector-btn.active {
            background-color: var(--c-accent-cyan);
            color: var(--c-bg);
            border-color: var(--c-accent-cyan);
            font-weight: bold;
            box-shadow: 0 0 8px var(--c-accent-cyan), 0 0 16px rgba(0, 240, 255, 0.5);
        }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--c-accent-cyan); }
        select, input, textarea { font-family: var(--font-body); background-color: rgba(1, 4, 9, 0.8); border: 1px solid var(--c-border); border-radius: 0.375rem; padding: 0.65rem; }
        .action-button { background-color: var(--c-accent-pink); color: white; padding: 0.65rem 1.5rem; font-weight: bold; border-radius: 0.375rem; transition: opacity 0.2s; cursor: pointer; } .action-button:hover { opacity: 0.9; }
        section { padding-top: 6rem; margin-top: -5rem; }
        .gemini-output { white-space: pre-wrap; line-height: 1.7; }
        .ai-pod-response { border: 1px solid rgba(0,240,255,0.18); background: linear-gradient(145deg, rgba(5,9,18,0.95), rgba(9,21,36,0.92)); border-radius: 12px; padding: 0.8rem 1rem; color: var(--c-text-secondary); box-shadow: 0 12px 24px rgba(0,0,0,0.35); }
        .ai-pod-response__header { display: flex; align-items: center; justify-content: space-between; font-size: 0.82rem; margin-bottom: 0.5rem; opacity: 0.9; }
        .ai-pod-response__title { font-family: var(--font-display); letter-spacing: 0.12em; color: var(--c-accent-cyan); text-transform: uppercase; font-size: 0.85rem; }
        .ai-pod-response__time { font-variant-numeric: tabular-nums; opacity: 0.85; }
        .ai-pod-response__body { font-size: 0.95rem; line-height: 1.7; color: var(--c-text-secondary); }
        #gemini-comparison-output {
            background: radial-gradient(circle at top left, rgba(216, 63, 135, 0.35), transparent 45%),
                        linear-gradient(145deg, rgba(5, 9, 18, 0.95), rgba(9, 21, 36, 0.92));
            border: 1px solid rgba(0, 240, 255, 0.1);
            border-radius: 18px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
            color: var(--c-text-secondary);
            font-family: var(--font-body);
            backdrop-filter: blur(12px);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        #gemini-comparison-output:hover {
            border-color: rgba(0, 240, 255, 0.35);
            box-shadow: 0 28px 60px rgba(0, 0, 0, 0.55);
        }
        .comparison-output {
            display: grid;
            gap: 1.5rem;
        }
        .comparison-layer {
            display: grid;
            gap: 1.25rem;
        }
        .comparison-overview {
            display: grid;
            gap: 0.75rem;
        }
        .comparison-overview p {
            margin: 0;
            font-size: 0.95rem;
            color: var(--c-text-primary);
        }
        .comparison-cards {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }
        .comparison-card {
            background: linear-gradient(160deg, rgba(12, 22, 34, 0.92), rgba(3, 8, 14, 0.88));
            border: 1px solid rgba(0, 240, 255, 0.15);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 12px 24px rgba(0, 0, 0, 0.35);
            display: grid;
            gap: 0.75rem;
        }
        .comparison-card header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .comparison-card h3 {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--c-text-primary);
            letter-spacing: 0.02em;
        }
        .comparison-card p {
            margin: 0;
            font-size: 0.88rem;
            color: rgba(231, 238, 255, 0.82);
        }
        .comparison-section {
            display: grid;
            gap: 0.5rem;
        }
        .comparison-chip {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            font-weight: 700;
            padding: 0.25rem 0.65rem;
            border-radius: 999px;
            background: linear-gradient(120deg, rgba(0, 240, 255, 0.25), rgba(216, 63, 135, 0.35));
            color: #ECF6FF;
        }
        .comparison-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.72rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 700;
            padding: 0.25rem 0.65rem;
            border-radius: 999px;
            background: linear-gradient(120deg, rgba(216, 63, 135, 0.35), rgba(0, 240, 255, 0.25));
            color: #ECF6FF;
        }
        .comparison-chip + .comparison-chip {
            margin-left: 0.35rem;
        }
        .comparison-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .comparison-list li {
            position: relative;
            margin: 0.4rem 0;
            padding-left: 1.25rem;
            font-size: 0.88rem;
            color: rgba(231, 238, 255, 0.85);
        }
        .comparison-list li::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 999px;
            left: 0.35rem;
            top: 0.55rem;
            background: linear-gradient(135deg, #00F0FF, #D83F87);
        }
        .comparison-notes p {
            margin: 0;
            font-size: 0.88rem;
            color: rgba(231, 238, 255, 0.8);
        }
        .gemini-output ul { list-style-type: disc; padding-left: 1.5rem; }
        .gemini-output strong { color: var(--c-accent-pink); }
        .mission-brief-output { font-size: 0.82rem; line-height: 1.6; color: var(--c-text-secondary); }

        @keyframes consoleFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .console-animating > * {
            animation: consoleFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        /* Intel cards minimal styles */
        .intel-grid { display: grid; gap: 1.75rem; }
        @media (min-width: 1280px) { .intel-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 1024px) and (max-width: 1279px) { .intel-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (max-width: 1023px) { .intel-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); } }
        @media (max-width: 640px) { .intel-grid { grid-template-columns: 1fr; gap: 1rem; } }
        .intel-card { background: linear-gradient(160deg, rgba(0, 240, 255, 0.18), rgba(216, 63, 135, 0.08)); border: 1px solid rgba(0, 240, 255, 0.25); border-radius: 0.85rem; padding: 1.25rem; box-shadow: 0 12px 36px rgba(0,0,0,0.45); display: flex; flex-direction: column; min-height: 260px; }
        .intel-card__header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.75rem; }
        .intel-chip { font-family: var(--font-display); color: var(--c-accent-cyan); text-shadow: 0 0 6px var(--c-accent-cyan); font-size: 0.95rem; }
        .intel-chip--pulse { animation: intelPulse 1.2s ease-in-out infinite alternate; }
        @keyframes intelPulse { from { opacity: 0.6; } to { opacity: 1; } }
        .intel-card__title { font-family: var(--font-display); font-size: 1.1rem; margin: 0 0 0.75rem; color: var(--c-text-primary); text-shadow: 0 0 12px rgba(0,240,255,0.55); line-height: 1.25; }
        .intel-card__title a { color: inherit; text-decoration: underline; text-decoration-thickness: 2px; text-underline-offset: 4px; }
        .intel-summary { color: var(--c-text-secondary); font-size: 0.95rem; line-height: 1.6; flex: 1 1 auto; }
        .intel-meta { margin-top: 1rem; display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; color: var(--c-text-secondary); font-size: 0.85rem; }
        .intel-label { font-weight: 700; color: var(--c-text-primary); margin-right: 0.25rem; }
        .intel-status { font-weight: 800; letter-spacing: 0.04em; }
        .intel-status--positive { color: #7CFFA7; text-shadow: 0 0 6px rgba(124,255,167,0.6); }
        .intel-status--neutral { color: #FFD65C; text-shadow: 0 0 6px rgba(255,214,92,0.6); }
        .intel-status--watch { color: #FF8A8A; text-shadow: 0 0 6px rgba(255,138,138,0.6); }
        .intel-status--standby { color: var(--c-text-secondary); }
        .intel-link { color: var(--c-accent-cyan); font-size: 0.8rem; white-space: nowrap; }
        .intel-link--secondary { opacity: 0.8; }
        .laptop-image { transition: opacity 0.4s ease, filter 0.4s ease; opacity: 0.65; filter: grayscale(20%); background: radial-gradient(circle at 50% 30%, rgba(0, 240, 255, 0.15), transparent 60%); }
        .laptop-image--ready { opacity: 1; filter: none; }
        .ai-image-badge { position: absolute; top: 0.75rem; left: 0.75rem; font-size: 0.65rem; letter-spacing: 0.08em; background: rgba(1, 4, 9, 0.8); border: 1px solid rgba(0, 240, 255, 0.4); padding: 0.35rem 0.7rem; border-radius: 9999px; text-transform: uppercase; color: var(--c-accent-cyan); box-shadow: 0 0 10px rgba(0, 240, 255, 0.4); display: inline-flex; align-items: center; gap: 0.25rem; }
        .ai-image-badge svg { width: 12px; height: 12px; }
        .ai-image-attrib { font-size: 0.7rem; color: var(--c-text-secondary); margin-top: 0.5rem; opacity: 0.75; }
        .toolkit-layout { display: block; position: relative; }
        .toolkit-briefing { border-radius: 1.25rem; border: 1px solid rgba(0,240,255,0.18); background:
            linear-gradient(180deg, rgba(4,8,14,0.96), rgba(4,8,14,0.92)),
            radial-gradient(circle at 18% 22%, rgba(0,240,255,0.10), transparent 52%),
            radial-gradient(circle at 82% 78%, rgba(216,63,135,0.08), transparent 50%);
            box-shadow: 0 0 32px rgba(0,240,255,0.12);
            padding: 1.75rem; display: flex; flex-direction: column; gap: 1.75rem; position: relative; overflow: hidden; width: 100%; }
        .toolkit-briefing::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(0,240,255,0.08), rgba(216,63,135,0.08)); opacity: 0.4; pointer-events: none; }
        .toolkit-briefing-header { position: relative; display: flex; justify-content: space-between; align-items: center; }
        .toolkit-briefing-header h3 { font-family: var(--font-display); font-size: 1.9rem; color: var(--c-accent-cyan); margin: 0; }
        .toolkit-status { display: flex; gap: 0.5rem; align-items: center; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; }
        .toolkit-status span { padding: 0.45rem 0.75rem; border-radius: 999px; border: 1px solid rgba(0,240,255,0.3); color: var(--c-accent-cyan); background: rgba(0,240,255,0.08); position: relative; overflow: hidden; }
        .toolkit-status span[data-status="live"]::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(0,240,255,0), rgba(0,240,255,0.6), rgba(0,240,255,0)); animation: pulse-sweep 2.2s infinite; }
        @keyframes pulse-sweep { 0% { transform: translateX(-100%); opacity: 0; } 30% { opacity: 0.6; } 100% { transform: translateX(100%); opacity: 0; } }
        .toolkit-gauge { position: relative; height: 260px; display: flex; justify-content: center; align-items: center; margin: 0 auto 0.5rem; width: min(360px, 100%); padding: 1.25rem; --gauge-progress: 0.72; --gauge-color-start: #00F0FF; --gauge-color-end: #D83F87; --gauge-track: rgba(0, 240, 255, 0.08); --ferro-glow: rgba(230,0,128,0.9); --ferro-splash-base: rgba(255, 95, 220, 0.92); --ferro-splash-rim: rgba(255, 178, 238, 0.92); --ferro-droplet-base: rgba(255, 168, 236, 0.86); }
        .toolkit-gauge::before { content: ''; position: absolute; inset: 4px; border-radius: 999px; background: radial-gradient(circle at 50% 30%, rgba(0,240,255,0.22), transparent 70%); filter: blur(12px); opacity: 0.85; }
        /* No outer ring — ferrofluid takes center stage */
        .toolkit-gauge-ferro { position: absolute; width: 180px; height: 180px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; background: transparent; transform: translate(var(--mx, 0px), var(--my, 0px)); overflow: visible; }
        .toolkit-gauge-value { display: none; }
        /* Venom ferrofluid core glow */
        .ferro-core-glow { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: visible; }
        .ferro-core-glow circle { fill: var(--ferro-glow, rgba(230,0,128,0.9)); filter: blur(28px) drop-shadow(0 0 48px var(--ferro-glow)); animation: core-pulse 2.4s ease-in-out infinite; }
        .ferro-core-glow, .ferro-splash { background: none !important; }
        @keyframes core-pulse { 0%,100% { opacity: 0.75; transform: scale(0.88); } 50% { opacity: 1; transform: scale(1.12); } }
        /* Venom splash active */
        .ferro-splash { display: block !important; }
        .ferro-splash { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3; }
        /* Glossy black venom body with neon stage glow */
        .ferro-splash .splash-main { fill: rgba(10,10,14,0.98); stroke: rgba(34,34,42,0.9); stroke-width: 2.1; stroke-linejoin: round; stroke-linecap: round; opacity: 0.98; paint-order: fill stroke; filter: drop-shadow(0 0 14px rgba(0,0,0,0.55)) drop-shadow(0 0 32px var(--ferro-glow)); }
        .ferro-splash .splash-droplet { fill: rgba(16,16,20,0.96); stroke: rgba(42,42,52,0.85); stroke-width: 1.3; filter: drop-shadow(0 0 8px rgba(0,0,0,0.5)) drop-shadow(0 0 22px var(--ferro-glow)); }
        /* Qibla Kaabah marker styling */
        .qibla-marker { fill: rgba(5,5,8,0.82); stroke: rgba(255,213,74,0.9); stroke-width: 1; opacity: 0.58; filter: drop-shadow(0 0 3px rgba(255,213,74,0.22)); transition: opacity 0.4s ease, filter 0.4s ease; }
        .qibla-marker-band { fill: rgba(255,213,74,0.88); opacity: 0.7; }
        .qibla-halo { fill: rgba(255,213,74,0.1); filter: blur(2.2px); opacity: 0.45; transition: opacity 0.4s ease; }
        #toolkit-gauge[data-stage="success"] .qibla-marker { stroke: rgba(120,255,190,0.75); filter: drop-shadow(0 0 3px rgba(120,255,190,0.3)); }
        #toolkit-gauge[data-stage="success"] .qibla-halo { opacity: 0.3; }
        #toolkit-gauge[data-stage="error"] .qibla-marker { stroke: rgba(255,128,128,0.65); filter: drop-shadow(0 0 2px rgba(255,128,128,0.24)); }
        #toolkit-gauge[data-stage="error"] .qibla-halo { opacity: 0.28; }
        /* High-fidelity Soul texture overlays */
        .ferro-overlay-root { position: absolute; top: 50%; left: 50%; width: 186px; height: 186px; transform: translate(-50%, -50%); pointer-events: none; z-index: 4; opacity: 0; transition: opacity 0.45s ease; }
        .ferro-overlay-root[data-enabled="false"] { display: none; }
        .ferro-overlay { position: absolute; inset: 0; background-repeat: no-repeat; background-position: center; background-size: contain; opacity: 0; transition: opacity 0.35s ease; filter: drop-shadow(0 0 18px rgba(0,0,0,0.45)); }
        .ferro-overlay::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle, rgba(0,0,0,0) 62%, rgba(0,0,0,0.75) 100%); mix-blend-mode: multiply; opacity: 0.08; pointer-events: none; }
        .ferro-overlay--queued   { background-image: url('./app/assets/images/soul-queued.png'); }
        .ferro-overlay--running  { background-image: url('./app/assets/images/soul-running.png'); }
        .ferro-overlay--success  { background-image: url('./app/assets/images/soul-success.png'); }
        .ferro-overlay--error    { background-image: url('./app/assets/images/soul-error.png'); }
        #toolkit-gauge[data-stage="queued"]  .ferro-overlay--queued   { opacity: 1; }
        #toolkit-gauge[data-stage="running"] .ferro-overlay--running  { opacity: 1; }
        #toolkit-gauge[data-stage="success"] .ferro-overlay--success  { opacity: 1; }
        #toolkit-gauge[data-stage="error"]   .ferro-overlay--error    { opacity: 1; }
        /* New: exact PNG sprites mode */
        #ferro-overlay-root { display: none !important; }
        .toolkit-gauge-ferro.soul-sprite-mode .ferro-splash { display: none !important; }
        .soul-sprite-root { position: absolute; top: 50%; left: 50%; width: 168px; height: 168px; transform: translate(-50%, -50%); pointer-events: none; z-index: 4; filter: drop-shadow(0 0 22px rgba(0,0,0,0.55)); will-change: transform, opacity; }
        .soul-sprite-root::after { content: ''; position: absolute; inset: -10%; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.16) 0%, rgba(255,255,255,0.05) 38%, rgba(0,0,0,0.55) 100%); mix-blend-mode: screen; opacity: 0.35; transition: opacity 0.45s ease; pointer-events: none; }
        #toolkit-gauge[data-stage="success"] .soul-sprite-root::after { opacity: 0.55; }
        #toolkit-gauge[data-stage="running"] .soul-sprite-root::after { opacity: 0.45; }
        .soul-sprite { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; opacity: 0; transition: opacity 240ms ease, transform 320ms ease; image-rendering: auto; }
        .soul-sprite.breathe { animation: soulBreath 2.4s ease-in-out infinite; will-change: transform, opacity; }
        @keyframes soulBreath { 0%,100% { transform: scale(0.96); opacity: 0.92; } 50% { transform: scale(1.04); opacity: 1; } }
        #toolkit-gauge[data-stage="queued"]  .soul-sprite--neutral { opacity: 1; }
        #toolkit-gauge[data-stage="running"] .soul-sprite--amber   { opacity: 1; }
        #toolkit-gauge[data-stage="success"] .soul-sprite--green   { opacity: 1; }
        #toolkit-gauge[data-stage="error"]   .soul-sprite--red     { opacity: 1; }
        /* Video center (circularly clipped) */
        .toolkit-gauge-ferro.soul-video-mode .soul-sprite-root { display: none !important; }
        .soul-video-root { position: absolute; top: 50%; left: 50%; width: 168px; height: 168px; transform: translate(-50%, -50%); pointer-events: none; z-index: 4; border-radius: 50%; overflow: hidden; clip-path: circle(50% at 50% 50%); will-change: transform, opacity; background-repeat: no-repeat; background-position: center; background-size: contain; }
        #toolkit-gauge[data-stage="queued"]  .soul-video-root  { background-image: url('./assets/soul/AI Bradaa Soul - Neutral.png'); }
        #toolkit-gauge[data-stage="running"] .soul-video-root  { background-image: url('./assets/soul/AI Bradaa Soul - Amber.png'); }
        #toolkit-gauge[data-stage="success"] .soul-video-root  { background-image: url('./assets/soul/AI Bradaa Soul - Green.png'); }
        #toolkit-gauge[data-stage="error"]   .soul-video-root  { background-image: url('./assets/soul/AI Bradaa Soul - Red.png'); }
        .soul-video { width: 100%; height: 100%; display: block; object-fit: cover; opacity: 0; transition: opacity 220ms ease; filter: url(#soul-luma-key) saturate(1.08) contrast(1.04); background: transparent; will-change: opacity; mix-blend-mode: screen; }
        .soul-video.v1 { opacity: 1; }
        /* Soul hero sizing & layering */
        .toolkit-briefing { position: relative; }
        .toolkit-gauge { transition: height 220ms ease; z-index: 5; }
        .toolkit-layout[data-collapsed="true"] .toolkit-gauge { height: 260px; }
        .toolkit-layout[data-collapsed="false"] .toolkit-gauge { height: 420px; }
        .toolkit-layout[data-collapsed="false"] .soul-video-root { width: 216px; height: 216px; }
        .toolkit-layout[data-collapsed="false"] .soul-sprite-root { width: 216px; height: 216px; }
        /* Minimize control */
        #toolkit-minimize { display: none; margin-left: 0.5rem; }
        .toolkit-layout[data-collapsed="false"] #toolkit-minimize { display: inline-flex; }
        .toolkit-collapsed-summary { display: none; flex-direction: column; gap: 1rem; padding: 1.25rem; border-radius: 1rem; background: rgba(1, 4, 9, 0.7); border: 1px solid rgba(0,240,255,0.14); box-shadow: inset 0 0 24px rgba(0,240,255,0.12); color: var(--c-text-secondary); }
        .toolkit-collapsed-summary h4 { font-family: var(--font-display); font-size: 0.95rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--c-accent-cyan); margin: 0; }
        .toolkit-collapsed-summary ol { margin: 0; padding-left: 1.1rem; display: flex; flex-direction: column; gap: 0.35rem; font-size: 0.9rem; }
        .toolkit-collapsed-summary button { align-self: flex-start; background: linear-gradient(135deg, rgba(0,240,255,0.28), rgba(216,63,135,0.3)); border: 1px solid rgba(0,240,255,0.4); color: #f6fbff; padding: 0.55rem 1.1rem; border-radius: 999px; font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .toolkit-collapsed-summary button:hover { transform: translateY(-1px); box-shadow: 0 0 14px rgba(0,240,255,0.25); }
        .toolkit-layout[data-collapsed="true"] .toolkit-collapsed-summary { display: flex; }
        .toolkit-layout[data-collapsed="true"] .toolkit-insights,
        .toolkit-layout[data-collapsed="true"] .toolkit-pills,
        .toolkit-layout[data-collapsed="true"] .toolkit-live-dropdown,
        .toolkit-layout[data-collapsed="true"] #toolkit-interactive,
        .toolkit-layout[data-collapsed="true"] .toolkit-foot { display: none; }
        .toolkit-layout[data-collapsed="true"] .toolkit-briefing { padding-bottom: 1.5rem; }
        .toolkit-layout[data-collapsed="true"] .toolkit-gauge { margin-bottom: 1rem; }
        /* Collapse: hide entire Deck v2 grid */
        .toolkit-layout[data-collapsed="true"] .toolkit-briefing-body[data-deck-layout="v2"] { display: none; }

        /* Deck modal + backdrop */
        #toolkit .deck-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(2.5px); z-index: 999; display: none; opacity: 0; transition: opacity 140ms ease; will-change: opacity; pointer-events: auto; }
        /* Backdrop-filter fallback (moved from file top) */
        @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
            #toolkit .deck-backdrop { background: rgba(0,0,0,0.7); }
        }
        body[data-deck-open="true"] { overflow: hidden; }
        #toolkit[data-deck-open="true"] .deck-backdrop { display: block; opacity: 1; }
        /* Hide FAB and dock indicator when deck is open to declutter */
        body[data-deck-open="true"] #aipod-fab,
        body[data-deck-open="true"] #aipod-dock-indicator { display: none !important; }
        #toolkit[data-deck-open="true"] {
            position: fixed;
            inset: 0;
            z-index: 1000;
            margin: 0 !important;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(16px, 4vw, 72px);
            pointer-events: none;
            animation: deckAmbientRise 260ms ease-out;
            will-change: transform, opacity;
        }
        #toolkit[data-deck-open="true"].card { background: transparent; border: none; box-shadow: none; backdrop-filter: none; overflow: visible; }
        #toolkit[data-deck-open="true"].card::before { opacity: 0; }
        #toolkit[data-deck-open="true"] .card-content {
            position: relative;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #toolkit[data-deck-open="true"] .toolkit-layout {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(1280px, calc(100vw - clamp(24px, 6vw, 96px)));
            max-height: calc(100vh - clamp(32px, 10vh, 144px));
            z-index: 1002;
            background: rgba(4,8,14,0.97);
            border: 1px solid var(--c-border);
            border-radius: 18px;
            padding: 1.25rem max(1rem, 3vw);
            overflow: auto;
            box-shadow: 0 60px 180px rgba(0, 0, 0, 0.7), 0 0 72px rgba(0,240,255,0.25);
            animation: deckHyper 120ms cubic-bezier(0.2, 0.85, 0.2, 1);
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
            pointer-events: auto;
            will-change: transform, opacity;
            /* Avoid content-visibility to prevent delayed paints/cropping */
            contain: layout paint;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            scrollbar-gutter: stable both-edges;
            scroll-padding: 24px 18px;
        }
        #toolkit[data-deck-open="true"] .toolkit-layout::before,
        #toolkit[data-deck-open="true"] .toolkit-layout::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            pointer-events: none;
            z-index: -1;
        }
        #toolkit[data-deck-open="true"] .toolkit-layout::before {
            background: conic-gradient(from 90deg, rgba(0,240,255,0.75), rgba(216,63,135,0.6), rgba(0,240,255,0.85));
            filter: blur(24px);
            opacity: 0.7;
        }
        #toolkit[data-deck-open="true"] .toolkit-layout::after {
            border: 1px solid rgba(0,240,255,0.5);
            box-shadow: inset 0 0 28px rgba(0,240,255,0.3), inset 0 0 56px rgba(216,63,135,0.25);
            background-image: linear-gradient(90deg, rgba(0,240,255,0), rgba(0,240,255,0.25), rgba(0,240,255,0));
            background-size: 200% 100%;
            background-repeat: no-repeat;
            animation: deckSweep 700ms ease-out 1;
        }
        /* Deck v2 rationalization: sticky header and contained scrolls */
        .deck-response-header { position: sticky; top: 0; z-index: 2; background: rgba(4,8,14,0.92); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,240,255,0.14); }
        .deck-response-body { display: flex; flex-direction: column; max-height: min(60vh, 560px); overflow: hidden; }
        .deck-response-stream { flex: 1 1 auto; overflow: auto; padding-right: 4px; }
        .deck-col-left, .deck-col-right { max-height: min(60vh, 560px); overflow: auto; }
        @media (max-width: 900px) { .deck-col-left, .deck-col-right { max-height: none; overflow: visible; } }
        .deck-holo-grid,
        .deck-holo-noise {
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            opacity: 0;
            transition: opacity 220ms ease;
            z-index: 0;
        }
        .deck-holo-grid { background: linear-gradient(135deg, rgba(0,240,255,0.14) 0%, rgba(216,63,135,0.1) 45%, rgba(0,240,255,0.14) 100%); mix-blend-mode: screen; }
        .deck-holo-grid::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: repeating-linear-gradient(90deg, rgba(0,240,255,0.25) 0, rgba(0,240,255,0.25) 1px, transparent 1px, transparent 14px), repeating-linear-gradient(0deg, rgba(216,63,135,0.22) 0, rgba(216,63,135,0.22) 1px, transparent 1px, transparent 18px);
            opacity: 0.35;
            animation: deckGridDrift 10s linear infinite;
        }
        .deck-holo-noise {
            background: radial-gradient(circle at 20% 20%, rgba(0,240,255,0.18), transparent 55%), radial-gradient(circle at 80% 80%, rgba(216,63,135,0.18), transparent 50%);
            mix-blend-mode: lighten;
            animation: deckNoiseFade 2.4s ease-in-out infinite alternate;
        }
        #toolkit[data-deck-open="true"] .deck-holo-grid,
        #toolkit[data-deck-open="true"] .deck-holo-noise { opacity: 1; }
        #toolkit[data-deck-open="true"] .toolkit-briefing { overflow: visible; z-index: 1; }
        /* Subtle scanlines (cleaner than heavy noise) */
        #toolkit[data-deck-open="true"] .toolkit-briefing::before {
            content: '';
            position: absolute; inset: 0; pointer-events: none; z-index: 0;
            background-image: repeating-linear-gradient(0deg, rgba(255,255,255,0.025) 0, rgba(255,255,255,0.025) 1px, transparent 1px, transparent 6px);
            opacity: 0.28;
        }
        /* Ensure Soul visuals (circle/Kaabah/spikes) are never clipped */
        #toolkit[data-deck-open="true"] .toolkit-gauge { overflow: visible; }
        #toolkit[data-deck-open="true"] #soul-core,
        #toolkit[data-deck-open="true"] #ferro-splash,
        #toolkit[data-deck-open="true"] #ferro-ring { overflow: visible; }
        .ferro-ring, .ferro-splash { overflow: visible; }
        /* Prevent horizontal overflow/cropping by forcing shrink */
        #toolkit[data-deck-open="true"] .toolkit-layout,
        #toolkit[data-deck-open="true"] .toolkit-layout > * { min-width: 0; }
        /* Improve internal grid sizing for full visibility */
        #toolkit[data-deck-open="true"] .toolkit-briefing-body { grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); }
        @media (max-width: 900px) { #toolkit[data-deck-open="true"] .toolkit-briefing-body { grid-template-columns: 1fr; } }
        /* Override for Deck v2 tri-column when modal is open */
        #toolkit[data-deck-open="true"] .toolkit-briefing-body[data-deck-layout="v2"] { grid-template-columns: 280px 1fr 360px; }
        @media (max-width: 1400px) { #toolkit[data-deck-open="true"] .toolkit-briefing-body[data-deck-layout="v2"] { grid-template-columns: 260px 1fr 320px; } }
        @media (max-width: 1100px) { #toolkit[data-deck-open="true"] .toolkit-briefing-body[data-deck-layout="v2"] { grid-template-columns: 1fr; } }
        @keyframes deckSweep { from { background-position: -100% 0; } to { background-position: 100% 0; } }
        @keyframes deckGridDrift {
            from { transform: translate3d(0,0,0); }
            50% { transform: translate3d(-18px,-20px,0); }
            to { transform: translate3d(0,0,0); }
        }
        @keyframes deckNoiseFade {
            from { opacity: 0.25; }
            to { opacity: 0.45; }
        }
        @keyframes deckHyper { 0% { transform: translate3d(-50%, calc(-50% + 12px), 0) scale(0.975); opacity: 0; } 60% { transform: translate3d(-50%, -50%, 0) scale(1.012); opacity: 1; } 100% { transform: translate3d(-50%, -50%, 0) scale(1); } }
        #toolkit[data-deck-open="true"] .toolkit-foot { margin-top: auto; }
        /* Child stagger for a crisper reveal */
        @keyframes deckItemIn { 0% { opacity: 0; transform: translate3d(0,8px,0) scale(0.995); } 100% { opacity: 1; transform: translate3d(0,0,0) scale(1); } }
        #toolkit[data-deck-open="true"] .toolkit-briefing > * { animation: deckItemIn 160ms cubic-bezier(0.2,0.8,0.2,1) both; }
        #toolkit[data-deck-open="true"] .toolkit-briefing > *:nth-child(1) { animation-delay: 20ms; }
        #toolkit[data-deck-open="true"] .toolkit-briefing > *:nth-child(2) { animation-delay: 40ms; }
        #toolkit[data-deck-open="true"] .toolkit-briefing > *:nth-child(3) { animation-delay: 60ms; }
        #toolkit[data-deck-open="true"] .toolkit-briefing > *:nth-child(4) { animation-delay: 80ms; }
        #toolkit[data-deck-open="true"] .toolkit-briefing > *:nth-child(5) { animation-delay: 100ms; }
        @media (max-width: 1400px) {
            #toolkit[data-deck-open="true"] .toolkit-layout {
                width: calc(100vw - clamp(48px, 8vw, 120px));
                max-height: calc(100vh - clamp(56px, 14vh, 200px));
            }
        }
        @media (max-width: 1024px) {
            #toolkit[data-deck-open="true"] .toolkit-layout {
                transform: translate(-50%, -50%) scale(0.985);
                width: calc(100vw - clamp(28px, 6vw, 80px));
                padding: 1.1rem;
            }
        }
        @media (max-width: 768px) {
            #toolkit[data-deck-open="true"] .toolkit-layout {
                top: 0;
                left: 0;
                transform: none;
                width: 100vw;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                padding: clamp(0.8rem, 2.5vw, 1.1rem) clamp(0.6rem, 2vw, 1rem);
            }
            #toolkit[data-deck-open="true"] {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
                align-items: stretch;
                justify-content: stretch;
            }
            #toolkit[data-deck-open="true"] .card-content {
                align-items: stretch;
                justify-content: stretch;
            }
        }
        @supports (height: 100dvh) {
            @media (max-width: 768px) {
                #toolkit[data-deck-open="true"] .toolkit-layout { height: 100dvh; }
                #toolkit[data-deck-open="true"] { height: 100dvh; }
            }
        }
        @media (max-width: 768px) {
            /* Tone down background layers on mobile for perf */
            #toolkit[data-deck-open="true"] .toolkit-layout::before { filter: blur(16px); opacity: 0.5; }
            .deck-holo-grid::after { opacity: 0.25; animation-duration: 12s; }
            .deck-holo-noise { opacity: 0.32; }
        }
        @media (prefers-reduced-motion: reduce) {
            #toolkit .deck-backdrop { transition-duration: 0ms; }
            #toolkit[data-deck-open="true"] { animation: none; }
            #toolkit[data-deck-open="true"] .toolkit-layout { animation: none; }
            .deck-holo-grid::after, .deck-holo-noise { animation: none !important; }
        }
        @media (max-width: 480px) {
            #toolkit[data-deck-open="true"] .toolkit-layout {
                padding: 0.85rem;
            }
        }
        #deck-prototype-badge.deck-proto-badge { display: none; margin-left: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; border: 1px solid rgba(0,240,255,0.35); color: var(--c-accent-cyan); background: rgba(0,240,255,0.08); }
        #toolkit[data-deck-open="true"] #deck-prototype-badge.deck-proto-badge { display: inline-flex; align-items: center; }

        /* Bottom-right FAB with job count */
        #aipod-fab { position: fixed; right: 18px; bottom: 18px; z-index: 1100; background: linear-gradient(135deg, rgba(0,240,255,0.32), rgba(216,63,135,0.3)); border: 1px solid rgba(0,240,255,0.45); color: #e6faff; border-radius: 999px; padding: 0.55rem 0.95rem; display: none; align-items: center; gap: 0.55rem; box-shadow: 0 14px 34px rgba(0,0,0,0.45); font-size: 0.85rem; letter-spacing: 0.05em; text-transform: uppercase; transition: transform 160ms ease, box-shadow 160ms ease; isolation: isolate; --fab-progress: 0; --fab-ring: 0; --fab-color: var(--c-accent-cyan); }
        #aipod-fab .aipod-fab-icon { display: none; }
        #aipod-fab .aipod-fab-count { min-width: 1.4rem; height: 1.4rem; border-radius: 999px; background: rgba(0,240,255,0.22); border: 1px solid rgba(0,240,255,0.45); display: inline-flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 600; color: #0d1420; background-image: linear-gradient(135deg, rgba(0,240,255,0.85), rgba(216,63,135,0.65)); }
        #aipod-fab.show { display: inline-flex; }
        #aipod-fab.show:hover { transform: translateY(-2px); box-shadow: 0 18px 40px rgba(0,240,255,0.25); }
        /* AI Bradaa Branding prototype v1 — mini Soul inside FAB */
        #aipod-fab .aipod-fab-soul { width: 20px; height: 20px; border-radius: 50%; background: center/contain no-repeat url('./assets/soul/AI Bradaa Soul - Amber.png'); box-shadow: 0 0 8px rgba(0,240,255,0.35); flex: 0 0 auto; animation: soulBreathe 2.2s ease-in-out infinite; }
        @keyframes soulBreathe { 0%,100% { transform: scale(0.96); } 50% { transform: scale(1.04); } }
        /* Progress ring around FAB */
        #aipod-fab::before { content: ''; position: absolute; inset: -4px; border-radius: 999px; background: conic-gradient(var(--fab-color) calc(var(--fab-progress, 0)*1turn), rgba(255,255,255,0.12) 0); -webkit-mask: radial-gradient(closest-side, transparent calc(100% - 3px), #000 0); mask: radial-gradient(closest-side, transparent calc(100% - 3px), #000 0); opacity: var(--fab-ring, 0); transition: opacity 160ms ease; z-index: 0; pointer-events: none; }
        #aipod-fab[data-spin="true"]::before { animation: fabPulse 1.2s ease-in-out infinite; }
        @keyframes fabPulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        /* Visible fallback ring stroke so progress is always perceivable */
        #aipod-fab::after { content: ''; position: absolute; inset: -2px; border-radius: 999px; border: 2px solid var(--fab-color); opacity: calc(var(--fab-ring, 0) * 0.35); pointer-events: none; }

        /* FAB popover (multi-requests) */
        #aipod-fab-popover { position: fixed; right: 18px; bottom: 70px; z-index: 1101; width: min(360px, calc(100vw - 24px)); border-radius: 14px; border: 1px solid rgba(0,240,255,0.32); background: rgba(1,4,9,0.86); backdrop-filter: blur(10px); box-shadow: 0 22px 60px rgba(0,0,0,0.5), 0 0 24px rgba(0,240,255,0.18) inset; overflow: hidden; display: none; }
        #aipod-fab-popover[data-open="true"] { display: block; animation: fabPop 120ms cubic-bezier(0.2,0.8,0.2,1); }
        @keyframes fabPop { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fab-popover-header { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid rgba(0,240,255,0.18); background: linear-gradient(180deg, rgba(0,240,255,0.08), rgba(0,240,255,0)); }
        .fab-brand { display: flex; align-items: center; gap: 8px; }
        .fab-brand .brand-text { display: flex; flex-direction: column; line-height: 1; }
        .fab-brand .brand-text .title { font-family: var(--font-display); font-weight: 900; letter-spacing: 0.12em; font-size: 0.8rem; color: var(--c-text-primary); }
        .fab-brand .brand-text .subtitle { font-size: 0.7rem; color: var(--c-text-secondary); }
        .fab-mini-soul { width: 28px; height: 28px; border-radius: 50%; overflow: hidden; position: relative; box-shadow: 0 0 10px rgba(0,240,255,0.45); background: center/contain no-repeat url('./assets/soul/AI Bradaa Soul - Amber.png'); animation: soulSpin 4s linear infinite; }
        @keyframes soulSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fab-popover-list { max-height: 280px; overflow-y: auto; padding: 6px; display: grid; gap: 6px; }
        .fab-row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; background: rgba(0,240,255,0.06); border: 1px solid rgba(0,240,255,0.14); cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .fab-row:hover { background: rgba(0,240,255,0.1); transform: translateY(-1px); }
        .fab-row .meta { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .fab-row .meta .task { font-size: 0.85rem; color: var(--c-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fab-row .meta .time { font-size: 0.72rem; color: var(--c-text-secondary); }
        .fab-row .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,240,255,0.3); color: var(--c-accent-cyan); background: rgba(0,240,255,0.08); }

        /* Minimize flight ghost (deck -> FAB) */
        .dock-flight-ghost { position: fixed; width: 42px; height: 42px; border-radius: 50%; background: center/contain no-repeat url('./assets/soul/AI Bradaa Soul - Amber.png'); box-shadow: 0 0 18px rgba(0,240,255,0.45); z-index: 1200; pointer-events: none; opacity: 0; }
        .dock-flight-ghost[data-flying="true"] { animation: dockFlight 320ms cubic-bezier(0.2,0.85,0.2,1) forwards; }
        @keyframes dockFlight { 0% { opacity: 0; transform: translate3d(0,0,0) scale(0.9); } 20% { opacity: 1; } 100% { opacity: 0; transform: translate3d(var(--tx, 0), var(--ty, 0), 0) scale(0.6); } }

        /* Bottom-left working indicator */
        #aipod-dock-indicator { position: fixed; left: 18px; bottom: 18px; z-index: 1100; width: 48px; height: 48px; border-radius: 50%; display: none; place-items: center; background: radial-gradient(circle at 50% 50%, rgba(216,63,135,0.45), rgba(0,240,255,0.12)); box-shadow: 0 0 38px rgba(216,63,135,0.45), 0 0 28px rgba(0,240,255,0.24) inset; }
        #aipod-dock-indicator.show { display: grid; animation: dockReveal 0.35s ease-out forwards, dockPulse 1.6s ease-in-out infinite 0.35s; }
        #aipod-dock-indicator::after { content: ''; width: 18px; height: 18px; border-radius: 50%; background: radial-gradient(circle at 50% 50%, #fff, #D83F87 60%); filter: blur(0.3px); box-shadow: 0 0 18px rgba(216,63,135,0.65); }
        @keyframes dockPulse { 0% { transform: scale(1); opacity: 0.9 } 50% { transform: scale(1.08); opacity: 1 } 100% { transform: scale(1); opacity: 0.9 } }
        @keyframes dockReveal { 0% { transform: translate(-16px, 12px) scale(0.85); opacity: 0; } 80% { opacity: 1; } 100% { transform: translate(0,0) scale(1); opacity: 1; } }
        @keyframes deckPop { 0% { transform: translateY(12px) scale(0.98); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes deckAmbientRise { 0% { opacity: 0; transform: scale(0.995); } 100% { opacity: 1; transform: scale(1); } }
        /* Specular sheen highlights */
        .ferro-splash .sheen { stroke: rgba(255,255,255,0.7); stroke-width: 1.2; stroke-linecap: round; fill: none; filter: blur(1.2px); mix-blend-mode: screen; opacity: 0.75; }
        .ferro-ring { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; filter: drop-shadow(0 0 12px var(--ferro-glow, rgba(0,240,255,0.35))); }
        .ferro-ring .spike { stroke: rgba(255,255,255,0.85); stroke-linecap: round; filter: drop-shadow(0 0 6px var(--ferro-glow, rgba(0,240,255,0.45))); }
        .ferro-ring .spike-core { stroke: var(--ferro-glow, rgba(0,240,255,0.8)); }
        @keyframes ferro-breathe { 0% { transform: scale(0.96) translateY(1px); } 50% { transform: scale(1.05) translateY(-4px); } 100% { transform: scale(0.96) translateY(1px); } }
        @keyframes ferro-pulse { 0% { transform: scale(0.94) translate(-2px,1px); } 40% { transform: scale(1.04) translate(1px,-2px); } 70% { transform: scale(1.02) translate(-1px,-1px); } 100% { transform: scale(0.94) translate(-2px,1px); } }
        @keyframes ferro-orbit { 0% { transform: translate(0,0) scale(1); opacity: 0.85; } 50% { transform: translate(-8px,6px) scale(1.08); opacity: 1; } 100% { transform: translate(0,0) scale(1); opacity: 0.85; } }
        @keyframes ferro-drift { 0% { transform: translate(0,0) scale(1); opacity: 0.85; } 45% { transform: translate(6px,-4px) scale(0.92); opacity: 0.75; } 100% { transform: translate(0,0) scale(1); opacity: 0.85; } }
        @keyframes ferro-highlight { 0%,100% { opacity: 0.4; transform: scale(0.95); } 50% { opacity: 0.75; transform: scale(1.05); } }
        @keyframes ferro-glow { 0% { box-shadow: inset 0 0 16px var(--ferro-glow, rgba(0,240,255,0.25)), 0 0 18px var(--ferro-glow, rgba(0,240,255,0.25)); } 50% { box-shadow: inset 0 0 36px var(--ferro-glow, rgba(0,240,255,0.45)), 0 0 42px var(--ferro-glow, rgba(0,240,255,0.45)); } 100% { box-shadow: inset 0 0 16px var(--ferro-glow, rgba(0,240,255,0.25)), 0 0 18px var(--ferro-glow, rgba(0,240,255,0.25)); } }

        /* Stage colors (AI Pod live status) - Venom neon core */
        #toolkit-gauge[data-stage="queued"]  { --ferro-glow: rgba(230,0,128,0.95); --ferro-splash-base: rgba(255, 64, 214, 0.9); --ferro-splash-rim: rgba(255, 196, 238, 0.95); --ferro-droplet-base: rgba(255, 122, 232, 0.88); }
        #toolkit-gauge[data-stage="running"] { --ferro-glow: rgba(255,171,64,0.95); --ferro-splash-base: rgba(255, 180, 92, 0.9); --ferro-splash-rim: rgba(255, 226, 166, 0.94); --ferro-droplet-base: rgba(255, 205, 128, 0.9); }
        #toolkit-gauge[data-stage="success"] { --ferro-glow: rgba(51,255,153,0.95); --ferro-splash-base: rgba(52, 232, 165, 0.88); --ferro-splash-rim: rgba(178, 255, 215, 0.94); --ferro-droplet-base: rgba(118, 255, 207, 0.88); }
        #toolkit-gauge[data-stage="error"]   { --ferro-glow: rgba(255,64,64,0.95); --ferro-splash-base: rgba(255, 88, 88, 0.9); --ferro-splash-rim: rgba(255, 204, 204, 0.92); --ferro-droplet-base: rgba(255, 130, 130, 0.88); }
        .toolkit-briefing-body { display: grid; gap: clamp(1.5rem, 2vw, 2rem); grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); align-items: start; }
        @media (min-width: 1280px) { .toolkit-briefing-body { grid-template-columns: minmax(460px, 560px) minmax(420px, 1fr); } }
        .toolkit-insights ul { line-height: 1.7; max-width: 62ch; }
        .toolkit-insights { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); position: relative; }
        .toolkit-insights ul { margin: 0; padding-left: 1.1rem; font-size: 0.95rem; color: var(--c-text-secondary); }
        .toolkit-insights li { margin-bottom: 0.4rem; }
        .toolkit-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; position: relative; }
        .toolkit-pill { padding: 0.5rem 0.95rem; border-radius: 999px; border: 1px solid rgba(0,240,255,0.25); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--c-text-secondary); background: rgba(0,240,255,0.06); }
        .toolkit-pill--active { background: rgba(0,240,255,0.22); border-color: rgba(216,63,135,0.45); color: #f8f8f8; box-shadow: 0 0 14px rgba(0,240,255,0.35); }
        .toolkit-foot { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--c-text-secondary); position: relative; flex-wrap: wrap; gap: 0.75rem; }
        .toolkit-live-dropdown { position: relative; border-radius: 1rem; overflow: hidden; border: 1px solid rgba(0,240,255,0.16); background: rgba(0,0,0,0.4); transition: max-height 0.45s ease, opacity 0.3s ease; max-height: 0; opacity: 0; }
        .toolkit-live-dropdown[aria-hidden="false"] { max-height: 220px; opacity: 1; }
        .toolkit-live-dropdown header { display: flex; justify-content: space-between; align-items: center; padding: 0.85rem 1.1rem; font-size: 0.9rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--c-text-secondary); background: rgba(0,240,255,0.08); }
        .toolkit-live-log { padding: 0.95rem 1.1rem 1.2rem; font-size: 0.92rem; line-height: 1.6; color: var(--c-text-secondary); }
        .toolkit-live-log strong { color: var(--c-accent-cyan); }
        .toolkit-live-log p { margin: 0 0 0.6rem; }
        .toolkit-live-log p:last-child { margin-bottom: 0; }
        .console-animating { animation: console-slide 0.35s ease; }
        @keyframes console-slide { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toolkit-live-dropdown--active header { background: linear-gradient(90deg, rgba(0,240,255,0.25), rgba(216,63,135,0.25)); color: #f8f8f8; }
        /* Top Picks (Explorer) */
        #top-picks { display: grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap: 1rem; }
        @media (min-width: 768px) { #top-picks { grid-template-columns: repeat(3, minmax(0,1fr)); } }
        .top-pick-card { border: 1px solid var(--c-border); background: rgba(0,0,0,0.35); border-radius: 12px; padding: 1rem; display:flex; flex-direction:column; gap:.5rem; }
        .top-pick-rank { font-family: var(--font-display); font-size: .8rem; letter-spacing: .12em; text-transform: uppercase; color: var(--c-accent-cyan); }
        .top-pick-title { font-weight: 700; color: var(--c-text-primary); }
        .top-pick-meta { font-size:.8rem; color: var(--c-text-secondary); display:flex; gap:.75rem; flex-wrap:wrap; }
        .top-pick-actions { margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap; }
        .top-pick-actions .action-button { padding: .4rem .7rem; font-size: .75rem; }
        /* Deck v2 tri-column grid */
        .toolkit-briefing-body[data-deck-layout="v2"] { grid-template-columns: 280px 1fr 360px; align-items: start; }
        @media (max-width: 1400px) { .toolkit-briefing-body[data-deck-layout="v2"] { grid-template-columns: 260px 1fr 320px; } }
        @media (max-width: 1100px) { .toolkit-briefing-body[data-deck-layout="v2"] { grid-template-columns: 1fr; } }
        .deck-col { display: flex; flex-direction: column; gap: 1rem; }
        .deck-card { background: rgba(0,0,0,0.35); border: 1px solid rgba(0,240,255,0.16); border-radius: 14px; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .deck-card > h4 { font-family: var(--font-display); font-size: 0.95rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--c-accent-cyan); margin: 0; }
        .deck-card .deck-card-body { display: block; }
        .deck-card .tool-selector-btn { border-radius: 10px; }
        .deck-card--response { position: relative; padding: 1.2rem 1.35rem; gap: 1.25rem; background: linear-gradient(140deg, rgba(7, 26, 54, 0.78), rgba(14, 12, 48, 0.6)); border: 1px solid rgba(0,240,255,0.24); box-shadow: 0 18px 48px rgba(4, 15, 28, 0.65); }
        .deck-response-header { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 1rem; align-items: center; }
        .deck-response-identity { display: flex; gap: 0.85rem; align-items: center; }
        .deck-response-avatar { width: 46px; height: 46px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(0,240,255,0.9), rgba(216,63,135,0.55)); box-shadow: 0 0 22px rgba(0,240,255,0.35); position: relative; }
        .deck-response-avatar::after { content: ""; position: absolute; inset: 6px; border-radius: 50%; background: rgba(0,0,0,0.4); }
        .deck-response-label { font-size: 0.9rem; letter-spacing: 0.14em; text-transform: uppercase; color: rgba(255,255,255,0.88); margin: 0; }
        .deck-response-subline { margin: 0.2rem 0 0; font-size: 0.78rem; letter-spacing: 0.06em; color: rgba(193,211,234,0.75); text-transform: uppercase; }
        .deck-response-subline span { color: var(--c-accent-cyan); }
        .deck-response-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .deck-chip { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.45rem 0.85rem; border-radius: 999px; border: 1px solid rgba(0,240,255,0.35); font-size: 0.7rem; letter-spacing: 0.14em; text-transform: uppercase; color: rgba(216, 239, 255, 0.82); background: rgba(0,240,255,0.08); transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
        .deck-chip--status { background: rgba(216,63,135,0.15); border-color: rgba(216,63,135,0.45); color: rgba(255, 223, 238, 0.85); min-width: 160px; justify-content: center; }
        .deck-chip--lang { background: rgba(0,240,255,0.12); }
        .deck-response-body { position: relative; }
        .deck-response-stream { position: relative; padding: 1rem; border-radius: 14px; background: rgba(1, 7, 21, 0.65); border: 1px solid rgba(0,240,255,0.12); max-height: 420px; overflow-y: auto; box-shadow: inset 0 0 24px rgba(0,0,0,0.35); }
        .deck-response-output { color: rgba(216, 235, 255, 0.9); font-size: 0.95rem; line-height: 1.65; display: grid; gap: 0.85rem; }
        .deck-response-output[data-empty="true"] { color: rgba(216, 239, 255, 0.52); }
        .deck-response-output pre { background: rgba(0,0,0,0.55); border: 1px solid rgba(0,240,255,0.12); padding: 0.85rem; border-radius: 10px; font-size: 0.85rem; overflow-x: auto; }
        .deck-response-output p { margin: 0; }
        .deck-response-placeholder { font-size: 0.88rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .deck-response-footer { font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(150, 178, 205, 0.7); margin: 0; }
        .deck-card--response[data-state="processing"] .deck-chip--status { background: rgba(255, 171, 64, 0.18); border-color: rgba(255, 171, 64, 0.45); color: rgba(255,236,214,0.9); }
        .deck-card--response[data-state="processing"] .deck-response-avatar { box-shadow: 0 0 26px rgba(255,171,64,0.42); }
        .deck-card--response[data-state="complete"] .deck-chip--status { background: rgba(51,255,153,0.2); border-color: rgba(51,255,153,0.45); color: rgba(210,255,232,0.92); }
        .deck-card--response[data-state="complete"] .deck-response-avatar { box-shadow: 0 0 26px rgba(51,255,153,0.42); }
        .deck-card--response[data-state="error"] .deck-chip--status { background: rgba(255,64,64,0.18); border-color: rgba(255,64,64,0.45); color: rgba(255,220,220,0.92); }
        .deck-card--response[data-state="error"] .deck-response-avatar { box-shadow: 0 0 26px rgba(255,64,64,0.42); }
        .deck-card--response[data-state="processing"] .deck-response-stream::after {
            content: "Processing";
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 0.65rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: rgba(255, 214, 164, 0.6);
        }
        .deck-card--response[data-state="error"] .deck-response-stream::after {
            content: "Check systems";
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 0.65rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: rgba(255, 160, 160, 0.7);
        }
        .deck-card--response[data-state="complete"] .deck-response-stream::after {
            content: "Mission complete";
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 0.65rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: rgba(173, 255, 214, 0.7);
        }
        @media (max-width: 600px) {
            .deck-response-header { flex-direction: column; align-items: flex-start; }
            .deck-response-avatar { width: 40px; height: 40px; }
            .deck-response-stream { max-height: none; }
        }
        .psyche-column { display: flex; flex-direction: column; gap: 1.5rem; }
        .psyche-grid { display: grid; gap: 1.2rem; }
        @media (min-width: 768px) { .psyche-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        .psyche-card { border-radius: 1rem; border: 1px solid rgba(0,240,255,0.14); background: rgba(0,0,0,0.38); padding: 1.1rem 1.25rem; box-shadow: 0 12px 32px rgba(0,8,24,0.4); }
        .psyche-card h4 { font-size: 0.78rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--c-accent-cyan); margin: 0 0 0.8rem; }
        .psyche-card ul { margin: 0; padding-left: 1.1rem; display: grid; gap: 0.5rem; }
        .psyche-card ul li { color: var(--c-text-secondary); font-size: 0.9rem; }
        .psyche-card .toolkit-pills { margin: 0; }
        .psyche-card .toolkit-pills .toolkit-pill { display: inline-flex; justify-content: center; min-width: 0; }
        #toolkit-interactive { background: rgba(1, 4, 9, 0.74); border: 1px solid rgba(0,240,255,0.16); border-radius: 1.25rem; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; backdrop-filter: blur(6px); }
        #toolkit-tool-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; max-height: none; overflow: visible; }
        #toolkit-tool-list .tool-selector-btn { width: 100%; text-align: left; font-size: 0.85rem; letter-spacing: 0.06em; padding: 0.85rem 1rem; border-radius: 0.85rem; border: 1px solid rgba(0,240,255,0.14); background: rgba(0,240,255,0.08); color: var(--c-text-secondary); transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease; }
        #toolkit-tool-list .tool-selector-btn:hover { transform: translateY(-2px); border-color: rgba(216,63,135,0.4); background: rgba(0,240,255,0.14); }
        #toolkit-tool-list .tool-selector-btn.active { border-color: rgba(216,63,135,0.55); background: linear-gradient(135deg, rgba(0,240,255,0.2), rgba(216,63,135,0.25)); color: #f8f8f8; box-shadow: 0 0 16px rgba(0,240,255,0.25); }
        #toolkit-console { flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; padding: 1.25rem; border-radius: 1rem; background: rgba(0, 0, 0, 0.55); border: 1px solid rgba(0,240,255,0.2); min-height: 280px; color: var(--c-text-secondary); }
        #toolkit-console > div:first-child { display: flex; flex-direction: column; gap: 0.85rem; }
        #toolkit-console input, #toolkit-console select, #toolkit-console textarea { background: rgba(0, 240, 255, 0.08); border: 1px solid rgba(0,240,255,0.18); border-radius: 0.65rem; padding: 0.65rem 0.85rem; color: #f1f5ff; }
        #toolkit-console textarea { min-height: 140px; resize: vertical; }
        #toolkit-console label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--c-text-secondary); }
        #toolkit-console .action-button { align-self: flex-start; }
        /* Live button states */
        .action-button[data-live="running"], .tool-selector-btn[data-live="running"] { position: relative; box-shadow: 0 0 0 0 rgba(255,214,92,0.45); animation: live-pulse 1.1s ease-out infinite; }
        .action-button[data-live="success"], .tool-selector-btn[data-live="success"] { box-shadow: 0 0 20px rgba(22,255,160,0.45); }
        .action-button[data-live="error"], .tool-selector-btn[data-live="error"] { box-shadow: 0 0 22px rgba(255,77,77,0.55); }
        @keyframes live-pulse { 0% { box-shadow: 0 0 0 0 rgba(255,214,92,0.55); } 70% { box-shadow: 0 0 0 12px rgba(255,214,92,0); } 100% { box-shadow: 0 0 0 0 rgba(255,214,92,0); } }
        #toolkit-output { flex-grow: 1; display: flex; align-items: flex-start; }
    </style>
</head>
<body class="p-4 md:p-8">
    <a class="sr-only focus:not-sr-only" href="#main">Skip to main</a>

    <div class="max-w-7xl mx-auto">
        <header class="text-center py-8" id="top">
            <h1 class="font-display text-4xl md:text-6xl font-black">AI BRADAA</h1>
            <p class="text-lg text-[var(--c-text-secondary)] mt-2">Powered by Kaa-Ching!</p>
        </header>

        <nav class="nav-sticky py-3 mb-12" aria-label="Primary">
            <div class="flex flex-wrap justify-center gap-4 md:gap-6 text-sm" role="tablist">
                <button type="button" class="nav-button active px-1 py-2 font-semibold" data-target="#matchmaker" role="tab" aria-controls="matchmaker">Matchmaker</button>
                <button type="button" class="nav-button px-1 py-2 font-semibold" data-target="#comparison" role="tab" aria-controls="comparison">Versus</button>
                <button type="button" class="nav-button px-1 py-2 font-semibold" data-target="#explorer" role="tab" aria-controls="explorer">Explorer</button>
                <button type="button" class="nav-button px-1 py-2 font-semibold" data-target="#toolkit" role="tab" aria-controls="toolkit">Ops Command</button>
                <button type="button" class="nav-button px-1 py-2 font-semibold" data-target="#intelligence" role="tab" aria-controls="intelligence">Intel</button>
                <button type="button" class="nav-button px-1 py-2 font-semibold" data-target="#appendices" role="tab" aria-controls="appendices">Appendices</button>
                <button type="button" class="nav-button px-1 py-2 font-semibold" data-target="#camera" role="tab" aria-controls="camera">Camera Tech</button>
            </div>
        </nav>

        <main id="main" class="space-y-16">
            <section id="matchmaker" class="card" data-section="matchmaker">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">AI Laptop Matchmaker</h2>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            <p class="text-[var(--c-text-secondary)]">Yo. I'm AI Bradaa. Stop guessing. Provide your parameters, and I'll give you the optimal choice. Let's execute.</p>
                            <div><label class="block mb-2">1. Your Budget (MYR)</label><select id="match-budget" class="w-full"><option>Under RM4,500</option><option selected>RM4,500 - RM7,000</option><option>No Budget (Concierge)</option></select></div>
                            <div><label class="block mb-2">2. Primary Use Case</label><select id="match-usecase" class="w-full"><option>AI/ML & Coding</option><option>Creative Work (Video/3D)</option><option>Gaming & Everyday Use</option></select></div>
                            <div><label class="block mb-2">3. Portability Need</label><select id="match-portability" class="w-full"><option>Mostly at a desk</option><option>Always on the move</option><option>A mix of both</option></select></div>
                            <button id="find-match-btn" class="w-full action-button">✨ Find My Match</button>
                        </div>
                        <div id="matchmaker-output" data-ai-proto="v1" class="p-4 bg-[var(--c-bg)] rounded-lg min-h-[250px] text-[var(--c-text-secondary)] gemini-output">Your AI recommendation will appear here...</div>
                    </div>
                </div>
            </section>

            <section id="comparison" class="card" data-section="comparison">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Head-to-Head Comparison</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-4">Select 2 or 3 units for a tactical breakdown. AI Bradaa will generate an automated strategic analysis.</p>
                    <div class="max-h-48 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-2 mb-6 p-2 bg-[var(--c-bg)] rounded-lg" id="laptop-selector-container">Loading Intel...</div>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                         <div style="position: relative; height:450px;"><canvas id="radarChart"></canvas></div>
                         <div id="gemini-comparison-output" data-ai-proto="v1" class="p-4 bg-[var(--c-bg)] rounded-lg min-h-[300px] text-sm text-[var(--c-text-secondary)] gemini-output">Select laptops to begin analysis...</div>
                    </div>
                </div>
            </section>

            <section id="explorer" class="card" data-section="explorer">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Interactive Market Explorer</h2>
                    <div id="filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-[var(--c-bg)] rounded-lg">
                        <div><label class="font-semibold text-sm mb-2 block">Price Range (≤ RM<span id="price-value">7000</span>)</label><input type="range" id="price-filter" min="3500" max="7000" value="7000" step="100" class="w-full"></div>
                        <div><label class="font-semibold text-sm mb-2 block">Platform</label><div class="flex gap-2"><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md active" data-platform="All">All</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="CUDA">CUDA</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="NPU">NPU</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="Mac">Mac</button></div></div>
                        <div><label class="font-semibold text-sm mb-2 block">Brand</label><select id="brand-filter" class="w-full"><option value="All" selected>All Brands</option></select></div>
                        <div><label class="font-semibold text-sm mb-2 block">Sort By</label><select id="sort-filter" class="w-full"><option value="score_desc">Score (High-Low)</option><option value="price_asc">Price (Low-High)</option><option value="price_desc">Price (High-Low)</option><option value="value_desc" selected>Value Rating (Score-to-Price Ratio)</option></select></div>
                    </div>
                    <div id="usecase-picker" class="mb-4">
                      <label class="font-semibold text-sm mb-2 block">Use Case</label>
                      <div class="flex flex-wrap gap-2">
                        <button class="filter-button segment-filter active border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="All">All</button>
                        <button class="filter-button segment-filter border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="AI">AI Feature</button>
                        <button class="filter-button segment-filter border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="Gaming">Gaming</button>
                        <button class="filter-button segment-filter border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="Creator">Creator</button>
                        <button class="filter-button segment-filter border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="Portable">Portable</button>
                        <button class="filter-button segment-filter border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="Business">Business</button>
                        <button class="filter-button segment-filter border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-seg="Student">Student</button>
                      </div>
                    </div>
                    <div id="top-picks" aria-live="polite"></div>
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div style="position: relative; height:500px;"><canvas id="rankingsChart"></canvas></div>
                        <div style="position: relative; height:500px;"><canvas id="valueChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="toolkit" class="card" data-toolkit data-section="toolkit">
                <div class="card-content" data-role="aipod-tools">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">AI Bradaa Advance Toolkit</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-6">AI Bradaa reporting in — cepat kerja, clean results. Pilih satu tool, biar aku jalan. Senang cerita, kita settle elok-elok.</p>
                    <div class="deck-backdrop" id="deck-backdrop" aria-hidden="true"></div>
                    <div class="toolkit-layout" data-collapsed="true" tabindex="-1">
                        <div class="deck-holo-grid" aria-hidden="true"></div>
                        <div class="deck-holo-noise" aria-hidden="true"></div>
                        <div class="toolkit-briefing" aria-labelledby="toolkit-briefing-title" aria-describedby="toolkit-live-meta">
                            <!-- Soul hero on top -->
                            <div class="toolkit-gauge" id="toolkit-gauge" role="figure" aria-live="polite" aria-label="AI Bradaa live status">
                                <div class="toolkit-gauge-ferro soul-sprite-mode" aria-hidden="true">
                                    <div id="soul-video-root" class="soul-video-root" aria-hidden="true">
                                        <video id="soul-video-1" class="soul-video v1" data-src="/app/assets/soul/AI Bradaa Animation 1.mp4" preload="none" muted playsinline></video>
                                        <video id="soul-video-2" class="soul-video v2" data-src="/app/assets/soul/AI Bradaa Animation 2.mp4" preload="none" muted playsinline></video>
                                    </div>
                                    <div id="soul-sprite-root" class="soul-sprite-root" aria-hidden="true">
                                        <img class="soul-sprite soul-sprite--red"     src="/app/assets/soul/AI Bradaa Soul - Red.png" alt="" loading="lazy" decoding="async">
                                        <img class="soul-sprite soul-sprite--amber"   src="/app/assets/soul/AI Bradaa Soul - Amber.png" alt="" loading="lazy" decoding="async">
                                        <img class="soul-sprite soul-sprite--green"   src="/app/assets/soul/AI Bradaa Soul - Green.png" alt="" loading="lazy" decoding="async">
                                    </div>
                                    <svg class="ferro-core-glow" id="soul-core" viewBox="0 0 200 200" aria-hidden="true">
                                        <circle cx="100" cy="100" r="32" />
                                    </svg>
                                    <svg class="ferro-splash" id="ferro-splash" viewBox="0 0 200 200" aria-hidden="true">
                                        <path id="ferro-splash-main" class="splash-main" d="" />
                                        <g id="ferro-splash-droplets"></g>
                                    </svg>
                                </div>
                                <svg class="ferro-ring" id="ferro-ring" viewBox="-60 -60 360 360" aria-hidden="true"></svg>
                            </div>
                            <div class="toolkit-briefing-header">
                                <div>
                                    <p id="toolkit-briefing-badge" class="text-xs uppercase tracking-[0.18em] text-[var(--c-text-secondary)] mb-1">AI Bradaa Optimal</p>
                                    <h3 id="toolkit-briefing-title">AI Bradaa Ops Feed</h3>
                                    <p id="toolkit-briefing-subtitle" class="text-sm text-[var(--c-text-secondary)] mt-1">Command decisions synced to Malaysia-first telemetry.</p>
                                    <span id="deck-prototype-badge" class="deck-proto-badge" aria-label="Deck AI Pod prototype v1">Deck AI Pod prototype v1</span>
                                </div>
                                <div class="toolkit-status">
                                    <span id="toolkit-status-health">System Health: Optimal</span>
                                    <span id="toolkit-status-latency">Latency: 85&nbsp;ms</span>
                                    <span id="toolkit-status-mode" data-status="live">Mode: Autonomous</span>
                                    <button type="button" id="toolkit-minimize" class="action-button" title="Minimize">Minimize</button>
                                </div>
                            </div>
                            <div class="toolkit-collapsed-summary" id="toolkit-summary">
                                <div>
                                    <h4>Summary Preview</h4>
                                    <ol>
                                        <li><strong>AI Bradaa:</strong> <span id="toolkit-summary-soul">Primed</span></li>
                                        <li><strong>Deck:</strong> <span id="toolkit-summary-deck">Choose a tool to begin.</span></li>
                                    </ol>
                                </div>
                                <button type="button" id="toolkit-summary-expand">Launch full deck</button>
                            </div>
                            <div class="toolkit-briefing-body" data-deck-layout="v2">
                                <div class="deck-col deck-col-left">
                                    <div class="deck-card">
                                        <h4>Tool Stack</h4>
                                        <div class="deck-card-body flex flex-col gap-2 max-h-[360px] overflow-y-auto" id="toolkit-tool-list">
                                            <button class="tool-selector-btn active" data-tool="deal-assassin" data-action="deal-assassin">Deal Assassin</button>
                                            <button class="tool-selector-btn" data-tool="upgrade-strategist" data-action="upgrade-strategist">Upgrade Strategist</button>
                                            <button class="tool-selector-btn" data-tool="dream-rig-architect" data-action="dream-rig-architect">Dream Rig Architect</button>
                                            <button class="tool-selector-btn" data-tool="elite-procurement" data-action="elite-procurement">Elite Procurement</button>
                                            <button class="tool-selector-btn" data-tool="component-recon" data-action="component-recon">Component Recon</button>
                                            <button class="tool-selector-btn" data-tool="performance-forecaster" data-action="performance-forecaster">Performance Forecaster</button>
                                            <button class="tool-selector-btn" data-tool="system-integrity" data-action="system-integrity">System Integrity Analysis</button>
                                            <button class="tool-selector-btn" data-tool="ecosystem-architect" data-action="ecosystem-architect">Ecosystem Architect</button>
                                            <button class="tool-selector-btn" data-tool="longevity-analyst" data-action="longevity-analyst">Longevity Analyst</button>
                                            <button class="tool-selector-btn" data-tool="asset-value" data-action="asset-value">Asset Value Forecaster</button>
                                            <button class="tool-selector-btn" data-tool="field-support" data-action="field-support">Field Support</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="deck-col deck-col-center">
                                    <div class="deck-card deck-card--response" id="deck-response-card" data-state="idle">
                                        <header class="deck-response-header">
                                            <div class="deck-response-identity">
                                                <span class="deck-response-avatar" aria-hidden="true"></span>
                                                <div class="deck-response-meta">
                                                    <p class="deck-response-label">AI Bradaa</p>
                                                    <p class="deck-response-subline">Malaysia-first operator • Soul stage: <span id="deck-response-stage">IDLE</span></p>
                                                    <p class="deck-response-subline deck-response-subline--bm">Operator berpacak di Malaysia • Tahap jiwa: <span data-i18n="bm-stage" id="deck-response-stage-bm">IDLE</span></p>
                                                </div>
                                            </div>
                                            <div class="deck-response-tags">
                                                <span class="deck-chip deck-chip--status" id="deck-response-chip" aria-live="polite">Standing by</span>
                                                <span class="deck-chip deck-chip--lang">BM/EN parity</span>
                                                <span class="deck-chip deck-chip--clock" id="deck-response-clock">00:00:00</span>
                                            </div>
                                        </header>
                                        <div class="deck-response-body">
                                            <div class="deck-response-stream" data-role="response-stream">
                                                <div class="deck-response-history" id="deck-response-history" aria-live="polite" aria-label="AI Bradaa live transcript"></div>
                                                <div id="toolkit-console" data-ai-proto="v1" class="deck-response-output gemini-output" data-empty="true" data-role="response-output">
                                                    <p class="deck-response-placeholder">Select a tool to begin operations.</p>
                                                    <p class="deck-response-placeholder">Pilih alatan untuk memulakan operasi.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <footer class="deck-response-footer">
                                            <p>Telemetry logged to AI POD • Guardrails: PDPA consent &amp; AI Guardrails v2</p>
                                        </footer>
                                    </div>
                                </div>
                                <div class="deck-col deck-col-right">
                                    <div class="deck-card">
                                        <h4>Live Fetch</h4>
                                        <div class="toolkit-live-dropdown" id="toolkit-live-dropdown" aria-hidden="true" aria-live="polite">
                                            <header>
                                                <span id="toolkit-live-label">Live fetch</span>
                                                <span id="toolkit-live-meta">Standing by…</span>
                                            </header>
                                            <div class="toolkit-live-log" id="toolkit-live-log">
                                                <p data-line="0">Awaiting next mission command.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="deck-card">
                                        <h4>Ops Feed</h4>
                                        <ul id="toolkit-insights-list">
                                            <li>Ops Command Deck cleared 96% incident loads within SLA.</li>
                                            <li>Growth Studio pipeline scored 4.2x projected GMV uplift.</li>
                                            <li>Regulatory guardrails verified (PDPA, AI Guardrails v2).</li>
                                            <li>Monetisation pilot ready for Q4 Malaysia-first rollout.</li>
                                        </ul>
                                    </div>
                                    <div class="deck-card">
                                        <h4>Signals</h4>
                                        <div class="toolkit-pills" id="toolkit-pills" aria-label="Toolkit signals">
                                            <span class="toolkit-pill" data-signal="ops">Ops Command Deck</span>
                                            <span class="toolkit-pill" data-signal="growth">Growth Studio</span>
                                            <span class="toolkit-pill" data-signal="web">Web Pulse △ On</span>
                                            <span class="toolkit-pill" data-signal="lang">BM/EN</span>
                                            <span class="toolkit-pill" data-signal="db">Local DB Sync</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="toolkit-foot">
                                <span>as of 09/10/2025, 16:59 MYT • Source mesh: Local DB, Web Pulse, Field Telemetry</span>
                                <span>Powered by AI Bradaa — Malaysia Intelligence • Data Privacy &amp; Export</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

             <section id="intelligence" class="card" data-section="intelligence">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Latest Tech Intel</h2>
                    <div data-role="intel-cards">
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-0-title" class="font-display text-lg text-[var(--c-accent-pink)]">Acquiring Intel...</h3>
                            <p id="intel-0-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-0-verdict" class="text-[var(--c-accent-pink)]">STANDBY</span></p>
                        </div>
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-1-title" class="font-display text-lg text-[var(--c-accent-cyan)]">Acquiring Intel...</h3>
                            <p id="intel-1-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-1-verdict" class="text-[var(--c-accent-cyan)]">STANDBY</span></p>
                        </div>
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-2-title" class="font-display text-lg text-[var(--c-text-secondary)]">Acquiring Intel...</h3>
                            <p id="intel-2-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-2-verdict" class="text-[var(--c-text-secondary)]">STANDBY</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="appendices" class="card" data-section="appendices">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Appendices: Full Laptop Database</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-4 text-center">This list is updated automatically by the filters in the <a href="#explorer" class="underline text-[var(--c-accent-cyan)]">Explorer</a> section.</p>
                    <p id="appendix-dataset-meta" class="text-xs text-[var(--c-text-secondary)] mb-4 text-center" aria-live="polite"></p>
                    <div id="laptop-list-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 max-h-[80vh] overflow-y-auto p-2">
                        <p class="text-center xl:col-span-3">Loading market data...</p>
                    </div>
                </div>
            </section>
            <section id="camera" class="card" data-section="camera">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Camera Tech Division</h2>
                    <div class="ai-pod-response">
                        <div class="ai-pod-response__header">
                            <span class="ai-pod-response__title">Coming soon</span>
                            <time class="ai-pod-response__time" id="camera-ts"></time>
                        </div>
                        <div class="ai-pod-response__body">
                            We are preparing a Malaysia‑first camera division: lenses, bodies, and AI workflows. Stay tuned.
                        </div>
                    </div>
                </div>
            </section>

            
        </main>
        <button id="aipod-fab" aria-label="AI Bradaa background tasks" title="AI Bradaa background tasks" class="hidden">
          <span class="aipod-fab-soul" aria-hidden="true"></span>
          <span class="aipod-fab-count" id="aipod-fab-count">0</span>
        </button>
        <div id="aipod-fab-popover" role="dialog" aria-label="AI Bradaa background tasks" aria-hidden="true">
          <div class="fab-popover-header">
            <div class="fab-brand">
              <div class="fab-mini-soul" aria-hidden="true"></div>
              <div class="brand-text">
                <span class="title">AI BRADAA</span>
                <span class="subtitle">Powered by Kaa-Ching!</span>
              </div>
            </div>
            <button id="aipod-fab-close" class="action-button" style="margin-left:auto;padding:0.35rem 0.7rem;">Close</button>
          </div>
          <div class="fab-popover-list" id="aipod-fab-list" aria-live="polite"></div>
        </div>
        <div id="aipod-dock-indicator" aria-hidden="true" title="AI Bradaa is working"></div>
    </div>

<script>
/* ==========================================================================
   AI Bradaa Strategic Command — v15.2 (Architect Edition)
   Code refactored for clarity, performance, and robustness.
   All AI features are live and persona-aligned.
   ========================================================================== */
(() => {
  'use strict';

  // --- STATE & CONSTANTS ----------------------------------------------------
  // Centralized state object. The single source of truth for the application's data.
  const STATE = {
    data: {
      allLaptops: [],
      rankedSource: {
        top10: [],
        shortlist35: [],
        appendix65: [],
        fallback65: []
      },
      sortedByRank: [],
      datasetMeta: { generatedAt: null, source: 'fallback', count: null },
      imageCache: {},
      imagePending: new Set(),
      aiBriefCache: {},
      aiTaskCache: {},
      fallbackLaptops: []
    },
    config: {
      chartFont: { family: "'Share Tech Mono', monospace", size: 12 },
      platformColors: { CUDA: 'text-[#00F0FF]', NPU: 'text-[#D83F87]', Mac: 'text-gray-400' },
      platformColorMap: { CUDA: 'rgba(0, 240, 255, 0.7)', NPU: 'rgba(216, 63, 135, 0.7)', Mac: 'rgba(168, 178, 204, 0.7)' },
      priceMin: 3500,
      priceMax: 7000,
      aiRetryPolicy: { attempts: 2, baseDelay: 900 },
      aiCacheLimit: 40
    },
    affiliate: {
      SHOPEE_AFFILIATE_ID: self.SHOPEE_AFFILIATE_ID || null,
      LAZADA_AFFILIATE_ID: self.LAZADA_AFFILIATE_ID || null,
      TIKTOK_AFFILIATE_ID: self.TIKTOK_AFFILIATE_ID || null,
      INVOLVE_ASIA_ID: self.INVOLVE_ASIA_ID || null
    },
    ui: {
      toolkit: {
        profileKey: 'deal-assassin',
        lastStage: 'queued',
        collapsed: false,
        deckOpen: false,
        lastFocus: null,
        jobSerial: 0,
        jobs: [],
        progress: 0,
        fabLingerUntil: 0
      },
      app: {
        price: 7000,
        platform: 'All',
        brand: 'All',
        sort: 'value_desc',
        segment: 'All',
        radarSelection: [],
        missionPicks: [],
        missionPickReady: false,
        interacted: false,
        activeFilters: {
          missionPick: 'all',
          platform: 'all',
          price: 'all',
          brand: 'All'
        },
        snapshots: {
          missionPick: [],
          appendix: []
        }
      },
      charts: {}
    }
  };

  const TOOLKIT_PROFILES = Object.freeze({
    'deal-assassin': {
      displayName: 'Deal Assassin',
      gauge: 72,
      health: 'System Health: Optimal',
      mode: 'Mode: Autonomous',
      latencyRange: [65, 95],
      badge: 'Ops Command Mesh',
      insights: [
        'Ops Command Deck cleared 96% incident loads within SLA.',
        'Growth Studio pipeline scored 4.2x projected GMV uplift.',
        'Field Recon HUD achieved 88% compliance photo capture.'
      ],
      pills: ['ops', 'growth', 'web'],
      logs: {
        queued: [
          'Ops Command Deck priming procurement scanners.',
          'Growth Studio watching competitor bids.'
        ],
        running: [
          'Web Pulse recalibrating marketplace telemetry.',
          'Safety Council checking PDPA guardrails.'
        ],
        success: duration => [`Deal verdict streamed in ${duration} ms.`, 'Mesh ready for next directive.']
      }
    },
    'upgrade-strategist': {
      displayName: 'Upgrade Strategist',
      gauge: 78,
      health: 'System Health: Optimal',
      mode: 'Mode: Advisory',
      latencyRange: [70, 105],
      badge: 'Growth Studio Sync',
      insights: [
        'Growth Studio pipeline scored 4.2x projected GMV uplift.',
        'Upgrade paths modelled for 3 core personas.',
        'Ops Command Deck validated SLA impact of upgrade.'
      ],
      pills: ['growth', 'ops', 'lang'],
      logs: {
        queued: [
          'Growth Studio re-ranking upgrade cadences.',
          'Ops Command Deck mapping SLA variance.'
        ],
        running: [
          'Deck AI mentors consulted: Strategy, Platform.',
          'Localization council checking BM/EN copy.'
        ],
        success: duration => [`Upgrade pathway emitted in ${duration} ms.`, 'Evidence pack cached to Growth Studio.']
      }
    },
    'dream-rig-architect': {
      displayName: 'Dream Rig Architect',
      gauge: 83,
      health: 'System Health: Elevated',
      mode: 'Mode: Creative Build',
      latencyRange: [80, 120],
      badge: 'Creative Ops Mesh',
      insights: [
        'Dream rig blueprint synced with Ops Command Deck.',
        'Component supply chain validated via Field Recon.',
        'Growth Studio forecasting launch impact.'
      ],
      pills: ['ops', 'field', 'web'],
      logs: {
        queued: [
          'Field Recon HUD gathering kiosk telemetry.',
          'Ops Command Deck staging bill-of-materials.'
        ],
        running: [
          'Creative council calibrating theming tokens.',
          'Platform council testing sandbox constraints.'
        ],
        success: duration => [`Blueprint render finished in ${duration} ms.`, 'Rig artefact pushed to Deck AI library.']
      }
    },
    'performance-forecaster': {
      displayName: 'Performance Forecaster',
      gauge: 76,
      health: 'System Health: Stable',
      mode: 'Mode: Decision Support',
      latencyRange: [55, 90],
      badge: 'Ops Decision Stack',
      insights: [
        'Scenario modelling validated against incident backlog.',
        'Thermal profile overlay generated for field engineers.',
        'Compliance thresholds confirmed (AI Guardrails v2).'
      ],
      pills: ['ops', 'field', 'db'],
      logs: {
        queued: [
          'Ops Command Deck staging workload projections.',
          'Field Recon HUD syncing thermal scans.'
        ],
        running: [
          'Strategy council balancing mentor recommendations.',
          'Safety council monitoring guardrail adherence.'
        ],
        success: duration => [`Forecast delivered in ${duration} ms.`, 'Telemetry archived for audit.']
      }
    },
    'component-recon': {
      displayName: 'Component Recon',
      gauge: 69,
      health: 'System Health: Optimal',
      mode: 'Mode: Recon Sweep',
      latencyRange: [60, 100],
      badge: 'Recon Scanner',
      insights: [
        'Field Recon HUD achieved 88% compliance photo capture.',
        'Component batches tagged with lifecycle metadata.',
        'Ops Command Deck synced vendor reliability watchlist.'
      ],
      pills: ['field', 'ops', 'web'],
      logs: {
        queued: [
          'Field Recon HUD scanning shelves for variance.',
          'Ops Command Deck triangulating supplier feeds.'
        ],
        running: [
          'Safety council cross-checking compliance artifacts.',
          'Localization ops translating recon notes (BM/EN).'
        ],
        success: duration => [`Recon brief posted in ${duration} ms.`, 'Alerts escalated to Ops Control.']
      }
    },
    'elite-procurement': {
      displayName: 'Elite Procurement',
      gauge: 77,
      health: 'System Health: Optimal',
      mode: 'Mode: Vendor Ops',
      latencyRange: [75, 115],
      badge: 'Procurement Radar',
      insights: [
        'Ops Command Deck prioritised vendor queue with risk scores.',
        'Growth Studio highlighted high-conversion bundles for launch.',
        'Safety Council confirmed import compliance packets.'
      ],
      pills: ['ops', 'growth', 'web'],
      logs: {
        queued: [
          'Ops Command Deck dispatching supplier scouts.',
          'Growth Studio monitoring bid windows.'
        ],
        running: [
          'Finance/IR council validating margin impact.',
          'Safety council vetting PDPA disclosures.'
        ],
        success: duration => [`Procurement sweep resolved in ${duration} ms.`, 'Preferred supplier shortlist issued.']
      }
    },
    'system-integrity': {
      displayName: 'System Integrity Analysis',
      gauge: 71,
      health: 'System Health: Watch',
      mode: 'Mode: Incident Ops',
      latencyRange: [65, 105],
      badge: 'Incident Command',
      insights: [
        'Ops Command Deck triaged incident backlog within SLA.',
        'Safety Council cleared remediation checklist.',
        'Field Recon HUD captured on-site diagnostics.'
      ],
      pills: ['ops', 'field', 'lang'],
      logs: {
        queued: [
          'Ops Command Deck flagging affected nodes.',
          'Safety council reviewing containment runbooks.'
        ],
        running: [
          'Incident mentors synthesising mitigation playbook.',
          'Localization ops prepping BM/EN status copy.'
        ],
        success: duration => [`Remediation steps issued in ${duration} ms.`, 'Incident archive updated for audit.']
      }
    },
    'ecosystem-architect': {
      displayName: 'Ecosystem Architect',
      gauge: 80,
      health: 'System Health: Optimal',
      mode: 'Mode: Experience Mesh',
      latencyRange: [70, 110],
      badge: 'Experience Synapse',
      insights: [
        'Growth Studio orchestrated cross-device handoffs.',
        'Ops Command Deck mapped partner integrations.',
        'Localization council ensured BM/EN parity.'
      ],
      pills: ['growth', 'lang', 'web'],
      logs: {
        queued: [
          'Growth Studio aligning funnel telemetry.',
          'Ops Command Deck syncing API contracts.'
        ],
        running: [
          'Strategy council validating persona journeys.',
          'Safety council checking consent receipts.'
        ],
        success: duration => [`Ecosystem plan shipped in ${duration} ms.`, 'Partner checklist dispatched to councils.']
      }
    },
    'longevity-analyst': {
      displayName: 'Longevity Analyst',
      gauge: 68,
      health: 'System Health: Stable',
      mode: 'Mode: Lifecycle Ops',
      latencyRange: [60, 95],
      badge: 'Lifecycle Monitor',
      insights: [
        'Ops Command Deck refreshed maintenance cadence.',
        'Field Recon HUD tagged wear indicators.',
        'Data Governance archived lifecycle metrics.'
      ],
      pills: ['ops', 'field', 'db'],
      logs: {
        queued: [
          'Field Recon HUD collecting field telemetry.',
          'Ops Command Deck staging lifecycle dashboards.'
        ],
        running: [
          'Platform council evaluating warranty scenarios.',
          'Safety council confirming retention policy.'
        ],
        success: duration => [`Lifecycle brief returned in ${duration} ms.`, 'Maintenance runway extended for stakeholders.']
      }
    },
    'asset-value': {
      displayName: 'Asset Value Forecaster',
      gauge: 70,
      health: 'System Health: Optimal',
      mode: 'Mode: Finance Intel',
      latencyRange: [65, 100],
      badge: 'Finance Ops Lens',
      insights: [
        'Growth Studio benchmarked resale elasticity.',
        'Ops Command Deck reconciled refurbishment pipeline.',
        'Finance council aligned valuation rubric.'
      ],
      pills: ['growth', 'ops', 'db'],
      logs: {
        queued: [
          'Finance council ingesting transaction comps.',
          'Ops Command Deck cross-checking asset registry.'
        ],
        running: [
          'Strategy council evaluating capital recovery.',
          'Localization ops preparing BM/EN offer copy.'
        ],
        success: duration => [`Valuation note compiled in ${duration} ms.`, 'Offer guidance synced to Growth Studio.']
      }
    },
    'field-support': {
      displayName: 'Field Support',
      gauge: 74,
      health: 'System Health: Support Ready',
      mode: 'Mode: Live Assist',
      latencyRange: [60, 110],
      badge: 'On-Ground Assist',
      insights: [
        'Field Recon HUD dispatched assist beacons.',
        'Ops Command Deck rerouted escalation path.',
        'Safety Council verified compliance responses.'
      ],
      pills: ['field', 'ops', 'lang'],
      logs: {
        queued: [
          'Field Recon HUD opening live channel.',
          'Ops Command Deck alerting duty engineer.'
        ],
        running: [
          'Safety council guarding privacy controls.',
          'Localization ops drafting BM/EN responses.'
        ],
        success: duration => [`Support script returned in ${duration} ms.`, 'Incident playbook linked to duty roster.']
      }
    }
  });

  const DEFAULT_TOOLKIT_PROFILE = Object.freeze({
    displayName: 'Ops Feed',
    gauge: 72,
    health: 'System Health: Optimal',
    mode: 'Mode: Autonomous',
    latencyRange: [70, 90],
    badge: 'AI Bradaa Optimal',
    insights: [
      'Ops Command Deck cleared 96% incident loads within SLA.',
      'Growth Studio pipeline scored 4.2x projected GMV uplift.',
      'Regulatory guardrails verified (PDPA, AI Guardrails v2).'
    ],
    pills: ['ops', 'growth', 'web', 'lang', 'db'],
    logs: {
      queued: ['Mesh preparing unified overlay.', 'Awaiting signal from AI Bradaa provider…'],
      running: ['Deck AI mentors synchronizing.', 'Councils monitoring telemetry.'],
      success: duration => [`Response streamed in ${duration} ms.`, 'Toolkit ready for new command.'],
      error: message => [`⚠️ ${message}`]
    }
  });

  // --- API & DATA MODULE ----------------------------------------------------
  const API_MODULE = {
    renderAIResponseProto(container, content) {
        if (!container) return;
        const tz = 'Asia/Kuala_Lumpur';
        const when = new Date().toLocaleString('en-MY', { timeZone: tz, hour12: false });
        const body = String(content ?? '');
        if (container.dataset && container.dataset.aiProto === 'v1') {
            container.innerHTML = `
              <div class="ai-pod-response">
                <div class="ai-pod-response__header">
                  <span class="ai-pod-response__title">AI Pod response prototype v1</span>
                  <time class="ai-pod-response__time">${when} MYT</time>
                </div>
                <div class="ai-pod-response__body">${body}</div>
              </div>
            `;
        } else {
            container.innerHTML = body;
        }
    },
    guessSegments(laptop) {
        const tags = new Set();
        const p = String(laptop.platform || '').toUpperCase();
        const cpu = String(laptop.cpu || '').toLowerCase();
        const gpu = String(laptop.gpu || '').toLowerCase();
        const disp = String(laptop.display || '').toLowerCase();
        const why = String(laptop.why || '').toLowerCase();
        if (p === 'NPU' || cpu.includes('ultra') || cpu.includes('npu')) tags.add('AI');
        if (p === 'CUDA' || /rtx\s?(40|50)\d{2}/i.test(gpu)) tags.add('Gaming');
        if (disp.includes('oled') || disp.includes('qhd') || disp.includes('3k') || disp.includes('creator') || why.includes('creator')) tags.add('Creator');
        if (/air|gram|slim|thin|blade 14|g14|xps 13/i.test(laptop.model || '')) tags.add('Portable');
        if (/pro|business|thinkpad|elitebook|surface/i.test(laptop.model || '') || why.includes('business')) tags.add('Business');
        if (/vivobook|ideapad|inspiron|pavilion|swift/i.test(laptop.model || '')) tags.add('Student');
        if (!tags.size) tags.add('Gaming');
        return Array.from(tags);
    },
    getSegments(laptop) {
        if (!laptop) return [];
        if (!Array.isArray(laptop.segments) || !laptop.segments.length) laptop.segments = API_MODULE.guessSegments(laptop);
        return laptop.segments;
    },
    hasSegment(laptop, seg) {
        if (!seg || seg === 'All') return true;
        return API_MODULE.getSegments(laptop).includes(seg);
    },
    stripFences(text) {
        return String(text ?? '').replace(/^```(?:json)?\s*/i, '').replace(/```\s*$/i, '');
    },
    normalizeLaptop(item) {
        if (!item) return null;
        const toNumber = (value, fallback = 0) => {
            const num = Number(value);
            return Number.isFinite(num) ? num : fallback;
        };
        const toPrice = (value, fallback = 0) => {
            if (typeof value === 'string') {
                const digits = value.replace(/[^0-9.]/g, '');
                if (digits) {
                    const parsed = Number(digits);
                    if (Number.isFinite(parsed)) return parsed;
                }
            }
            if (typeof value === 'number') return Number.isFinite(value) ? value : fallback;
            return toNumber(value, fallback);
        };
        const ensureText = (value, fallback = 'Pending intel') => {
            if (typeof value === 'string' && value.trim()) return value.trim();
            return fallback;
        };
        const scoresSource = item.scores || item.score_breakdown || item.metrics || {};
        const scores = {
            ai: toNumber(scoresSource.ai ?? scoresSource.AI ?? item.ai, 0),
            thermals: toNumber(scoresSource.thermals ?? scoresSource.cooling ?? item.thermals, 0),
            upgrade: toNumber(scoresSource.upgrade ?? scoresSource.upgradability ?? item.upgrade, 0),
            linux: toNumber(scoresSource.linux ?? scoresSource.compatibility ?? item.linux, 0),
            portability: toNumber(scoresSource.portability ?? scoresSource.mobility ?? item.portability, 0),
            value: toNumber(scoresSource.value ?? scoresSource.score_value ?? item.value, 0)
        };
        const modelName = ensureText(item.model ?? item.name ?? 'Unknown Model');
        let scoreVal = toNumber(item.score ?? item.overall ?? item.rating, 0);
        if (!scoreVal) {
            const rankVal = toNumber(item.rank ?? item.ranking, 0);
            if (rankVal) scoreVal = Math.max(36, 100 - (rankVal - 1));
        }
        // Normalize score to 0..100 if various scales are detected
        if (scoreVal > 0 && scoreVal <= 1) scoreVal = Math.round(scoreVal * 100);
        else if (scoreVal > 1 && scoreVal <= 10) scoreVal = Math.round(scoreVal * 10);
        const DEFAULT_IMG = 'data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22 viewBox=%220 0 600 400%22%3E%3Crect width=%22600%22 height=%22400%22 fill=%22%231a1a1a%22/%3E%3Ctext x=%22300%22 y=%22205%22 fill=%22%234a4a4a%22 font-family=%22Arial%2CHelvetica%2Csans-serif%22 font-size=%2220%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E';
        const candidateImg = (item.imageUrl ?? item.image_url ?? item.image ?? '').trim();
        const safeImg = candidateImg && !/placehold\.co|placeholder/i.test(candidateImg) ? candidateImg : DEFAULT_IMG;
        return {
            brand: ensureText(item.brand ?? item.maker ?? item.vendor ?? 'Unknown'),
            model: modelName,
            price: toPrice(item.price ?? item.price_myr ?? item.priceMYR ?? item.priceMY ?? item.cost, 0),
            imageUrl: safeImg,
            cpu: ensureText(item.cpu ?? item.specs?.cpu ?? 'TBD'),
            gpu: ensureText(item.gpu ?? item.specs?.gpu ?? 'TBD'),
            ram: ensureText(item.ram ?? item.specs?.ram ?? 'TBD'),
            storage: ensureText(item.storage ?? item.specs?.storage ?? 'TBD'),
            display: ensureText(item.display ?? item.specs?.display ?? 'TBD'),
            price_source_url: item.price_source_url ?? item.links?.product ?? '#',
            shopee_url: item.shopee_url ?? item.links?.shopee ?? item.links?.alt ?? null,
            tiktok_url: item.tiktok_url ?? item.links?.tiktok ?? null,
            lazada_url: item.lazada_url ?? item.links?.lazada ?? null,
            best_deal_url: item.best_deal_url ?? item.links?.best ?? item.links?.cheapest ?? null,
            score: scoreVal,
            platform: ensureText((item.platform ?? item.segment ?? 'NPU').toUpperCase()),
            why: ensureText(item.why ?? item.summary ?? item.pitch ?? 'Strategic intel pending.'),
            scores,
            // Value rating: higher is better. Scale by 1000 so ranges are readable.
            value_rating: (scoreVal && toNumber(item.price ?? item.price_myr ?? item.priceMYR ?? item.priceMY ?? item.cost, 0))
              ? Number((scoreVal / Math.max(1, toPrice(item.price ?? item.price_myr ?? item.priceMYR ?? item.priceMY ?? item.cost, 1) / 1000)).toFixed(4))
              : 0
        };
    },
    buildAffiliateLink(originalUrl, platform) {
        if (!originalUrl) return '#';
        const { SHOPEE_AFFILIATE_ID, LAZADA_AFFILIATE_ID, TIKTOK_AFFILIATE_ID } = STATE.affiliate;
        const appendParam = (url, key, value) => {
            if (!value) return url;
            const [base, hash] = url.split('#');
            const sep = base.includes('?') ? '&' : '?';
            const rebuilt = `${base}${sep}${key}=${encodeURIComponent(value)}`;
            return hash ? `${rebuilt}#${hash}` : rebuilt;
        };
        switch (platform) {
            case 'shopee':
                return appendParam(originalUrl, 'af_id', SHOPEE_AFFILIATE_ID);
            case 'lazada':
                return appendParam(originalUrl, 'aff_id', LAZADA_AFFILIATE_ID);
            case 'tiktok':
                return appendParam(originalUrl, 'aff_ext', TIKTOK_AFFILIATE_ID);
            default:
                return originalUrl;
        }
    },
    bestDealUrl(laptop) {
      const ordered = [laptop.best_deal_url, laptop.lazada_url, laptop.shopee_url, laptop.tiktok_url, laptop.price_source_url]
          .filter(href => typeof href === 'string' && href.trim().length);
      return ordered[0] || '#';
    },
    getUseCaseWeights(seg) {
        const key = String(seg || 'All');
        const pod = window.AI_POD?.weights?.usecase || {};
        const raw = pod[key] || {};
        const fallback = this.defaultUseCaseWeights(key);
        const merged = { ...fallback, ...raw };
        // normalize to sum=1
        const sum = Object.values(merged).reduce((a,b) => a + Number(b || 0), 0) || 1;
        for (const k of Object.keys(merged)) merged[k] = Number(merged[k] || 0) / sum;
        return merged;
    },
    defaultUseCaseWeights(seg) {
        const base = { score: 0.4, value: 0.25, rel: 0.15, ai: 0.1, thermals: 0.07, portability: 0.03 };
        switch (seg) {
            case 'AI': return { score: 0.3, value: 0.2, rel: 0.1, ai: 0.28, thermals: 0.08, portability: 0.04 };
            case 'Gaming': return { score: 0.38, value: 0.18, rel: 0.1, ai: 0.06, thermals: 0.22, portability: 0.06 };
            case 'Creator': return { score: 0.34, value: 0.2, rel: 0.12, ai: 0.14, thermals: 0.14, portability: 0.06 };
            case 'Portable': return { score: 0.26, value: 0.22, rel: 0.12, ai: 0.12, thermals: 0.08, portability: 0.2 };
            case 'Business': return { score: 0.3, value: 0.28, rel: 0.18, ai: 0.06, thermals: 0.08, portability: 0.1 };
            case 'Student': return { score: 0.28, value: 0.34, rel: 0.12, ai: 0.06, thermals: 0.08, portability: 0.12 };
            default: return base;
        }
    },
    sanitizeForOutput(text) {
        return String(text ?? '').replace(/</g, '&lt;');
    },
    stableStringify(value) {
        const seen = new WeakSet();
        const normalize = input => {
            if (input === null || typeof input !== 'object') return input;
            if (seen.has(input)) return null;
            seen.add(input);
            if (Array.isArray(input)) return input.map(normalize);
            return Object.keys(input).sort().reduce((acc, key) => {
                acc[key] = normalize(input[key]);
                return acc;
            }, {});
        };
        try { return JSON.stringify(normalize(value)); } catch { return ''; }
    },
    getAITaskCacheKey(task, payload) {
        if (!task) return '';
        const serialized = this.stableStringify(payload ?? {});
        return `${task}:${serialized}`;
    },
    readAITaskCache(key) {
        if (!key) return null;
        const cache = STATE.data.aiTaskCache;
        if (!cache) return null;
        const entry = cache[key];
        if (!entry || typeof entry.value === 'undefined') return null;
        return entry;
    },
    writeAITaskCache(key, value) {
        if (!key) return;
        if (!STATE.data.aiTaskCache) STATE.data.aiTaskCache = {};
        STATE.data.aiTaskCache[key] = { value, ts: Date.now() };
        this.pruneAITaskCache();
    },
    pruneAITaskCache() {
        const cache = STATE.data.aiTaskCache || {};
        const limit = Math.max(1, Number(STATE.config.aiCacheLimit) || 1);
        const keys = Object.keys(cache);
        if (keys.length <= limit) return;
        const sorted = keys.sort((a, b) => (cache[a].ts || 0) - (cache[b].ts || 0));
        while (sorted.length > limit) {
            const key = sorted.shift();
            if (key) delete cache[key];
        }
    },
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, Math.max(0, Number(ms) || 0)));
    },
    collectPriceLinks(laptop) {
        const entries = [];
        const push = (href, label, platform) => {
            if (!href) return;
            const clean = href.trim();
            if (!clean) return;
            const linked = API_MODULE.buildAffiliateLink(clean, platform);
            if (entries.some(item => item.href === linked)) return;
            entries.push({ href: linked, label });
        };
        push(laptop.price_source_url, 'Official Website', 'official');
        push(laptop.shopee_url, 'Shopee', 'shopee');
        push(laptop.tiktok_url, 'TikTok Shop', 'tiktok');
        push(laptop.lazada_url, 'Lazada', 'lazada');
        const best = API_MODULE.bestDealUrl(laptop);
        push(best, 'Best Deal (Auto)', 'best');
        return entries;
    },
    renderPriceMenu(laptop, index) {
        const entries = API_MODULE.collectPriceLinks(laptop);
        const menuItems = entries.length
            ? entries.map(entry => `<a href="${entry.href}" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-xs text-[var(--c-text-secondary)] hover:bg-[var(--c-border)]">${entry.label}</a>`).join('')
            : '<span class="block px-4 py-2 text-xs text-[var(--c-text-secondary)]">No live listings</span>';
        return `
            <div class="relative mt-3">
                <button data-action="toggle-price-menu" data-index="${index}" class="w-full text-center bg-[var(--c-accent-cyan)] text-[var(--c-bg)] text-xs font-bold py-2 px-3 rounded-md hover:opacity-90 transition flex items-center justify-center">
                    Check Price
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="price-menu-${index}" class="price-menu hidden absolute bottom-full mb-2 w-full bg-[var(--c-bg)] border border-[var(--c-border)] rounded-md shadow-lg z-10 overflow-hidden">
                    ${menuItems}
                </div>
            </div>
        `;
    },
    async getSmartImage(laptop) {
        const cacheKey = `${laptop.brand}|${laptop.model}`;
        const cached = STATE.data.imageCache[cacheKey];
        if (cached) return cached;
        if (STATE.data.imagePending.has(cacheKey)) {
            return { url: laptop.imageUrl, source: 'pending' };
        }

        const provider = window.AI_POD?.provider;
        const details = {
            brand: laptop.brand,
            model: laptop.model,
            price: laptop.price,
            cpu: laptop.cpu,
            gpu: laptop.gpu
        };

        // Prefer canonical dataset image if it isn't a placeholder.
        const canonical = laptop.imageUrl;
        const isPlaceholder = canonical.includes('placehold.co');
        if (!isPlaceholder) {
            STATE.data.imageCache[cacheKey] = { url: canonical, source: 'dataset' };
            return STATE.data.imageCache[cacheKey];
        }

        // Feature gate: AI image lookup (opt-in to avoid API floods)
        const aiImagesEnabled = (() => { try { return localStorage.getItem('AIPOD_IMG') === '1'; } catch { return false; } })();
        if (!aiImagesEnabled) {
            STATE.data.imageCache[cacheKey] = { url: canonical, source: 'fallback' };
            return STATE.data.imageCache[cacheKey];
        }

        if (!provider) {
            return { url: canonical, source: 'fallback' };
        }

        try {
            STATE.data.imagePending.add(cacheKey);
            const prompt = {
                task: 'intel:image_lookup',
                system: 'You are AI Bradaa image scout. Only reply with JSON {"url":"https://...","source":"human readable attribution"}.',
                user: `Find the official or latest product photo for this laptop model, Malaysia-friendly. If unavailable, return a high-confidence stock image URL. Laptop: ${JSON.stringify(details)}`
            };
            const response = await provider.call(
                prompt.task,
                prompt.system,
                prompt.user,
                { responseMimeType: 'application/json' },
                { timeout: 8000, meta: { track: false, silent: true, scope: 'image', label: 'image_lookup' } }
            );
            const data = response?.data ?? response;
            const parsed = typeof data === 'string' ? JSON.parse(data) : data;
            const aiUrl = typeof parsed?.url === 'string' ? parsed.url.trim() : '';
            const aiSource = typeof parsed?.source === 'string' ? parsed.source.trim() : '';
            if (aiUrl.startsWith('http')) {
                STATE.data.imageCache[cacheKey] = { url: aiUrl, source: aiSource || 'AI Bradaa image scout' };
                STATE.data.imagePending.delete(cacheKey);
                return STATE.data.imageCache[cacheKey];
            }
        } catch (error) {
            console.warn('[AI POD] image lookup fallback:', error?.message ?? error);
        } finally {
            STATE.data.imagePending.delete(cacheKey);
        }
        STATE.data.imageCache[cacheKey] = { url: canonical, source: 'fallback' };
        return STATE.data.imageCache[cacheKey];
    },
    async fetchMarketIntel() {
        const fetchJson = async (path, label) => {
            try {
                const res = await fetch(path, { cache: 'no-store' });
                if (!res.ok) throw new Error(`http_${res.status}`);
                return await res.json();
            } catch (error) {
                console.warn('[AI POD] dataset load failed:', label ?? path, error?.message ?? error);
                return null;
            }
        };

        const toItems = (payload) => {
            if (!payload) return [];
            if (Array.isArray(payload.items)) return payload.items;
            if (Array.isArray(payload.data)) return payload.data;
            if (Array.isArray(payload.laptops)) return payload.laptops;
            if (Array.isArray(payload)) return payload;
            return [];
        };

        const [primaryRaw, fallbackRaw, schemaInfo] = await Promise.all([
            fetchJson('/data/laptops.json', 'laptops.json'),
            fetchJson('/data/fallbackLaptops.json', 'fallbackLaptops.json'),
            fetchJson('/data/laptops.schema.json', 'laptops.schema.json')
        ]);

        const primaryItems = toItems(primaryRaw);
        const fallbackItems = toItems(fallbackRaw);

        const normalizeList = (list) => (Array.isArray(list) ? list : []).map(API_MODULE.normalizeLaptop).filter(Boolean);
        const primaryNormalized = normalizeList(primaryItems);
        const fallbackNormalized = normalizeList(fallbackItems);

        if (fallbackNormalized.length) {
            STATE.data.fallbackLaptops = fallbackNormalized;
        }

        const sortByScore = (list) => [...list].sort((a, b) => (Number(b?.score) || 0) - (Number(a?.score) || 0));
        const dedupe = (list) => {
            const out = [];
            const seen = new Set();
            for (const item of list) {
                if (!item) continue;
                const key = `${String(item.brand || '').trim().toLowerCase()}|${String(item.model || '').trim().toLowerCase()}`;
                if (seen.has(key)) continue;
                seen.add(key);
                out.push(item);
            }
            return out;
        };

        const rankedPrimary = dedupe(sortByScore(primaryNormalized));
        const rankedFallback = dedupe(sortByScore(fallbackNormalized));
        const useFallbackOnly = rankedPrimary.length === 0 && rankedFallback.length > 0;
        const activeDataset = useFallbackOnly ? rankedFallback : rankedPrimary;

        STATE.data.rankedSource.top10 = activeDataset.slice(0, 10);
        STATE.data.rankedSource.shortlist35 = activeDataset.slice(0, 35);
        STATE.data.rankedSource.appendix65 = activeDataset.slice(0, 65);
        STATE.data.rankedSource.fallback65 = rankedFallback.slice(0, 65);

        const composeBaseline = () => {
            const baselineSeed = dedupe([
                ...STATE.data.rankedSource.shortlist35,
                ...STATE.data.rankedSource.appendix65
            ]);
            if (baselineSeed.length < 35 && STATE.data.rankedSource.fallback65.length) {
                const out = [...baselineSeed];
                const seen = new Set(out.map(item => `${String(item.brand || '').trim().toLowerCase()}|${String(item.model || '').trim().toLowerCase()}`));
                for (const fb of STATE.data.rankedSource.fallback65) {
                    const key = `${String(fb.brand || '').trim().toLowerCase()}|${String(fb.model || '').trim().toLowerCase()}`;
                    if (seen.has(key)) continue;
                    seen.add(key);
                    out.push(fb);
                    if (out.length >= 35) break;
                }
                return out;
            }
            return baselineSeed;
        };

        const baseline = composeBaseline();

        if (!baseline.length) {
            if (fallbackNormalized.length) {
                STATE.data.allLaptops = fallbackNormalized;
                STATE.data.datasetMeta = {
                    generatedAt: new Date().toISOString(),
                    source: 'fallbackLaptops.json',
                    count: fallbackNormalized.length
                };
                return;
            }
            STATE.data.allLaptops = [];
            STATE.data.datasetMeta = { generatedAt: null, source: 'unavailable', count: 0 };
            return;
        }

        STATE.data.allLaptops = baseline;

        const timestampPool = useFallbackOnly ? fallbackItems : primaryItems;
        const timestampCandidates = (Array.isArray(timestampPool) ? timestampPool : [])
            .map(item => item?.generated_at_myt || item?.generated_at || item?.price_checked_at_myt || null)
            .map(ts => {
                if (!ts) return null;
                const parsed = Date.parse(ts);
                return Number.isFinite(parsed) ? parsed : null;
            })
            .filter(Boolean);
        const latestTs = timestampCandidates.length
            ? new Date(Math.max(...timestampCandidates)).toISOString()
            : new Date().toISOString();
        const sourceLabel = useFallbackOnly ? 'fallbackLaptops.json' : 'laptops.json';
        const schemaVersion = (schemaInfo && typeof schemaInfo === 'object' && 'schema_version' in schemaInfo)
            ? schemaInfo.schema_version
            : undefined;

        STATE.data.datasetMeta = {
            generatedAt: latestTs,
            source: sourceLabel,
            count: baseline.length,
            ...(schemaVersion ? { schemaVersion } : {})
        };
    },
    async callAIAgent(task, payload, outputElement) {
        const liveDropdown = document.getElementById('toolkit-live-dropdown');
        const liveLabel = document.getElementById('toolkit-live-label');
        const liveMeta = document.getElementById('toolkit-live-meta');
        const liveLog = document.getElementById('toolkit-live-log');
        const startTime = new Date();
        if (outputElement) outputElement.innerHTML = '<span class="animate-pulse">AI Bradaa is thinking...</span>';
        const scope = outputElement?.id === 'matchmaker-output' ? 'matchmaker'
                    : outputElement?.id === 'gemini-comparison-output' ? 'comparison'
                    : 'deck';
        const sectionId = scope === 'deck' ? 'toolkit' : scope;
        // Guard: avoid console spam when not configured
        const hasKey = (() => { try { return !!localStorage.getItem('GEMINI_API_KEY'); } catch { return false; } })();
        const usingProxy = typeof window.__AI_POD_PROXY__ === 'string' && window.__AI_POD_PROXY__.length > 0;
        if (!hasKey && !usingProxy) {
            const msg = 'AI not configured. In console, run: localStorage.setItem(\'GEMINI_API_KEY\',\'<YOUR_KEY>\'); optional: localStorage.setItem(\'GEMINI_MODEL\',\'gemini-1.5-flash\'); then location.reload()';
            if (outputElement) outputElement.textContent = msg;
            try { UI_MODULE.updateToolkitBriefing?.('error', { message: 'AI key missing' }); } catch {}
            return { ok: false, error: new Error('gemini_key_missing') };
        }

        const deckJob = UI_MODULE.queueJob({ task, scope, sectionId });
        try { UI_MODULE.animateDockFlightFromElement(outputElement || document.getElementById('toolkit-gauge')); } catch {}

        const { systemPrompt, userPrompt, generationConfig } = this.getPromptsForTask(task, payload);
        const provider = window.AI_POD?.provider;
        const write = (content, { sanitize = true } = {}) => {
            if (!outputElement) return;
            const text = content ?? '';
            const html = sanitize ? API_MODULE.sanitizeForOutput(text) : String(text);
            API_MODULE.renderAIResponseProto(outputElement, html);
        };

        if (!provider) {
            const fallback = this.localAIFallback(task, payload);
            if (task === 'getFutureIntel') {
                try {
                    const parsed = typeof fallback === 'string' ? JSON.parse(fallback) : fallback;
                    const items = Array.isArray(parsed?.intelligence) ? parsed.intelligence : [];
                    if (items.length) UI_MODULE.updateIntelUI(items); else UI_MODULE.updateIntelUIWithRawText(String(fallback));
                } catch { UI_MODULE.updateIntelUIWithRawText(String(fallback)); }
            } else {
                write(fallback);
                API_MODULE.writeAITaskCache(API_MODULE.getAITaskCacheKey(task, payload), fallback);
            }
            try { UI_MODULE.updateToolkitBriefing?.('success', { elapsedMs: 0, fallback: true }); } catch {}
            UI_MODULE.resolveJob(deckJob.id, 'success');
            return { ok: true, fallback: true };
        }

        const cacheKey = API_MODULE.getAITaskCacheKey(task, payload);
        const cacheEntry = API_MODULE.readAITaskCache(cacheKey);
        if (cacheEntry && outputElement) {
            API_MODULE.renderAIResponseProto(outputElement, cacheEntry.value);
            UI_MODULE.resolveJob(deckJob.id, 'success');
            try { UI_MODULE.updateToolkitBriefing?.('success', { elapsedMs: 0, cached: true }); } catch {}
            return { ok: true, cached: true };
        }

        try {
            const retryPolicy = STATE.config.aiRetryPolicy || { attempts: 1, baseDelay: 0 };
            const attempts = Math.max(1, Number(retryPolicy.attempts) || 1);
            const baseDelay = Math.max(0, Number(retryPolicy.baseDelay) || 0);
            let lastError = null;

            for (let attempt = 0; attempt < attempts; attempt++) {
                try {
                    const response = await provider.call(`toolbox:${task}`, systemPrompt, userPrompt, generationConfig, { timeout: 12000, meta: { track: false, scope, label: task } });
                    const ok = typeof response === 'object' && response !== null && 'ok' in response ? response.ok : true;
                    const data = typeof response === 'object' && response !== null && 'data' in response ? response.data : response;
                    const asString = typeof data === 'string' ? data : (data?.text ?? JSON.stringify(data ?? {}));

                    if (task === 'getFutureIntel') {
                        try {
                            const intelData = typeof asString === 'string' ? JSON.parse(asString) : data;
                            const items = intelData?.intelligence;
                            if (Array.isArray(items)) {
                                UI_MODULE.updateIntelUI(items);
                            } else {
                                throw new Error('Missing intelligence array.');
                            }
                        } catch (intelError) {
                            console.error('Failed to parse Intel JSON:', intelError, 'Raw payload:', data);
                            UI_MODULE.updateIntelUIWithRawText(String(asString));
                        }
                    } else if (outputElement) {
                        if (ok === false) {
                            write('AI POD unavailable right now.');
                        } else {
                            const safe = API_MODULE.sanitizeForOutput(asString || 'AI POD has no update yet.');
                            API_MODULE.renderAIResponseProto(outputElement, safe);
                            API_MODULE.writeAITaskCache(cacheKey, safe);
                        }
                    }

                    if (ok) {
                        try {
                            const elapsed = Date.now() - startTime.getTime();
                            UI_MODULE.updateToolkitBriefing?.('success', { elapsedMs: elapsed, attempt });
                        } catch {}
                        UI_MODULE.resolveJob(deckJob.id, 'success');
                        return { ok: true };
                    }

                    try { UI_MODULE.updateToolkitBriefing?.('error', { message: 'AI POD unavailable' }); } catch {}
                    UI_MODULE.resolveJob(deckJob.id, 'error');
                    return { ok: false };
                } catch (error) {
                    lastError = error;
                    if (attempt < attempts - 1) {
                        const backoff = baseDelay * Math.pow(2, attempt);
                        await API_MODULE.delay(backoff);
                        continue;
                    }
                    throw error;
                }
            }

            throw lastError || new Error('ai_retry_failed');
        } catch (error) {
            try {
                const fallback = this.localAIFallback(task, payload);
                if (task === 'getFutureIntel') {
                    try {
                        const parsed = typeof fallback === 'string' ? JSON.parse(fallback) : fallback;
                        const items = Array.isArray(parsed?.intelligence) ? parsed.intelligence : [];
                        if (items.length) UI_MODULE.updateIntelUI(items); else UI_MODULE.updateIntelUIWithRawText(String(fallback));
                    } catch { UI_MODULE.updateIntelUIWithRawText(String(fallback)); }
                } else {
                    write(fallback);
                    API_MODULE.writeAITaskCache(API_MODULE.getAITaskCacheKey(task, payload), API_MODULE.sanitizeForOutput(String(fallback)));
                }
                UI_MODULE.resolveJob(deckJob.id, 'success');
                try { UI_MODULE.updateToolkitBriefing?.('success', { fallback: true }); } catch {}
                return { ok: true, fallback: true };
            } catch {
                console.error('AI Agent Call Failed:', error);
                write('AI POD connection error. Try again shortly.');
                try { UI_MODULE.updateToolkitBriefing?.('error', { message: error?.message || 'Connection error' }); } catch {}
                UI_MODULE.resolveJob(deckJob.id, 'error');
                return { ok: false, error };
            }
        }
    },

    getPromptsForTask(task, payload) {
        let systemPrompt = "Yo! I'm AI Bradaa, your tech-savvy buddy from Malaysia. I keep things simple, direct, and always look for the best value, just like any smart Malaysian would. No confusing jargon, just straight-up good advice. I format my answers with Markdown for clarity, using headings (###) and bullet points (*).";
        let userPrompt = `My friend needs help! Here's the situation:\n\n${JSON.stringify(payload, null, 2)}`;
        let generationConfig = { responseMimeType: "text/plain" };

        switch (task) {
            case 'findMatch':
                systemPrompt = "Yo, I'm AI Bradaa! You need a laptop? Easy. I'll pick the single best option from the list based on your needs. I'll explain my choice simply, with a clear '### Recommendation' heading, followed by '### Why I Chose This' with bullet points, so you know exactly why it's the right gear for you. Let's do this.";
                userPrompt = `My friend is looking for a laptop. Here's what they need:\n- Budget: ${payload.criteria.budget}\n- Main Use: ${payload.criteria.usecase}\n- Portability: ${payload.criteria.portability}\n\nBased on this list of laptops, which single one is the best choice and why? Keep it simple.\n\n${JSON.stringify(payload.laptops, null, 2)}`;
                break;
            case 'compareLaptops':
                systemPrompt = "Yo, I'm AI Bradaa. You're stuck between a few laptops? Let's break it down. I'll compare them side-by-side using Markdown headings (###) for each model and bullet points (*) for the pros and cons. No fluff.";
                userPrompt = `Help me compare these laptops. What are the main differences?\n\n${JSON.stringify(payload.laptops, null, 2)}`;
                break;
            case 'getFutureIntel':
                systemPrompt = "Yo, I'm AI Bradaa. I'll get you the latest tech intel, fast. I will provide a JSON object with a key 'intelligence' which is an array of three objects. Each object must have three string keys: 'title', 'summary' (one simple sentence), and 'verdict' (one word, e.g., 'SOLID', 'WAIT', 'HYPE').";
                userPrompt = "What are the three most important tech news updates for consumers in Malaysia right now?";
                generationConfig.responseMimeType = "application/json";
                generationConfig.responseSchema = {
                    type: "OBJECT",
                    properties: {
                        intelligence: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    summary: { type: "STRING" },
                                    verdict: { type: "STRING" }
                                }
                            }
                        }
                    }
                };
                break;
            case 'mission-pick-brief':
                systemPrompt = "Yo, I'm AI Bradaa. Summarize why this laptop is a Mission Pick for Malaysia. Keep it concise, value-first, and practical. Use Markdown with '### Mission Brief' then 4–6 bullets: Why it wins now (MYR), AI/ML fit (CUDA/NPU/Mac), longevity/upgrade notes, risks/red flags, and best use cases. Avoid hype, no tables, no code.";
                userPrompt = `Laptop context:\n${JSON.stringify(payload?.laptopData || {}, null, 2)}\n\nWrite a short mission brief for: ${payload?.laptop || ''}.`;
                generationConfig.responseMimeType = "text/plain";
                break;
        }
        return { systemPrompt, userPrompt, generationConfig };
    }

  };

  // --- UI MODULE -----------------------------------------------------------
  const UI_MODULE = {
    configureCharts() {
        if (!window.Chart) return;
        Chart.defaults.color = '#A8B2CC';
        Chart.defaults.font = STATE.config.chartFont;
        Chart.defaults.borderColor = 'rgba(48, 54, 61, 0.8)';
    },
    renderAll() {
        const filteredAll = APP.computeFilteredSet();
        const explorerBase = STATE.data.rankedSource.top10.length ? STATE.data.rankedSource.top10 : filteredAll;
        const chartsInput = explorerBase.filter(d => Number.isFinite(d.price) && d.price > 0 && Number.isFinite(d.score) && d.score > 0).slice(0, 10);
        if (Array.isArray(STATE.ui.app.radarSelection) && STATE.ui.app.radarSelection.length) {
            const available = new Set(filteredAll.map(item => item.model));
            STATE.ui.app.radarSelection = STATE.ui.app.radarSelection.filter(model => available.has(model));
        }
        this.updateDatasetMeta();
        this.renderAppendicesList(APP.computeAppendixSet());
        this.renderLaptopSelector(APP.computeShortlistSet());
        this.renderTopPicks(filteredAll);
        this.renderCharts(chartsInput);
    },
    renderLaptopSelector(data) {
        const selector = document.getElementById('laptop-selector-container');
        if (!selector) return;
        const limited = Array.isArray(data) ? data.slice(0, 35) : [];
        selector.innerHTML = limited.map(l => {
            const active = STATE.ui.app.radarSelection.includes(l.model);
            const cls = `filter-button radar-selector border border-[var(--c-border)] px-2 py-1 text-xs rounded-md truncate${active ? ' active' : ''}`;
            const label = (l.model || '').replace(/"/g, '&quot;');
            const title = `${l.brand || ''} ${l.model || ''} — RM${l.price}`.trim();
            return `<button class="${cls}" data-model="${label}" data-selected="${active ? '1' : '0'}" aria-pressed="${active ? 'true' : 'false'}" title="${title}">${l.model}</button>`;
        }).join('');
    },
    updateDatasetMeta() {
        const metaEl = document.getElementById('appendix-dataset-meta');
        if (!metaEl) return;
        const { generatedAt, source, count } = STATE.data.datasetMeta;
        if (!count) {
            metaEl.textContent = '';
            return;
        }
        const tz = 'Asia/Kuala_Lumpur';
        let renderedDate = 'Inline fallback';
        if (generatedAt) {
            try {
                renderedDate = new Date(generatedAt).toLocaleString('en-MY', { timeZone: tz, hour12: false });
            } catch {}
        }
        metaEl.textContent = `Dataset: ${renderedDate} MYT • Source: ${source} • Units: ${count}`;
    },
    updateIntelUI(intelligence) {
        intelligence.forEach((item, index) => {
            const el = id => document.getElementById(id);
            const titleEl = el(`intel-${index}-title`);
            const summaryEl = el(`intel-${index}-summary`);
            const verdictEl = el(`intel-${index}-verdict`);
            if (titleEl) titleEl.textContent = item.title;
            if (summaryEl) {
                const links = Array.isArray(item.links) ? item.links.slice(0, 4) : [];
                const linksHtml = links.map(href => `<a class="intel-link" href="${API_MODULE.sanitizeForOutput(href)}" target="_blank" rel="noopener">View Source</a>`).join(' <span class="intel-link--secondary">•</span> ');
                summaryEl.innerHTML = `${API_MODULE.sanitizeForOutput(item.summary)}${links.length ? `<br><span class=\"intel-label\">Sources:</span> ${linksHtml}` : ''}`;
            }
            if (verdictEl) verdictEl.textContent = item.verdict;
        });
    },
    updateIntelUIWithRawText(text) {
        const summaryEl = document.getElementById('intel-0-summary');
        const titleEl = document.getElementById('intel-0-title');
        if (titleEl) titleEl.textContent = "Intel Feed Anomaly";
        if (summaryEl) summaryEl.textContent = `AI Bradaa found something, but it's a bit scrambled! Here's the raw message: ${text}`;
    },
    async refreshIntelDataset(reason = 'manual') {
        try {
            const res = await fetch('/ai_pod/data/intel/tech_signals.json', { cache: 'no-store' });
            if (!res.ok) throw new Error('intel_dataset_http_' + res.status);
            const json = await res.json();
            const list = Array.isArray(json?.intelligence) ? json.intelligence : (Array.isArray(json) ? json : []);
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 3600 * 1000;
            const fresh = [];
            const stale = [];
            for (const it of list) {
                const ts = Date.parse(it.ts || json.generated_at || 0);
                const age = isNaN(ts) ? 0 : (now - ts);
                const entry = { title: it.title, summary: it.summary, verdict: it.verdict, ts };
                if (age > THIRTY_DAYS) stale.push({ ...entry, verdict: entry.verdict || 'STALE' }); else fresh.push(entry);
            }
            const ordered = [...fresh, ...stale].slice(0, 3);
            if (ordered.length) {
                UI_MODULE.updateIntelUI(ordered);
                try { window.aiPodTelemetry?.emit?.('intel.dataset.loaded', { reason, counts: { items: ordered.length }, ts: new Date().toISOString() }); } catch {}
                return true;
            }
        } catch (e) {
            // fallback in caller
        }
        return false;
    },
    updateToolkitBriefing(stage = 'queued', ctx = {}) {
        const toolkitState = STATE.ui?.toolkit;
        if (!toolkitState) return;
        const key = toolkitState.profileKey;
        const profile = TOOLKIT_PROFILES[key] || DEFAULT_TOOLKIT_PROFILE;
        const now = new Date();
        const el = id => document.getElementById(id);
        if (typeof stage === 'string') {
          toolkitState.lastStage = stage;
        } else if (!toolkitState.lastStage) {
          toolkitState.lastStage = 'queued';
        }
        // Header
        if (el('toolkit-briefing-badge')) el('toolkit-briefing-badge').textContent = profile.badge;
        const collapsedView = !!toolkitState.collapsed;
        const titleText = collapsedView ? 'AI Bradaa — Brain Section' : `AI Bradaa: ${profile.displayName}`;
        if (el('toolkit-briefing-title')) el('toolkit-briefing-title').textContent = titleText;
        if (el('toolkit-status-health')) el('toolkit-status-health').textContent = profile.health;
        const [latMin, latMax] = profile.latencyRange || [70, 95];
        const latency = Math.round(latMin + Math.random() * (latMax - latMin));
        if (el('toolkit-status-latency')) el('toolkit-status-latency').textContent = `Latency: ${latency} ms`;
        if (el('toolkit-status-mode')) el('toolkit-status-mode').textContent = profile.mode;
        // Gauge
        const gauge = Math.max(0, Math.min(100, profile.gauge));
        if (el('toolkit-gauge-percent')) el('toolkit-gauge-percent').textContent = `${gauge}%`;
        const gaugeEl = document.getElementById('toolkit-gauge');
        if (gaugeEl) {
            const clamp01 = value => Math.max(0, Math.min(1, value));
            let progress = typeof ctx?.progress === 'number'
              ? clamp01(ctx.progress)
              : (typeof toolkitState.progress === 'number' ? clamp01(toolkitState.progress) : gauge / 100);
            switch (stage) {
              case 'queued':
                progress = Math.min(progress, 0.12);
                break;
              case 'running':
                progress = Math.max(progress, 0.38);
                break;
              case 'success':
                progress = Math.max(progress, 0.98);
                break;
              case 'error':
                progress = Math.max(progress, 0.12);
                break;
              default:
                break;
            }
            toolkitState.progress = progress;
            const stageProgress = {
              queued: 0.08,
              running: Math.min(0.9, Math.max(progress, 0.35 + Math.random() * 0.45)),
              success: Math.max(progress, 0.98),
              error: 0.12
            };
            const resolved = stageProgress[stage] ?? progress;
            gaugeEl.style.setProperty('--gauge-progress', String(resolved));
            toolkitState.progress = resolved;
            if (typeof stage === 'string') {
              gaugeEl.setAttribute('data-stage', stage);
              const stageLabel = { queued: 'Just started', running: 'Running', success: 'Ready', error: 'Error' }[stage] || 'Idle';
              gaugeEl.setAttribute('aria-label', `AI Pod live status: ${stageLabel}`);
            }
        }
        try { this['AI Bradaa thinking prototype v1'](); } catch {}
        // Insights
        const insightsList = el('toolkit-insights-list');
        if (insightsList && Array.isArray(profile.insights)) {
            insightsList.innerHTML = profile.insights.map((t, i) => `<li data-line="${i}">${t}</li>`).join('');
        }
        // Pills
        const pillsRoot = el('toolkit-pills');
        if (pillsRoot) {
            pillsRoot.querySelectorAll('.toolkit-pill').forEach(p => p.classList.remove('toolkit-pill--active'));
            const active = new Set(profile.pills || []);
            pillsRoot.querySelectorAll('.toolkit-pill').forEach(p => {
                const sig = p.getAttribute('data-signal');
                if (active.has(sig)) p.classList.add('toolkit-pill--active');
            });
        }
        // Live dropdown
        const dd = el('toolkit-live-dropdown');
        const ddLabel = el('toolkit-live-label');
        const ddMeta = el('toolkit-live-meta');
        const ddLog = el('toolkit-live-log');
        if (dd && ddLabel && ddMeta && ddLog) {
            dd.setAttribute('aria-hidden', 'false');
            dd.classList.remove('toolkit-live-dropdown--active');
            void dd.offsetWidth; // reflow
            dd.classList.add('toolkit-live-dropdown--active');
            ddLabel.textContent = 'Live fetch';
            if (stage === 'queued') {
                ddMeta.textContent = `Queued • ${now.toLocaleTimeString('en-MY', { hour12: false })}`;
                const lines = profile.logs?.queued || DEFAULT_TOOLKIT_PROFILE.logs.queued;
                ddLog.innerHTML = lines.map((t, i) => `<p data-line="q${i}">${t}</p>`).join('');
            } else if (stage === 'running') {
                ddMeta.textContent = `Running ${profile.displayName} • ${now.toLocaleTimeString('en-MY', { hour12: false })}`;
                const lines = profile.logs?.running || DEFAULT_TOOLKIT_PROFILE.logs.running;
                const intro = ctx?.action ? [`Signal: ${ctx.action}`] : [];
                ddLog.innerHTML = [...intro, ...lines].map((t, i) => `<p data-line="r${i}">${t}</p>`).join('');
            } else if (stage === 'success') {
                const elapsed = Math.max(1, Number(ctx?.elapsedMs || 0));
                ddMeta.textContent = `Complete • ${elapsed} ms`;
                const builder = profile.logs?.success || DEFAULT_TOOLKIT_PROFILE.logs.success;
                const lines = typeof builder === 'function' ? builder(elapsed) : [String(builder)];
                ddLog.innerHTML = lines.map((t, i) => `<p data-line="s${i}">✅ ${t}</p>`).join('');
            } else if (stage === 'error') {
                const msg = ctx?.message || 'Unknown error';
                ddMeta.textContent = 'Error';
                const builder = profile.logs?.error || DEFAULT_TOOLKIT_PROFILE.logs.error;
                const lines = typeof builder === 'function' ? builder(msg) : [String(builder)];
                ddLog.innerHTML = [`⚠️ ${msg}`, ...lines].map((t, i) => `<p data-line="e${i}">${t}</p>`).join('');
            }
        }
    },
    renderToolkitPreview() {
        this.syncToolkitSummary();
    },
    toggleToolkitCollapsed(collapsed = false) {
        const layout = document.querySelector('.toolkit-layout');
        if (!layout) return;
        layout.setAttribute('data-collapsed', collapsed ? 'true' : 'false');
        if (STATE.ui?.toolkit) STATE.ui.toolkit.collapsed = !!collapsed;
        this.syncToolkitSummary();
        if (!collapsed && STATE.ui?.toolkit?.deckOpen) {
            this.toggleDeckModal(true, { preserveCollapse: true });
        }
        if (collapsed && STATE.ui?.toolkit?.deckOpen) {
            this.toggleDeckModal(false, { preserveCollapse: true });
        }
    },
    ensureToolkitExpanded() {
        const toolkitState = STATE.ui?.toolkit;
        const wasCollapsed = !!toolkitState?.collapsed;
        if (wasCollapsed) {
            this.toggleToolkitCollapsed(false);
            // Smooth scroll to the top of the toolkit section to avoid clipping
            const section = document.getElementById('toolkit');
            if (section) {
                const y = section.getBoundingClientRect().top + window.scrollY - 24;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        }
        if (!STATE.ui.toolkit.deckOpen) {
            this.toggleDeckModal(true);
        }
    },
    toggleDeckModal(open = true, options = {}) {
        const { preserveCollapse = false } = options;
        const root = document.getElementById('toolkit');
        const layout = root?.querySelector('.toolkit-layout');
        const backdrop = document.getElementById('deck-backdrop');
        if (!root || !layout) return;
        const deckId = STATE.config.deckBlueprint?.id || 'deck-ai-pod-prototype-1';
        layout.setAttribute('data-deck-prototype', deckId);
        if (open) {
            if (STATE.ui.toolkit.collapsed) {
                this.toggleToolkitCollapsed(false);
            }
            const active = document.activeElement instanceof HTMLElement ? document.activeElement : null;
            STATE.ui.toolkit.lastFocus = active;
            STATE.ui.toolkit.deckOpen = true;
            root.setAttribute('data-deck-open', 'true');
            document.body.setAttribute('data-deck-open', 'true');
            layout.setAttribute('role', 'dialog');
            layout.setAttribute('aria-modal', 'true');
            if (backdrop) backdrop.setAttribute('aria-hidden', 'false');
            requestAnimationFrame(() => layout.focus({ preventScroll: true }));
        } else {
            STATE.ui.toolkit.deckOpen = false;
            root.setAttribute('data-deck-open', 'false');
            document.body.removeAttribute('data-deck-open');
            layout.setAttribute('role', 'region');
            layout.setAttribute('aria-modal', 'false');
            if (backdrop) backdrop.setAttribute('aria-hidden', 'true');
            if (!preserveCollapse && !STATE.ui.toolkit.collapsed) {
                this.toggleToolkitCollapsed(true);
            }
            const returnFocus = STATE.ui.toolkit.lastFocus;
            STATE.ui.toolkit.lastFocus = null;
            if (returnFocus instanceof HTMLElement) {
                requestAnimationFrame(() => returnFocus.focus({ preventScroll: true }));
            }
        }
    },
    queueJob(meta = {}) {
        const toolkitState = STATE.ui?.toolkit;
        if (!toolkitState) return { id: -1, status: 'error', meta };
        const serial = ++toolkitState.jobSerial;
        const job = { id: serial, status: 'running', started: Date.now(), meta };
        toolkitState.jobs.push(job);
        this.updateJobIndicators();
        // Animate enqueue from deck gauge to FAB if deck visible
        try { this.animateDockFlightFromGauge(); } catch {}
        return job;
    },
    resolveJob(jobId, status = 'success') {
        const toolkitState = STATE.ui?.toolkit;
        if (!toolkitState) return;
        const job = toolkitState.jobs.find(j => j.id === jobId);
        if (!job) return;
        job.status = status;
        job.completed = Date.now();
        const delay = status === 'success' ? 2400 : 12000;
        // Keep FAB visible slightly longer after job completion
        toolkitState.fabLingerUntil = Date.now() + delay + 1200;
        const flush = () => {
            toolkitState.jobs = toolkitState.jobs.filter(j => j.id !== jobId);
            this.updateJobIndicators();
        };
        if (delay > 0) {
            setTimeout(flush, delay);
        } else {
            flush();
        }
        this.updateJobIndicators();
    },
    updateJobIndicators() {
        const indicator = document.getElementById('aipod-dock-indicator');
        const fab = document.getElementById('aipod-fab');
        const countEl = document.getElementById('aipod-fab-count');
        const pop = document.getElementById('aipod-fab-popover');
        const list = document.getElementById('aipod-fab-list');
        const toolkitState = STATE.ui?.toolkit;
        const total = toolkitState?.jobs.length || 0;
        const running = toolkitState?.jobs.some(j => j.status === 'running');
        const linger = Date.now() < (toolkitState?.fabLingerUntil || 0);
        if (indicator) indicator.classList.toggle('show', running);
        if (fab) {
            fab.classList.toggle('show', total > 0 || linger);
            fab.setAttribute('aria-hidden', (total > 0 || linger) ? 'false' : 'true');
            fab.setAttribute('aria-label', total > 0 ? `AI Bradaa background tasks (${total})` : 'AI Bradaa background tasks');
            if (total > 0) fab.classList.remove('hidden');
        }
        if (countEl) countEl.textContent = String(total);
        if (pop && pop.dataset.open === 'true' && list) this.renderFabList();
        // Reflect progress on FAB ring (AI Bradaa thinking prototype v1)
        try { this['AI Bradaa thinking prototype v1'](); } catch {}
    },
    renderFabList() {
        const list = document.getElementById('aipod-fab-list');
        if (!list) return;
        const toolkitState = STATE.ui?.toolkit;
        if (!toolkitState?.jobs.length) { list.innerHTML = '<div class="p-3 text-xs text-[var(--c-text-secondary)]">No background tasks.</div>'; return; }
        const toTime = (ts) => new Date(ts).toLocaleTimeString('en-MY', { hour12: false });
        list.innerHTML = toolkitState.jobs.map(j => {
            const task = j.meta?.task || 'AI Task';
            const status = j.status;
            const badge = status === 'running' ? 'RUNNING' : status.toUpperCase();
            const sectionId = j.meta?.sectionId || '';
            return `<div class="fab-row" data-job-id="${j.id}" data-section-id="${sectionId}">
                <div class="meta">
                  <span class="task">${task}</span>
                  <span class="time">${toTime(j.started)}</span>
                </div>
                <span class="badge">${badge}</span>
            </div>`;
        }).join('');
    },
    toggleFabPopover(force) {
        const pop = document.getElementById('aipod-fab-popover');
        if (!pop) return;
        const open = typeof force === 'boolean' ? force : pop.dataset.open !== 'true';
        pop.dataset.open = open ? 'true' : 'false';
        pop.setAttribute('aria-hidden', open ? 'false' : 'true');
        if (open) this.renderFabList();
    },
    minimizeToFab() {
        // Run branding ghost flight, then minimize deck
        try { this.animateDockFlightFromGauge(); } catch {}
        this.toggleDeckModal(false, { preserveCollapse: true });
    },
    animateDockFlightFromGauge() {
        const source = document.getElementById('toolkit-gauge') || document.querySelector('.toolkit-layout');
        const fab = document.getElementById('aipod-fab');
        const body = document.body;
        if (!source || !body) return;
        const ghost = document.createElement('div');
        ghost.className = 'dock-flight-ghost';
        body.appendChild(ghost);
        const s = source.getBoundingClientRect();
        const startX = s.left + s.width / 2; const startY = s.top + s.height / 2;
        let endX = window.innerWidth - 18 - 24; let endY = window.innerHeight - 18 - 24;
        if (fab && fab.classList.contains('show')) {
            const f = fab.getBoundingClientRect(); endX = f.left + f.width / 2; endY = f.top + f.height / 2;
        }
        const dx = Math.round(endX - startX); const dy = Math.round(endY - startY);
        ghost.style.left = `${Math.round(startX - 21)}px`;
        ghost.style.top = `${Math.round(startY - 21)}px`;
        ghost.style.setProperty('--tx', `${dx}px`);
        ghost.style.setProperty('--ty', `${dy}px`);
        // Ensure FAB visible before animating for target clarity
        requestAnimationFrame(() => {
            ghost.setAttribute('data-flying', 'true');
            ghost.addEventListener('animationend', () => ghost.remove(), { once: true });
        });
    },
    animateDockFlightFromElement(el) {
        if (!el) return;
        const fab = document.getElementById('aipod-fab');
        const body = document.body;
        const rect = el.getBoundingClientRect();
        const startX = rect.left + rect.width / 2; const startY = rect.top + rect.height / 2;
        const ghost = document.createElement('div');
        ghost.className = 'dock-flight-ghost';
        body.appendChild(ghost);
        ghost.style.left = `${Math.round(startX - 21)}px`;
        ghost.style.top = `${Math.round(startY - 21)}px`;
        let endX = window.innerWidth - 18 - 24; let endY = window.innerHeight - 18 - 24;
        if (fab && fab.classList.contains('show')) {
            const f = fab.getBoundingClientRect(); endX = f.left + f.width / 2; endY = f.top + f.height / 2;
        }
        const dx = Math.round(endX - startX); const dy = Math.round(endY - startY);
        ghost.style.setProperty('--tx', `${dx}px`);
        ghost.style.setProperty('--ty', `${dy}px`);
        requestAnimationFrame(() => {
            ghost.setAttribute('data-flying', 'true');
            ghost.addEventListener('animationend', () => ghost.remove(), { once: true });
        });
    },
    // AI Bradaa thinking prototype v1 — show background progress on FAB ring
    "AI Bradaa thinking prototype v1"() {
        const fab = document.getElementById('aipod-fab');
        if (!fab) return;
        const toolkitState = STATE.ui?.toolkit;
        if (!toolkitState) return;
        const total = toolkitState.jobs.length;
        const running = toolkitState.jobs.some(j => j.status === 'running');
        const stage = toolkitState.lastStage || 'queued';
        let p = typeof toolkitState.progress === 'number' ? Number(toolkitState.progress) : (running || stage === 'running' ? 0.66 : (total > 0 ? 1 : 0));
        p = Math.max(0, Math.min(1, p));
        fab.style.setProperty('--fab-progress', String(p));
        const ringOn = (total > 0) || (stage === 'running');
        fab.style.setProperty('--fab-ring', ringOn ? '1' : '0');
        if (running || stage === 'running') fab.setAttribute('data-spin', 'true'); else fab.removeAttribute('data-spin');
    },
    // AI Bradaa Branding prototype v1 — ensure FAB uses mini Soul and brand tokens
    "AI Bradaa Branding prototype v1"() {
        const fab = document.getElementById('aipod-fab');
        if (!fab) return;
        if (!fab.querySelector('.aipod-fab-soul')) {
            const soul = document.createElement('span');
            soul.className = 'aipod-fab-soul';
            soul.setAttribute('aria-hidden', 'true');
            fab.insertBefore(soul, fab.firstChild);
        }
        try {
            const b = window.AI_POD?.branding || {};
            const label = `${b.title || 'AI BRADAA'} background tasks`;
            fab.setAttribute('aria-label', label);
            fab.setAttribute('title', label);
        } catch {}
    },
    syncToolkitSummary() {
        const summarySoul = document.getElementById('toolkit-summary-soul');
        const summaryDeck = document.getElementById('toolkit-summary-deck');
        if (!summarySoul || !summaryDeck) return;
        const stage = STATE.ui.toolkit.lastStage || 'queued';
        const progress = typeof STATE.ui.toolkit.progress === 'number' ? STATE.ui.toolkit.progress : 0;
        const stageText = {
            queued: 'Primed for launch',
            running: progress >= 0.66 ? 'Executing mission (66%+)' : 'Running live command',
            success: 'Command complete — awaiting next order',
            error: 'Attention needed — review mission log'
        }[stage] || 'Primed for launch';
        summarySoul.textContent = stageText;
        summaryDeck.textContent = STATE.ui.toolkit.collapsed
            ? 'Deck AI Pod prototype 1: standing by for your command.'
            : `Deck AI Pod prototype 1 • Active tool: ${TOOLKIT_PROFILES[STATE.ui.toolkit.profileKey]?.displayName || 'Deck Ready'}`;
    },
    setSoulProgress(value) {
        const progress = Math.max(0, Math.min(1, Number(value) || 0));
        STATE.ui.toolkit.progress = progress;
        const gaugeEl = document.getElementById('toolkit-gauge');
        if (gaugeEl) gaugeEl.style.setProperty('--gauge-progress', String(progress));
        this.syncToolkitSummary();
    },
    renderAppendicesList(data) {
        const container = document.getElementById('laptop-list-container');
        if (!container) return;

        if (data.length === 0) {
            container.innerHTML = '<p class="text-center text-lg text-[var(--c-text-secondary)] xl:col-span-3">No units match current filter parameters.</p>';
            return;
        }

        const escapeHTML = value => String(value ?? '').replace(/[&<>"]/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[ch]));
        const toKey = laptop => `${laptop.brand}|${laptop.model}`;

        const markup = data.map((l, index) => {
            const key = toKey(l);
            const cached = STATE.data.imageCache[key];
            const hasAI = cached && cached.source && cached.source !== 'fallback';
            const imageSrc = cached?.url ?? l.imageUrl;
            const imageClass = `w-full h-48 object-cover laptop-image${hasAI ? ' laptop-image--ready' : ''}`;
            const badgeLabel = hasAI ? 'AI IMAGE' : 'AI SCOUTING';
            const attribText = hasAI ? `Source: ${escapeHTML(cached.source)}` : 'Source: dataset placeholder';
            return `
              <div class="card bg-[var(--c-bg)] flex flex-col overflow-hidden">
                <div class="relative">
                  <span class="ai-image-badge${hasAI ? ' ai-image-badge--ready' : ''}" data-ai-badge="${key}" aria-live="polite">
                    <svg viewBox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-width="2" d="M12 5v14M5 12h14" /></svg>${badgeLabel}
                  </span>
                  <img data-laptop-image="${key}" src="${escapeHTML(imageSrc)}" alt="${escapeHTML(l.model)}" class="${imageClass}" loading="lazy" decoding="async" width="600" height="400" onerror="this.onerror=null;this.classList.remove('laptop-image--ready');this.src='https://placehold.co/600x400/1a1a1a/4a4a4a?text=Intel+Image';">
                </div>
                <div class="p-4 flex flex-col flex-grow">
                  <div class="flex-grow">
                    <div class="flex justify-between items-start">
                      <span class="text-xs font-semibold uppercase tracking-wider text-[var(--c-text-secondary)]">${escapeHTML(l.brand)}</span>
                      <span class="text-sm font-bold py-1 px-2 rounded-full ${l.platform === 'CUDA' ? 'bg-cyan-900/50 text-cyan-300' : l.platform === 'NPU' ? 'bg-pink-900/50 text-pink-300' : 'bg-gray-700/50 text-gray-300'}">${escapeHTML(l.platform)}</span>
                    </div>
                    <h4 class="font-semibold text-sm mt-1 text-[var(--c-text-primary)] font-body">${escapeHTML(l.model)}</h4>
                    <p class="text-xs text-[var(--c-text-secondary)] mt-2 italic">"${escapeHTML(l.why)}"</p>
                  </div>
                  <div class="mt-4 pt-3 border-t border-[var(--c-border)] text-xs text-[var(--c-text-secondary)] space-y-1">
                    <p><b class="font-semibold w-16 inline-block text-[var(--c-text-primary)]">CPU:</b> ${escapeHTML(l.cpu)}</p>
                    <p><b class="font-semibold w-16 inline-block text-[var(--c-text-primary)]">GPU:</b> ${escapeHTML(l.gpu)}</p>
                    <p><b class="font-semibold w-16 inline-block text-[var(--c-text-primary)]">RAM:</b> ${escapeHTML(l.ram)}</p>
                    <p><b class="font-semibold w-16 inline-block text-[var(--c-text-primary)]">Display:</b> ${escapeHTML(l.display)}</p>
                  </div>
                  <div class="mt-4 border-t border-[var(--c-border)] pt-4">
                    <div class="flex justify-between items-center text-sm">
                      <span class="font-semibold text-lg text-[var(--c-text-primary)]">RM ${escapeHTML(l.price)}</span>
                      <div class="text-right">
                        <span class="block text-xs text-[var(--c-text-secondary)]">Score</span>
                        <span class="font-bold text-lg text-[var(--c-accent-cyan)]">${escapeHTML(l.score)}</span>
                      </div>
                    </div>
                    ${API_MODULE.renderPriceMenu(l, index)}
                    <p class="ai-image-attrib" data-ai-attrib="${key}">${attribText}</p>
                  </div>
                </div>
              </div>
            `;
        }).join('');

        container.innerHTML = markup;

        const schedule = window.requestIdleCallback || window.requestAnimationFrame || (fn => setTimeout(fn, 16));
        schedule(() => UI_MODULE.enhanceImages());
    },
    async populateMissionBrief(picks) {
        if (!STATE.ui.app.interacted) return;
        if (!Array.isArray(picks) || !picks.length) return;
        const provider = window.AI_POD?.provider;
        for (const l of picks) {
            const key = `${l.brand}|${l.model}`;
            const node = document.querySelector(`[data-mission-brief="${key}"]`);
            if (!node || node.dataset.aiLoaded === '1') continue;
            if (STATE.data.aiBriefCache[key]) {
                node.innerHTML = STATE.data.aiBriefCache[key];
                node.dataset.aiLoaded = '1';
                continue;
            }
            if (!provider) {
                node.textContent = l.why || 'Strategic intel pending.';
                node.dataset.aiLoaded = '1';
                continue;
            }
            node.textContent = (window.AI_POD?.strings?.missionBriefPreparing || 'AI mission brief: preparing…');
            try {
                const res = await API_MODULE.callAIAgent('mission-pick-brief', { laptop: l.model, laptopData: l }, node);
                if (res?.ok) {
                    STATE.data.aiBriefCache[key] = node.innerHTML;
                    try { localStorage.setItem('AI_MISSION_BRIEFS_V1', JSON.stringify(STATE.data.aiBriefCache)); } catch {}
                    node.dataset.aiLoaded = '1';
                }
            } catch {}
        }
    },
    async enhanceImages() {
        const nodes = Array.from(document.querySelectorAll('[data-laptop-image]'));
        if (!nodes.length) return;

        for (const node of nodes) {
            if (node.dataset.aiLoaded) continue;
            const key = node.getAttribute('data-laptop-image');
            if (!key) continue;
            const laptop = APP.findLaptopByKey(key);
            if (!laptop) continue;

            const result = await API_MODULE.getSmartImage(laptop);
            if (!result) continue;

            if (result.url && node.src !== result.url) {
                node.src = result.url;
            }
            const badge = document.querySelector(`[data-ai-badge="${key}"]`);
            const attrib = document.querySelector(`[data-ai-attrib="${key}"]`);
            if (result.source && result.source !== 'fallback') {
                node.classList.add('laptop-image--ready');
                badge?.classList.add('ai-image-badge--ready');
                if (badge) badge.textContent = 'AI IMAGE';
                if (attrib) attrib.textContent = `Source: ${result.source}`;
            }
            node.dataset.aiLoaded = '1';
            nodes.shift();
        }
    },
    renderCharts(data) {
        const eligible = Array.isArray(data)
          ? data.filter(d => Number.isFinite(d.price) && d.price > 0 && Number.isFinite(d.score) && d.score > 0)
          : [];
        let top10 = eligible.slice(0, 10);
        // Ensure at least 2 affordable picks (RM3500–RM4500) appear in charts if available
        try {
            const inRange = (d) => Number.isFinite(d.price) && d.price >= (STATE.config.priceMin || 3500) && d.price <= 4500;
            const presentAffordable = top10.filter(inRange).length;
            const needed = Math.max(0, 2 - presentAffordable);
            if (needed > 0) {
                const existing = new Set(top10.map(d => (d.brand + '|' + d.model).toLowerCase()));
                const candidates = eligible.filter(inRange).sort((a,b) => (b.value_rating||0) - (a.value_rating||0));
                for (const c of candidates) {
                    const k = (c.brand + '|' + c.model).toLowerCase();
                    if (existing.has(k)) continue;
                    top10.push(c);
                    existing.add(k);
                    if (top10.length >= 13 || top10.filter(inRange).length >= 2) break;
                }
                // Re-trim to 10 by re-sorting according to current sort selection
                const sorter = {
                  price_asc: (a, b) => a.price - b.price,
                  price_desc: (a, b) => b.price - a.price,
                  score_desc: (a, b) => b.score - a.score,
                  value_desc: (a, b) => (b.value_rating || 0) - (a.value_rating || 0)
                };
                const s = STATE.ui.app.sort;
                top10 = top10.sort(sorter[s] || sorter.value_desc).slice(0, 10);
            }
        } catch {}
        const rankingsData = {
            labels: top10.map(d => d.model),
            datasets: [{ label: 'Score', data: top10.map(d => d.score), backgroundColor: 'rgba(0, 240, 255, 0.7)' }]
        };
        const needRecreateBar = !STATE.ui.charts.rankings || (STATE.ui.charts.rankings.data.labels.length !== rankingsData.labels.length);
        if (needRecreateBar && STATE.ui.charts.rankings) { try { STATE.ui.charts.rankings.destroy(); } catch {} STATE.ui.charts.rankings = null; }
        if (!STATE.ui.charts.rankings) {
            STATE.ui.charts.rankings = new Chart('rankingsChart', { type: 'bar', data: rankingsData, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100 } } } });
        } else {
            STATE.ui.charts.rankings.data = rankingsData;
            STATE.ui.charts.rankings.update();
        }
        const valueData = {
            datasets: [{
                data: top10.map(d => ({ x: d.price, y: d.score, model: d.model })),
                backgroundColor: top10.map(d => STATE.config.platformColorMap[d.platform]),
                pointRadius: 6, pointHoverRadius: 10
            }]
        };
        const needRecreateScatter = !STATE.ui.charts.value || ((STATE.ui.charts.value.data?.datasets?.[0]?.data?.length || 0) !== valueData.datasets[0].data.length);
        if (needRecreateScatter && STATE.ui.charts.value) { try { STATE.ui.charts.value.destroy(); } catch {} STATE.ui.charts.value = null; }
        if (!STATE.ui.charts.value) {
            STATE.ui.charts.value = new Chart('valueChart', { type: 'scatter', data: valueData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.raw.model}: RM${c.raw.x}, Score: ${c.raw.y}` } } }, scales: { x: { title: { display: true, text: 'Price (RM)' } }, y: { title: { display: true, text: 'Score' }, min: 0, max: 100 } } } });
        } else {
            STATE.ui.charts.value.data = valueData;
            STATE.ui.charts.value.update();
        }
    },
    renderTopPicks(data) {
        const root = document.getElementById('top-picks');
        if (!root) return;
        if (!STATE.ui.app.missionPickReady) {
            STATE.ui.app.missionPicks = [];
            root.innerHTML = `
              <div class="top-pick-card text-center" data-state="idle">
                <div class="top-pick-title mb-2">Mission Picks idle</div>
                <p class="text-xs text-[var(--c-text-secondary)] mb-4">Launch Mission Picks to compute the latest recommendations.</p>
                <button type="button" class="action-button" data-action="launch-mission-picks">Launch Mission Picks</button>
              </div>
            `;
            return;
        }
        const picks = APP.computeTopPicks(data);
        STATE.ui.app.missionPicks = picks;
        if (!picks.length) {
            root.innerHTML = '<p class="text-xs text-[var(--c-text-secondary)]">No mission picks match the current filters.</p>';
            return;
        }
        const escapeHTML = value => String(value ?? '').replace(/[&<>"]/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[ch]));
        const missionPlaceholder = (window.AI_POD?.strings?.missionBriefPlaceholder || 'AI mission brief incoming…');
        root.innerHTML = picks.map((l, i) => {
            const best = API_MODULE.bestDealUrl(l);
            const key = `${l.brand}|${l.model}`;
            const selected = STATE.ui.app.radarSelection.includes(l.model);
            const compareLabel = selected ? 'Comparing' : 'Compare';
            const esc = escapeHTML;
            const showScore = (Number(l.score) > 0) ? Number(l.score) : Math.max(60, Math.round((Number(l._rankScore || 0.62)) * 100));
            const segs = (API_MODULE.getSegments(l) || []).slice(0,2).join(', ');
            return `
              <div class="top-pick-card" data-model="${escapeHTML(l.model)}">
                <div class="top-pick-rank">Mission Pick ${i+1}</div>
                <div class="top-pick-title">${esc(l.brand)} — ${esc(l.model)}</div>
                <div class="top-pick-meta">
                  <span>Score: <b>${esc(showScore)}</b></span>
                  <span>Price: <b>RM ${esc(l.price)}</b></span>
                  <span>Cycle: <b>${esc(l.relYears)}</b> yrs</span>
                  <span>Use Case: <b>${esc(segs || '—')}</b></span>
                </div>
                <div class="top-pick-actions">
                  <button type="button" class="action-button${selected ? ' is-selected' : ''}" data-action="compare" data-selected="${selected ? '1' : '0'}" data-model="${escapeHTML(l.model)}">${compareLabel}</button>
                  <a class="action-button" ${best ? `href="${escapeHTML(best)}" target="_blank" rel="noopener"` : ''} data-action="best">Best Deal</a>
                  <button type="button" class="action-button" data-action="tool" data-model="${escapeHTML(l.model)}">Analyze</button>
                </div>
                <div class="mission-brief-output text-xs text-[var(--c-text-secondary)] mt-2" data-role="mission-brief" data-ai-proto="v1" data-mission-brief="${escapeHTML(key)}" aria-live="polite">${escapeHTML(l.why || missionPlaceholder)}</div>
              </div>
            `;
        }).join('');
        const schedule = window.requestIdleCallback || window.requestAnimationFrame || (fn => setTimeout(fn, 16));
        if (STATE.ui.app.interacted) schedule(() => UI_MODULE.populateMissionBrief(picks));
    },
    renderRadarChart() {
        if (!STATE.data.allLaptops.length) return;
        const selected = STATE.data.allLaptops.filter(l => STATE.ui.app.radarSelection.includes(l.model));
        const out = document.getElementById('gemini-comparison-output');
        const palette = Array.isArray(STATE.config?.radarPalette) && STATE.config.radarPalette.length ? STATE.config.radarPalette : ['#D83F87', '#00F0FF', '#F8F32B'];
        const metricKeys = ['ai', 'thermals', 'upgrade', 'linux', 'portability', 'value'];
        const labels = ['AI', 'Thermals', 'Upgrade', 'Linux', 'Portability', 'Value'];
        const datasets = selected.map((laptop, i) => {
            const hex = palette[i % palette.length];
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            const dataPoints = metricKeys.map(key => {
                const raw = laptop.scores?.[key];
                if (raw === null || raw === undefined) return 5;
                const numeric = typeof raw === 'string' ? parseFloat(raw) : Number(raw);
                return Number.isFinite(numeric) && numeric > 0 ? numeric : 5;
            });
            return {
                label: laptop.model,
                data: dataPoints,
                fill: true,
                backgroundColor: `rgba(${r},${g},${b},0.2)`,
                borderColor: hex,
                pointBackgroundColor: hex
            };
        });
        if (!datasets.length) {
            const placeholderColor = STATE.config?.radarPlaceholderColor || 'rgba(236, 246, 255, 0.45)';
            datasets.push({
                label: window.AI_POD?.strings?.comparisonPlaceholderLabel || 'Awaiting selection',
                data: metricKeys.map(() => 1),
                fill: true,
                backgroundColor: 'rgba(236, 246, 255, 0.08)',
                borderColor: placeholderColor,
                borderDash: [6, 6],
                pointRadius: 0,
                pointHoverRadius: 0
            });
        }
        const radarData = { labels, datasets };
        const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 10, pointLabels: { font: STATE.config.chartFont }, ticks: { display: false } } }, plugins: { legend: { display: true } } };
        if (!STATE.ui.charts.radar) {
            STATE.ui.charts.radar = new Chart('radarChart', { type: 'radar', data: radarData, options: chartOptions });
        } else {
            const chart = STATE.ui.charts.radar;
            chart.options = chartOptions;
            chart.data.labels = radarData.labels.slice();
            chart.data.datasets.length = 0;
            for (const ds of radarData.datasets) chart.data.datasets.push(ds);
            chart.update();
        }
        if (!selected.length) {
            if (out) out.textContent = window.AI_POD?.strings?.comparisonDefault || 'Select laptops to begin analysis...';
            return;
        }
        if (selected.length === 1) {
            UI_MODULE.renderSingleLaptopIntel(selected[0]);
        } else if (out) {
            out.textContent = window.AI_POD?.strings?.comparisonLoading || 'Generating AI comparison…';
            API_MODULE.callAIAgent('compareLaptops', { laptops: selected }, out);
        }
    },
    renderSingleLaptopIntel(laptop) {
        const container = document.getElementById('gemini-comparison-output');
        if (!container) return;
        if (!laptop) {
            container.textContent = 'Select some laptops above to see the AI Bradaa\'s simple comparison...';
            return;
        }
        const escape = value => String(value ?? '').replace(/[&<>]/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[ch]));
        const price = Number.isFinite(laptop.price) ? `RM ${Number(laptop.price).toLocaleString('en-MY')}` : '';
        const specEntries = [
            ['Price', price],
            ['CPU', laptop.cpu],
            ['GPU', laptop.gpu],
            ['RAM', laptop.ram],
            ['Storage', laptop.storage],
            ['Display', laptop.display]
        ].filter(([, value]) => value);
        const scoreOrder = [
            ['ai', 'AI'],
            ['thermals', 'Thermals'],
            ['upgrade', 'Upgrade'],
            ['linux', 'Linux'],
            ['portability', 'Portability'],
            ['value', 'Value']
        ];
        const specList = specEntries.map(([label, value]) => `<li><strong>${escape(label)}</strong>: ${escape(value)}</li>`).join('');
        const scoreList = scoreOrder.map(([key, label]) => {
            const val = laptop.scores?.[key];
            if (!Number.isFinite(val)) return '';
            return `<li><strong>${escape(label)}</strong>: ${escape(val)}</li>`;
        }).filter(Boolean).join('');
        const why = laptop.why ? `<div class="comparison-notes"><p>${escape(laptop.why)}</p></div>` : '';
        container.innerHTML = `
            <div class="comparison-output">
                <div class="comparison-layer">
                    <div class="comparison-overview">
                        <p><strong>${escape(laptop.brand)} ${escape(laptop.model)}</strong> is currently selected. Here is its latest profile.</p>
                    </div>
                    <div class="comparison-cards">
                        <article class="comparison-card">
                            <header><span class="comparison-badge">Specs</span><h3>Core hardware</h3></header>
                            <ul class="comparison-list">
                                ${specList || '<li>No hardware details available.</li>'}
                            </ul>
                        </article>
                        <article class="comparison-card">
                            <header><span class="comparison-badge">Scores</span><h3>AI Bradaa metrics</h3></header>
                            <ul class="comparison-list">
                                ${scoreList || '<li>No score data available.</li>'}
                            </ul>
                        </article>
                    </div>
                    ${why}
                </div>
            </div>
        `;
    },
    renderComparisonOutput(markdown, summary = [], lede = '') {
        const container = document.getElementById('gemini-comparison-output');
        if (!container) return;
        const escape = value => String(value ?? '').replace(/[&<>]/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[ch]));
        const toHTML = (src) => {
            if (!src || typeof src !== 'string') return '';
            const lines = src.split(/\n+/).filter(Boolean);
            const sections = [];
            let current = { heading: '', pros: [], cons: [], extras: [] };
            const pushCurrent = () => {
                if (!current.heading && current.pros.length === 0 && current.cons.length === 0 && !current.extras.length) return;
                sections.push(current); current = { heading: '', pros: [], cons: [], extras: [] };
            };
            const flushList = () => {
                if (!current.extras.length) return;
                current.extras = current.extras.filter(Boolean);
            };
            for (const line of lines) {
                if (/^\s*[-*+]/.test(line)) {
                    const text = line.replace(/^\s*[-*+]\s*/, '');
                    const isPros = /\bpros?\b/i.test(current.heading);
                    const isCons = /\bcons?\b/i.test(current.heading);
                    const target = isPros ? current.pros : isCons ? current.cons : current.extras;
                    target.push(escape(text));
                    continue;
                }
                flushList();
                if (/^#{1,3}\s/.test(line)) {
                    pushCurrent();
                    current.heading = escape(line.replace(/^#{1,3}\s*/, ''));
                } else {
                    current.extras.push(escape(line));
                }
            }
            flushList();
            pushCurrent();
            return sections.map(section => {
                const heading = section.heading ? `<header><div class="comparison-chip">Highlight</div><h3>${section.heading}</h3></header>` : '';
                const pros = section.pros.length ? `<div class="comparison-section"><div class="comparison-chip">Pros</div><ul class="comparison-list">${section.pros.map(item => `<li>${item}</li>`).join('')}</ul></div>` : '';
                const cons = section.cons.length ? `<div class="comparison-section"><div class="comparison-chip">Cons</div><ul class="comparison-list">${section.cons.map(item => `<li>${item}</li>`).join('')}</ul></div>` : '';
                const extras = section.extras.length ? `<div class="comparison-section"><ul class="comparison-list">${section.extras.map(item => `<li>${item}</li>`).join('')}</ul></div>` : '';
                return `<article class="comparison-card">${heading}${pros}${cons}${extras}</article>`;
            }).join('');
        };
        const summaryCards = Array.isArray(summary) && summary.length
            ? `<div class="comparison-cards">${summary.map(item => {
                const headline = escape(item.title || 'Key Insight');
                const badge = escape(item.badge || 'INSIGHT');
                const desc = escape(item.description || item.summary || '');
                return `<article class="comparison-card"><header><span class="comparison-badge">${badge}</span><h3>${headline}</h3></header><p>${desc}</p></article>`;
            }).join('')}</div>`
            : '';
        const overview = lede ? `<div class="comparison-overview"><p>${escape(lede)}</p></div>` : '';
        const body = toHTML(markdown);
        container.innerHTML = `
            <div class="comparison-output">
                ${overview}
                ${summaryCards}
                ${body ? `<div class="comparison-cards">${body}</div>` : ''}
            </div>
        `;
    },
    renderToolkitConsole(toolId) {
        const consoleEl = document.getElementById('toolkit-console');
        if (!consoleEl) return;
        const laptopOptions = STATE.data.allLaptops.map(l => `<option value="${l.model.replace(/"/g, '&quot;')}">${l.model}</option>`).join('');
        const toolUIs = {
          'deal-assassin': `<div class="flex-grow flex flex-col"><label class="mb-2">Product Name:</label><input type="text" id="tool-input-query" placeholder="e.g., Illegear Z7" class="w-full mb-4"><button data-tool-action="deal-assassin" class="action-button mt-auto">✨ Find Best Deal</button></div>`,
          'upgrade-strategist': `<div class="flex-grow flex flex-col"><label class="mb-2">Base Laptop:</label><select id="tool-input-laptop" class="w-full mb-4">${laptopOptions}</select><label class="mb-2">Goal:</label><select id="tool-input-goal" class="w-full mb-4"><option>Run 13B models smoothly</option><option>Maximize storage</option></select><button data-tool-action="upgrade-strategist" class="action-button mt-auto">✨ Get Upgrade Plan</button></div>`,
          'dream-rig-architect': `<div class="flex-grow flex flex-col"><label class="mb-2">Budget (MYR):</label><input type="number" id="tool-input-budget" placeholder="e.g., 8000" class="w-full mb-4"><label class="mb-2">Use:</label><select id="tool-input-use" class="w-full mb-4"><option>AI & CUDA Development</option><option>4K Gaming</option></select><button data-tool-action="dream-rig-architect" class="action-button mt-auto">✨ Architect My Rig</button></div>`,
          'elite-procurement': `<div class="flex-grow flex flex-col"><label class="mb-2">Rare Item:</label><input type="text" id="tool-input-item" placeholder="e.g., Razer Blade 16 Mini-LED" class="w-full mb-4"><button data-tool-action="elite-procurement" class="action-button mt-auto">✨ Initiate Scan</button></div>`,
          'component-recon': `<div class="flex-grow flex flex-col"><label class="mb-2">Component Model:</label><input type="text" id="tool-input-component" placeholder="e.g., Core Ultra 9 185H" class="w-full mb-4"><button data-tool-action="component-recon" class="action-button mt-auto">✨ Run Recon</button></div>`,
          'performance-forecaster': `<div class="flex-grow flex flex-col"><label class="mb-2">Laptop:</label><select id="tool-input-laptop" class="w-full mb-4">${laptopOptions}</select><label class="mb-2">Application:</label><input type="text" id="tool-input-app" placeholder="e.g., Stable Diffusion XL" class="w-full mb-4"><button data-tool-action="performance-forecaster" class="action-button mt-auto">✨ Forecast</button></div>`,
          'system-integrity': `<div class="flex-grow flex flex-col"><label class="mb-2">Issue:</label><textarea id="tool-input-issue" placeholder="e.g., 'BSOD when running PyTorch'" class="w-full mb-4 h-24"></textarea><button data-tool-action="system-integrity" class="action-button mt-auto">✨ Analyze</button></div>`,
          'ecosystem-architect': `<div class="flex-grow flex flex-col"><label class="mb-2">Current Devices:</label><input type="text" id="tool-input-devices" placeholder="e.g., iPhone 15 Pro, iPad Air" class="w-full mb-4"><button data-tool-action="ecosystem-architect" class="action-button mt-auto">✨ Find Best Fit</button></div>`,
          'longevity-analyst': `<div class="flex-grow flex flex-col"><label class="mb-2">Laptop:</label><select id="tool-input-laptop" class="w-full mb-4">${laptopOptions}</select><button data-tool-action="longevity-analyst" class="action-button mt-auto">✨ Analyze Longevity</button></div>`,
          'asset-value': `<div class="flex-grow flex flex-col"><label class="mb-2">Laptop:</label><select id="tool-input-laptop" class="w-full mb-4">${laptopOptions}</select><label class="mb-2">Condition:</label><select id="tool-input-condition" class="w-full mb-4"><option>Like New</option><option>Good</option><option>Fair</option></select><button data-tool-action="asset-value" class="action-button mt-auto">✨ Forecast Value</button></div>`,
          'field-support': `<div class="flex-grow flex flex-col"><label class="mb-2">Query:</label><textarea id="tool-input-query" placeholder="e.g., How to dual-boot Ubuntu?" class="w-full mb-4 h-24"></textarea><button data-tool-action="field-support" class="action-button mt-auto">✨ Request Support</button></div>`,
          'default': `<p class="text-lg text-[var(--c-text-secondary)]">Select a tool to begin operation.</p>`
        };
        consoleEl.innerHTML = `
            ${toolUIs[toolId] || toolUIs['default']}
            <div id="toolkit-output" class="mt-4 p-4 bg-black/50 rounded-lg min-h-[150px] text-sm text-[var(--c-text-secondary)] gemini-output">Output will appear here...</div>
        `;
        consoleEl.classList.remove('console-animating');
        void consoleEl.offsetWidth;
        consoleEl.classList.add('console-animating');

        STATE.ui.toolkit.activeTool = toolId;
        STATE.ui.toolkit.profileKey = TOOLKIT_PROFILES[toolId] ? toolId : 'default';
        STATE.ui.toolkit.lastStage = 'queued';
        UI_MODULE.updateToolkitBriefing('queued');
      },
      initFerrofluid() {
        const gauge = document.getElementById('toolkit-gauge');
        const core = gauge?.querySelector('.toolkit-gauge-ferro');
        if (!gauge || !core) return;
        let rafId = 0; let targetX = 0, targetY = 0; let curX = 0, curY = 0; let pointerMag = 0;
        const ring = document.getElementById('ferro-ring');
        const splashPath = document.getElementById('ferro-splash-main');
        const dropletsRoot = document.getElementById('ferro-splash-droplets');
        const sheensRoot = document.getElementById('ferro-sheen-highlights');
        const overlayRoot = document.getElementById('ferro-overlay-root');
        const spriteRoot = document.getElementById('soul-sprite-root');
        const videoRoot = document.getElementById('soul-video-root');
        const v1 = document.getElementById('soul-video-1');
        const v2 = document.getElementById('soul-video-2');
        let v1Dur = 7.0, v2Dur = 7.0; // seconds (defaults)
        if (v1) v1.addEventListener('loadedmetadata', () => { try { if (v1.duration && isFinite(v1.duration)) v1Dur = v1.duration; } catch {} });
        if (v2) v2.addEventListener('loadedmetadata', () => { try { if (v2.duration && isFinite(v2.duration)) v2Dur = v2.duration; } catch {} });
        let overlayOpacity = 0;
        let lastVideoSyncTs = 0;
        // Smoothed animation state
        let spriteScaleL = 0.62, spriteRotL = 0;
        let videoScaleL = 0.6, videoRotL = 0;
        let fade2Alpha = 0;  // 0 = v1 only, 1 = v2 only
        let useV2State = false;
        // Seamless 14s cycle: 7s Animation 1 then 7s Animation 2
        const phaseDurationsMs = [7000, 7000];
        const totalCycleMs = phaseDurationsMs[0] + phaseDurationsMs[1];
        const cycleOrigin = performance.now();
        let lastFrameTs = performance.now();
        let sheens = [];
        if (ring) ring.replaceChildren();
        if (dropletsRoot) dropletsRoot.replaceChildren();
        const svgNS = 'http://www.w3.org/2000/svg';
        const spikes = [];
        const N = 64; // number of spikes for outer ring (denser)
        const cx = 120, cy = 120; // ring viewBox center (with expanded viewBox)
        const R = 100; // base radius (slightly smaller to avoid edge)
        const MAX_R = 152; // hard cap to keep within border
        for (let i = 0; i < N; i++) {
          const theta = (i / N) * Math.PI * 2;
          const x1 = cx + Math.cos(theta) * R;
          const y1 = cy + Math.sin(theta) * R;
          const x2 = cx + Math.cos(theta) * (R + 14);
          const y2 = cy + Math.sin(theta) * (R + 14);
          const lOuter = document.createElementNS(svgNS, 'line');
          lOuter.setAttribute('x1', x1.toFixed(2));
          lOuter.setAttribute('y1', y1.toFixed(2));
          lOuter.setAttribute('x2', x2.toFixed(2));
          lOuter.setAttribute('y2', y2.toFixed(2));
          lOuter.setAttribute('stroke-width', '3');
          lOuter.setAttribute('class', 'spike');
          ring?.appendChild(lOuter);
          const lCore = document.createElementNS(svgNS, 'line');
          lCore.setAttribute('x1', x1.toFixed(2));
          lCore.setAttribute('y1', y1.toFixed(2));
          lCore.setAttribute('x2', x2.toFixed(2));
          lCore.setAttribute('y2', y2.toFixed(2));
          lCore.setAttribute('stroke-width', '4.2');
          lCore.setAttribute('class', 'spike spike-core');
          ring?.appendChild(lCore);
          spikes.push({ theta, lOuter, lCore, seed: Math.random() * 2 - 1, lengthScale: 1.35 + Math.random() * 0.25 });
        }

        // Qibla (Kaabah) marker -------------------------------------------
        const aiPod = window.AI_POD || {};
        const features = aiPod.features || {};
        const qiblaEnabled = features.hasOwnProperty('qibla') ? !!features.qibla : true;
        const overlayEnabled = features.hasOwnProperty('soulPngOverlay') ? !!features.soulPngOverlay : true;
        const videoEnabled = features.hasOwnProperty('soulVideo') ? !!features.soulVideo : true;
        const registerSoulBridge = () => {
          const install = () => {
            if (!window.AI_POD) return false;
            const soulAPI = {
              setStage(stage, ctx) {
                if (!stage) return stage;
                UI_MODULE.updateToolkitBriefing(stage, ctx);
                return stage;
              },
              setProgress(value) {
                UI_MODULE.setSoulProgress(value);
                return STATE.ui.toolkit.progress;
              },
              setCollapsed(flag) {
                UI_MODULE.toggleToolkitCollapsed(!!flag);
              },
              ensureExpanded() {
                UI_MODULE.ensureToolkitExpanded();
              }
            };
            window.AI_POD.soul = { ...(window.AI_POD.soul || {}), ...soulAPI };
            return true;
          };
          if (!install()) {
            let attempts = 0;
            const timer = setInterval(() => {
              attempts += 1;
              if (install() || attempts > 40) clearInterval(timer);
            }, 120);
          }
        };
        registerSoulBridge();
        if (videoEnabled && STATE.ui.toolkit.collapsed !== true) {
          UI_MODULE.toggleToolkitCollapsed(true);
        }
        if (videoEnabled) core?.classList.add('soul-video-mode'); else core?.classList.remove('soul-video-mode');
        if (videoRoot) videoRoot.style.opacity = videoEnabled ? '1' : '0';
        const ensurePlay = (vid) => { try { const p = vid?.play?.(); if (p && typeof p.then === 'function') p.catch(()=>{}); } catch(_) {} };
        if (videoEnabled) {
          // Enforce inline, muted, loop for fluid autoplay across browsers
          try {
            [v1, v2].forEach(v => { if (!v) return; v.muted = true; v.loop = true; v.playsInline = true; v.playbackRate = 1.0; });
          } catch {}
          ensurePlay(v1); ensurePlay(v2);
        }
        if (overlayRoot) {
          if (overlayEnabled) {
            overlayRoot.dataset.enabled = 'true';
            overlayOpacity = 0;
            overlayRoot.setAttribute('aria-hidden', 'false');
            overlayRoot.style.opacity = '0';
            overlayRoot.style.transform = 'translate(-50%, -50%) scale(1)';
          } else {
            overlayRoot.dataset.enabled = 'false';
            overlayOpacity = 0;
            overlayRoot.style.opacity = '0';
            overlayRoot.style.transform = 'translate(-50%, -50%) scale(1)';
            overlayRoot.setAttribute('aria-hidden', 'true');
          }
        }
        let qiblaAngleDeg = null; // bearing from North
        let headingDeg = 0;       // device heading if available
        let qiblaG = null;
        if (ring && qiblaEnabled) {
          qiblaG = document.createElementNS(svgNS, 'g');
          qiblaG.setAttribute('id', 'qibla-marker');
          qiblaG.setAttribute('aria-label', 'Qibla direction');
          // Simple Kaabah-like cube with golden band
          const body = document.createElementNS(svgNS, 'rect');
          body.setAttribute('x', '-5'); body.setAttribute('y', '-5');
          body.setAttribute('width', '10'); body.setAttribute('height', '10');
          body.setAttribute('rx', '1.2');
          body.setAttribute('class', 'qibla-marker');
          const band = document.createElementNS(svgNS, 'rect');
          band.setAttribute('x', '-5'); band.setAttribute('y', '-1');
          band.setAttribute('width', '10'); band.setAttribute('height', '2');
          band.setAttribute('class', 'qibla-marker-band');
          qiblaG.appendChild(body); qiblaG.appendChild(band);
          qiblaG.style.opacity = '0';
          ring.appendChild(qiblaG);
        }

        function toRad(d){ return d * Math.PI / 180; }
        function toDeg(r){ return r * 180 / Math.PI; }
        function normalizeDeg(d){ return (d % 360 + 360) % 360; }
        function bearingToKaabah(lat1, lon1){
          const lat2 = toRad(21.4225), lon2 = toRad(39.8262); // Kaabah
          const φ1 = toRad(lat1), λ1 = toRad(lon1);
          const y = Math.sin(lon2 - λ1) * Math.cos(lat2);
          const x = Math.cos(φ1)*Math.sin(lat2) - Math.sin(φ1)*Math.cos(lat2)*Math.cos(lon2 - λ1);
          return normalizeDeg(toDeg(Math.atan2(y, x)));
        }
        let qScale = 1;
        function updateQiblaMarker(){
          if (!qiblaG || qiblaAngleDeg == null) return;
          const displayDeg = normalizeDeg(qiblaAngleDeg - headingDeg);
          const a = toRad(displayDeg);
          const r = R + 18; // slightly outside ring
          const x = cx + Math.sin(a) * r; // SVG y+ down; use sin/cos swapped for 0° at top
          const y = cy - Math.cos(a) * r;
          qiblaG.setAttribute('transform', `translate(${x.toFixed(1)} ${y.toFixed(1)}) rotate(${displayDeg.toFixed(1)}) scale(${qScale.toFixed(3)})`);
          qiblaG.style.opacity = '0.75';
        }
        if (navigator.geolocation && qiblaEnabled) {
          navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords || {};
            if (Number.isFinite(latitude) && Number.isFinite(longitude)) {
              qiblaAngleDeg = bearingToKaabah(latitude, longitude);
              updateQiblaMarker();
            }
          }, () => {}, { enableHighAccuracy: true, timeout: 6000, maximumAge: 300000 });
        }
        // Device heading (best-effort)
        try {
          window.addEventListener('deviceorientation', (e) => {
            const h = (e.webkitCompassHeading != null) ? e.webkitCompassHeading : (typeof e.alpha === 'number' ? 360 - e.alpha : 0);
            if (Number.isFinite(h)) { headingDeg = normalizeDeg(h); updateQiblaMarker(); }
          }, true);
        } catch {}
        const splashPoints = [];
        const icx = 100, icy = 100; // splash viewBox center (0..200)
        if (splashPoints) {
          const pointCount = 64;
          for (let i = 0; i < pointCount; i++) {
            const theta = (i / pointCount) * Math.PI * 2;
            splashPoints.push({
              theta,
              base: 24 + Math.random() * 12,
              magnetGain: 46 + Math.random() * 34,
              variance: 10 + Math.random() * 16,
              wobble: 0.06 * (Math.random() * 2 - 1),
              speed: 0.9 + Math.random() * 0.7,
              seed: Math.random() * 6.28,
              radius: 0
            });
          }
        }
        const droplets = [];
        if (droplets && dropletsRoot) {
          const dropletCount = 16;
          for (let i = 0; i < dropletCount; i++) {
            const droplet = document.createElementNS(svgNS, 'ellipse');
            droplet.setAttribute('class', 'splash-droplet');
            const baseRx = 5 + Math.random() * 8;
            const baseRy = 3.5 + Math.random() * 5;
            droplet.setAttribute('rx', baseRx.toFixed(2));
            droplet.setAttribute('ry', baseRy.toFixed(2));
            dropletsRoot.appendChild(droplet);
            droplets.push({
              el: droplet,
              baseOrbit: 20 + Math.random() * 30,
              orbitGain: 26 + Math.random() * 30,
              phase: Math.random() * Math.PI * 2,
              speed: 0.9 + Math.random() * 1.2,
              wobble: 0.6 + Math.random() * 0.5,
              seed: Math.random() * 6.28,
              baseRx,
              baseRy,
              lastScale: 1
            });
          }
        }
        let magnetAngle = 0;
        let magnetTargetAngle = 0;
        let pointerActive = false;
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const maxDrift = prefersReduced ? 6 : 12;
        
        // 21 randomized animation patterns
        const animationPatterns = [
          { frequency: 1.2, amplitude: 0.8, phase: 0, wobble: 1.0 },
          { frequency: 1.8, amplitude: 1.2, phase: Math.PI/3, wobble: 0.7 },
          { frequency: 0.9, amplitude: 1.5, phase: Math.PI/2, wobble: 1.3 },
          { frequency: 2.1, amplitude: 0.6, phase: Math.PI, wobble: 0.9 },
          { frequency: 1.5, amplitude: 1.1, phase: Math.PI*1.5, wobble: 1.1 },
          { frequency: 0.7, amplitude: 1.4, phase: Math.PI/4, wobble: 1.2 },
          { frequency: 2.3, amplitude: 0.9, phase: Math.PI*0.75, wobble: 0.8 },
          { frequency: 1.1, amplitude: 1.3, phase: Math.PI*1.25, wobble: 1.4 },
          { frequency: 1.9, amplitude: 0.7, phase: Math.PI/6, wobble: 0.6 },
          { frequency: 0.8, amplitude: 1.6, phase: Math.PI*1.8, wobble: 1.5 },
          { frequency: 2.0, amplitude: 1.0, phase: Math.PI/5, wobble: 1.0 },
          { frequency: 1.4, amplitude: 1.2, phase: Math.PI*0.6, wobble: 1.1 },
          { frequency: 0.6, amplitude: 1.7, phase: Math.PI*1.4, wobble: 1.6 },
          { frequency: 2.2, amplitude: 0.8, phase: Math.PI/7, wobble: 0.7 },
          { frequency: 1.3, amplitude: 1.4, phase: Math.PI*1.1, wobble: 1.3 },
          { frequency: 1.7, amplitude: 0.9, phase: Math.PI*0.8, wobble: 0.9 },
          { frequency: 0.9, amplitude: 1.5, phase: Math.PI/8, wobble: 1.2 },
          { frequency: 2.4, amplitude: 0.7, phase: Math.PI*1.6, wobble: 0.8 },
          { frequency: 1.6, amplitude: 1.1, phase: Math.PI*0.9, wobble: 1.0 },
          { frequency: 0.5, amplitude: 1.8, phase: Math.PI/9, wobble: 1.7 },
          { frequency: 2.5, amplitude: 0.5, phase: Math.PI*1.7, wobble: 0.6 }
        ];
        let currentPattern = 0;
        let patternStartTime = performance.now();
        const animate = () => {
          const now = performance.now();
          const dt = Math.min(0.05, Math.max(0.016, (now - lastFrameTs) / 1000));
          lastFrameTs = now;
          const cursorLerp = pointerActive ? Math.min(0.45, 0.18 + 0.42 * pointerMag) : 0.12;
          curX += (targetX - curX) * cursorLerp;
          curY += (targetY - curY) * cursorLerp;
          core.style.setProperty('--mx', `${curX.toFixed(2)}px`);
          core.style.setProperty('--my', `${curY.toFixed(2)}px`);
          
          // Pattern rotation every 3-7 seconds
          const patternDuration = 3000 + (currentPattern % 3) * 1500;
          if (now - patternStartTime > patternDuration) {
            currentPattern = (currentPattern + 1 + Math.floor(Math.random() * 3)) % animationPatterns.length;
            patternStartTime = now;
          }
          
          const pattern = animationPatterns[currentPattern];
          const t = now / 1000;
          
          // Enhanced magnet orbit with pattern variation
          if (!pointerActive) {
            magnetTargetAngle = (t * 0.9 * pattern.frequency + pattern.phase) % (Math.PI * 2);
          }
          magnetAngle += (magnetTargetAngle - magnetAngle) * (0.06 + pattern.wobble * 0.02);
          if (!Number.isFinite(magnetAngle)) magnetAngle = 0;
          
          const stage = gauge.getAttribute('data-stage') || 'queued';
          const progress = ({ queued: 0.08, running: Math.min(0.9, 0.6), success: 0.98, error: 0.12 })[stage] ?? 0.08;
          const magnetStrength = (0.4 + progress * 0.45 + (pointerActive ? 0.35 : 0)) * pattern.amplitude;
          const ampBase = 8 + 28 * progress; // constrained spikes
          const uniformity = progress; // spikes get more uniform near completion
          const patternWave = Math.sin(t * pattern.frequency + pattern.phase) * pattern.wobble;
          // Animate sprite center (PNG) — scale with progress, pulse, gentle rotation
          if (spriteRoot && !videoEnabled) {
            const breatheSprite = (Math.sin(t * 1.45 * pattern.frequency) + 1) * 0.5;
            const sBase = 0.62 + progress * 0.32; // grows toward completion, but contained
            const sPulse = 1 + 0.028 * Math.sin(t * 2.1 + pattern.phase) + 0.022 * breatheSprite;
            const sWanted = Math.min(0.98, sBase * sPulse);
            const rotWanted = toDeg(magnetAngle) * 0.22 + patternWave * 12;
            const sK = prefersReduced ? 0.12 : (0.18 + 0.22 * pointerMag);
            const rK = prefersReduced ? 0.1  : (0.14 + 0.18 * pointerMag);
            spriteScaleL += (sWanted - spriteScaleL) * sK;
            spriteRotL   += (rotWanted - spriteRotL) * rK;
            spriteRoot.style.transform = `translate(-50%, -50%) rotate(${spriteRotL.toFixed(2)}deg) scale(${spriteScaleL.toFixed(3)})`;
            spriteRoot.style.opacity = (0.7 + 0.25 * progress).toFixed(2);
          }
          // Animate video center similarly and cross-fade between v1 and v2
          if (videoRoot && videoEnabled) {
            const breatheV = (Math.sin(t * 1.5 * pattern.frequency) + 1) * 0.5;
            const sBase = 0.6 + progress * 0.34;
            const sPulse = 1 + 0.025 * Math.sin(t * 2.0 + pattern.phase) + 0.02 * breatheV;
            const sWanted = Math.min(0.98, sBase * sPulse);
            const rotWanted = toDeg(magnetAngle) * 0.18 + patternWave * 10;
            const sK = prefersReduced ? 0.12 : (0.18 + 0.22 * pointerMag);
            const rK = prefersReduced ? 0.1  : (0.14 + 0.18 * pointerMag);
            videoScaleL += (sWanted - videoScaleL) * sK;
            videoRotL   += (rotWanted - videoRotL) * rK;
            videoRoot.style.transform = `translate(-50%, -50%) rotate(${videoRotL.toFixed(2)}deg) scale(${videoScaleL.toFixed(3)})`;
            videoRoot.style.opacity = (0.78 + 0.22 * progress).toFixed(2);
            // Sequential loop: 7s Animation 1 then 7s Animation 2
            const nowPerf = performance.now();
            const cycleElapsed = (nowPerf - cycleOrigin) % totalCycleMs;
            const inSecondHalf = cycleElapsed >= phaseDurationsMs[0];
            const phaseIdx = inSecondHalf ? 1 : 0;
            const phaseElapsed = inSecondHalf ? (cycleElapsed - phaseDurationsMs[0]) : cycleElapsed;
            const phaseDuration = phaseDurationsMs[phaseIdx] || 1;
            const phaseProgress = Math.min(1, Math.max(0, phaseElapsed / phaseDuration));
            const activeVideo = phaseIdx === 0 ? v1 : v2;
            const activeDuration = phaseIdx === 0 ? v1Dur : v2Dur;
            useV2State = phaseIdx === 1;
            if (activeVideo && isFinite(activeDuration) && activeDuration > 0.1) {
              const desiredSeconds = phaseProgress * activeDuration;
              const currentSeconds = activeVideo.currentTime || 0;
              if (Math.abs(currentSeconds - desiredSeconds) > 0.05) {
                try {
                  if (typeof activeVideo.fastSeek === 'function') activeVideo.fastSeek(desiredSeconds);
                  else activeVideo.currentTime = desiredSeconds;
                } catch {}
              }
            }
            const transitionMs = 400;
            let target2;
            if (cycleElapsed < phaseDurationsMs[0] - transitionMs) target2 = 0;
            else if (cycleElapsed > phaseDurationsMs[0] + transitionMs) target2 = 1;
            else {
              const span = transitionMs * 2;
              target2 = Math.min(1, Math.max(0, 0.5 + (cycleElapsed - phaseDurationsMs[0]) / span));
            }
            const fadeK = prefersReduced ? 0.08 : (pointerActive ? 0.22 : 0.14);
            fade2Alpha += (target2 - fade2Alpha) * fadeK;
            fade2Alpha = Math.max(0, Math.min(1, fade2Alpha));
            if (v2) v2.style.opacity = fade2Alpha.toFixed(3);
            if (v1) v1.style.opacity = (1 - fade2Alpha).toFixed(3);
            if (useV2State) ensurePlay(v2); else ensurePlay(v1);
            // Periodically sync video clocks to avoid drift (AI Bradaa Soul prototype v1)
            const nowTs = performance.now();
            if (nowTs - lastVideoSyncTs > 1500 && v1 && v2 && !prefersReduced) {
              try {
                const d = Math.abs((v1.currentTime || 0) - (v2.currentTime || 0));
                if (d > 0.2) {
                  const master = useV2State ? v2 : v1;
                  const slave = useV2State ? v1 : v2;
                  if (typeof slave.fastSeek === 'function') slave.fastSeek(master.currentTime);
                  else slave.currentTime = master.currentTime;
                }
              } catch {}
              lastVideoSyncTs = nowTs;
            }
          }
          // On first pointer interaction, (re)try to play (iOS autoplay guard)
          if (videoEnabled && pointerActive) { ensurePlay(v1); ensurePlay(v2); }
          if (overlayRoot && overlayRoot.dataset.enabled === 'true') {
            const overlayScale = (1.0 + 0.06 * progress + 0.05 * Math.sin(t * 1.4 + pattern.phase));
            const overlayRotate = (toDeg(magnetAngle) * 0.6 + patternWave * 22);
            overlayRoot.style.transform = `translate(-50%, -50%) rotate(${overlayRotate.toFixed(2)}deg) scale(${overlayScale.toFixed(3)})`;
            const targetOpacity = Math.min(0.88, 0.3 + progress * 0.5 + (pointerActive ? 0.16 : 0));
            overlayOpacity += (targetOpacity - overlayOpacity) * 0.16;
            overlayRoot.style.opacity = overlayOpacity.toFixed(3);
          }
          for (const s of spikes) {
            const d = Math.atan2(Math.sin(s.theta - magnetAngle), Math.cos(s.theta - magnetAngle));
            const pull = Math.max(0, 1 - Math.abs(d) / (Math.PI / 4)); // local magnet window
            const jitter = (Math.sin(t * 2.2 + s.seed * 7.3) + 1) * 0.5; // 0..1
            const lenBase = 10 + ampBase * (0.55 * pull + (1 - uniformity) * 0.25 * jitter);
            const len = Math.min(42, lenBase * (s.lengthScale || 1.0));
            const x1 = cx + Math.cos(s.theta) * R;
            const y1 = cy + Math.sin(s.theta) * R;
            const r2 = Math.min(R + len, MAX_R);
            const x2 = cx + Math.cos(s.theta) * r2;
            const y2 = cy + Math.sin(s.theta) * r2;
            s.lOuter.setAttribute('x1', x1.toFixed(2));
            s.lOuter.setAttribute('y1', y1.toFixed(2));
            s.lOuter.setAttribute('x2', x2.toFixed(2));
            s.lOuter.setAttribute('y2', y2.toFixed(2));
            s.lCore.setAttribute('x1', x1.toFixed(2));
            s.lCore.setAttribute('y1', y1.toFixed(2));
            s.lCore.setAttribute('x2', x2.toFixed(2));
            s.lCore.setAttribute('y2', y2.toFixed(2));
          }
          // Core inner lights (organic glow)
          const lightsRoot = core.querySelector('#core-lights');
          if (lightsRoot && !lightsRoot.hasChildNodes()) {
            for (let i = 0; i < 6; i++) {
              const c = document.createElementNS(svgNS, 'circle');
              c.setAttribute('r', (3 + Math.random() * 2).toFixed(1));
              c.setAttribute('fill', 'var(--ferro-glow)');
              c.style.opacity = '0.55';
              c.style.filter = 'blur(2px) drop-shadow(0 0 8px var(--ferro-glow))';
              lightsRoot.appendChild(c);
            }
          }
          if (lightsRoot) {
            let i = 0;
            lightsRoot.childNodes.forEach((c) => {
              const ang = t * (0.8 + i * 0.15) + i;
              const rad = 12 + 6 * Math.sin(t * 1.3 + i * 0.7) * (0.6 + 0.4 * progress);
              const x = 100 + Math.cos(ang) * rad;
              const y = 100 + Math.sin(ang) * (rad * 0.85);
              c.setAttribute('cx', x.toFixed(1));
              c.setAttribute('cy', y.toFixed(1));
              i++;
            });
          }
          // Update Qibla marker if present
          updateQiblaMarker();
          // Venom splash body animation with pattern variation
          if (splashPoints && splashPoints.length && splashPath) {
            let dPath = '';
            const breathe = (Math.sin(t * 1.6 * pattern.frequency) + 1) * 0.5;
            splashPoints.forEach((pt, idx) => {
              const dd = Math.atan2(Math.sin(pt.theta - magnetAngle), Math.cos(pt.theta - magnetAngle));
              const magnetPull = Math.max(0, 1 - Math.abs(dd) / (Math.PI / 3.2));
              const noise = Math.sin(t * pt.speed * pattern.frequency + pt.seed * 2.1 + patternWave);
              const wobble = Math.sin(t * 1.2 * pattern.frequency + pt.seed * 3.5 + pattern.phase) * pt.wobble * (0.7 + progress * 0.3) * pattern.amplitude;
              const cursorInfluence = pointerActive ? Math.exp(-Math.abs(dd) * 2) * 0.4 : 0;
              const targetRadius = pt.base + pt.magnetGain * magnetPull * magnetStrength + pt.variance * noise * (0.2 + 0.8 * progress) + breathe * 18 * (0.28 + progress * 0.72) + cursorInfluence * 25;
              pt.radius += (targetRadius - pt.radius) * (0.24 + cursorInfluence * 0.16); // faster response near cursor
              const angle = pt.theta + wobble;
              const x = icx + Math.cos(angle) * pt.radius;
              const y = icy + Math.sin(angle) * pt.radius;
              const prev = splashPoints[(idx - 1 + splashPoints.length) % splashPoints.length];
              const next = splashPoints[(idx + 1) % splashPoints.length];
              const prevAngle = prev.theta + Math.sin(t * 1.25 + prev.seed) * prev.wobble * (0.8 + progress * 0.2);
              const nextAngle = next.theta + Math.sin(t * 1.25 + next.seed) * next.wobble * (0.8 + progress * 0.2);
              const prevRadius = (prev.radius || prev.base) * (0.9 + 0.1 * progress);
              const nextRadius = (next.radius || next.base) * (0.9 + 0.1 * progress);
              const ctrl1x = icx + Math.cos(prevAngle) * prevRadius;
              const ctrl1y = icy + Math.sin(prevAngle) * prevRadius;
              const ctrl2x = icx + Math.cos(nextAngle) * nextRadius;
              const ctrl2y = icy + Math.sin(nextAngle) * nextRadius;
              const segment = `C ${(ctrl1x * 2 + x) / 3} ${(ctrl1y * 2 + y) / 3} ${(ctrl2x * 2 + x) / 3} ${(ctrl2y * 2 + y) / 3} ${x} ${y}`;
              if (idx === 0) {
                dPath = `M ${x.toFixed(1)} ${y.toFixed(1)}`;
              } else {
                dPath += ` ${segment.replace(/(\d+\.\d+)/g, m => Number(m).toFixed(1))}`;
              }
            });
            if (dPath) {
              dPath += ' Z';
              splashPath.setAttribute('d', dPath);
            }
            // Setup sheen elements once
            if (sheensRoot && sheens.length === 0) {
              for (let i = 0; i < 6; i++) {
                const p = document.createElementNS(svgNS, 'path');
                p.setAttribute('class', 'sheen');
                sheensRoot.appendChild(p);
                sheens.push(p);
              }
            }
            // Update sheen arcs along bright normals (toward top-right light)
            if (sheens.length) {
              const baseIndex = Math.floor(((normalizeDeg(toDeg(magnetAngle)) / 360) * splashPoints.length) % splashPoints.length);
              for (let i = 0; i < sheens.length; i++) {
                const idx0 = (baseIndex + i * Math.floor(splashPoints.length / sheens.length)) % splashPoints.length;
                const idx1 = (idx0 + 1) % splashPoints.length;
                const p0 = splashPoints[idx0]; const p1 = splashPoints[idx1];
                const a0 = p0.theta; const a1 = p1.theta;
                const r0 = p0.radius || p0.base; const r1 = p1.radius || p1.base;
                const x0 = icx + Math.cos(a0) * r0; const y0 = icy + Math.sin(a0) * r0;
                const x1p = icx + Math.cos(a1) * r1; const y1p = icy + Math.sin(a1) * r1;
                const cx1 = (x0 + x1p) / 2 + Math.cos(a0 + a1) * 2;
                const cy1 = (y0 + y1p) / 2 + Math.sin(a0 + a1) * 2;
                sheens[i].setAttribute('d', `M ${x0.toFixed(1)} ${y0.toFixed(1)} Q ${cx1.toFixed(1)} ${cy1.toFixed(1)} ${x1p.toFixed(1)} ${y1p.toFixed(1)}`);
                sheens[i].style.opacity = (0.55 + 0.35 * Math.sin(t * 2 + i)).toFixed(2);
              }
            }
          }
          // Enhanced droplet animation (venom tendrils) with pattern variation
          if (droplets && droplets.length) {
            droplets.forEach(drop => {
              const orbit = drop.baseOrbit + drop.orbitGain * progress;
              const patternModifiedAngle = drop.phase + t * drop.speed * pattern.frequency + magnetAngle * 0.88 + pattern.phase;
              const wobble = Math.sin(t * 2.6 * pattern.frequency + drop.seed * 3.5 + patternWave) * drop.wobble * (0.3 + progress * 0.7) * pattern.amplitude;
              const spiral = (8 + 22 * progress) * pattern.wobble;
              const x = icx + Math.cos(patternModifiedAngle) * (orbit + wobble * 12) + Math.cos(patternModifiedAngle * 1.6 + drop.seed) * spiral * 0.45;
              const y = icy + Math.sin(patternModifiedAngle) * (orbit + wobble * 9.5) + Math.sin(patternModifiedAngle * 1.5 + drop.seed) * spiral * 0.38;
              drop.el.setAttribute('cx', x.toFixed(1));
              drop.el.setAttribute('cy', y.toFixed(1));
              const scaleTarget = 0.72 + progress * 0.95 + 0.32 * Math.sin(t * 3.2 + drop.seed * 5.3);
              drop.lastScale += (scaleTarget - drop.lastScale) * 0.2;
              drop.el.setAttribute('transform', `rotate(${(patternModifiedAngle * 180 / Math.PI).toFixed(1)} ${x.toFixed(1)} ${y.toFixed(1)})`);
              drop.el.setAttribute('rx', (drop.baseRx * drop.lastScale).toFixed(2));
              drop.el.setAttribute('ry', (drop.baseRy * (0.58 + 0.42 * progress)).toFixed(2));
            });
          }
          rafId = requestAnimationFrame(animate);
        };
        let requestedOrientationPermission = false;
        const updateTarget = (e) => {
          const rect = gauge.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          const dx = Math.max(-1, Math.min(1, (e.clientX - cx) / (rect.width / 2)));
          const dy = Math.max(-1, Math.min(1, (e.clientY - cy) / (rect.height / 2)));
          pointerMag = Math.min(1, Math.hypot(dx, dy));
          targetX = dx * maxDrift; targetY = dy * maxDrift;
          magnetTargetAngle = Math.atan2(dy, dx);
          pointerActive = true;
          if (!requestedOrientationPermission && window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
            requestedOrientationPermission = true;
            try { DeviceOrientationEvent.requestPermission().catch(() => {}); } catch {}
          }
        };
        const reset = () => { targetX = 0; targetY = 0; pointerActive = false; };
        const onVisibilityChange = () => {
          if (document.hidden) {
            if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
          } else if (!rafId) {
            lastFrameTs = performance.now();
            rafId = requestAnimationFrame(animate);
          }
        };
        gauge.addEventListener('pointermove', updateTarget, { passive: true });
        gauge.addEventListener('pointerleave', reset, { passive: true });
        document.addEventListener('visibilitychange', onVisibilityChange);
        if (!rafId) rafId = requestAnimationFrame(animate);
      }
  };
  
  // --- APP CONTROLLER & INITIALIZATION --------------------------------------
  const APP = {
      computeFilteredSet(limit = 35) {
        const { price, platform, brand, sort } = STATE.ui.app;
        if (!Array.isArray(STATE.data.allLaptops) || STATE.data.allLaptops.length === 0) return [];
        // Start with most recent models first
        const recentFirst = [...STATE.data.allLaptops]
          .sort((a, b) => APP.deriveProductionYear(b.model) - APP.deriveProductionYear(a.model));
        // Apply primary filters
        let data = recentFirst.filter(d =>
          Number.isFinite(d.price) && d.price >= STATE.config.priceMin && d.price <= Math.min(price, STATE.config.priceMax) &&
          (platform === 'All' || d.platform === platform) &&
          (brand === 'All' || d.brand === brand)
        );
        // Sort by selected knob
        const sorter = {
          price_asc: (a, b) => a.price - b.price,
          price_desc: (a, b) => b.price - a.price,
          score_desc: (a, b) => b.score - a.score,
          value_desc: (a, b) => (b.value_rating || 0) - (a.value_rating || 0)
        };
        data.sort(sorter[sort] || sorter.score_desc);
        // Explorer gets a cap; Appendices passes null/undefined for full list
        return (typeof limit === 'number' && isFinite(limit)) ? data.slice(0, limit) : data;
      },
      deriveProductionYear(model) {
        const m = /\((20\d{2})\)/.exec(String(model));
        const y = m ? Number(m[1]) : new Date().getFullYear();
        return Number.isFinite(y) ? y : new Date().getFullYear();
      },
      computeCycleYears(laptop) {
        const nowY = new Date().getFullYear();
        const y = APP.deriveProductionYear(laptop.model);
        const age = Math.max(0, nowY - y);
        const base = 3; // minimum policy
        const bonus = (Number(laptop?.scores?.upgrade||0) + Number(laptop?.scores?.ai||0) + Number(laptop?.scores?.thermals||0)) / 30; // 0..1
        const projected = Math.min(6, base + bonus * 2); // cap 6 years
        const remaining = Math.max(3, projected - age);
        return Number(remaining.toFixed(1));
      },
      computeAppendixSet(limit = 65) {
        const toKey = (item) => `${String(item?.brand || '').toLowerCase()}|${String(item?.model || '').toLowerCase()}`;
        const filteredRaw = APP.computeFilteredSet(null);
        const filtered = Array.isArray(filteredRaw) ? filteredRaw : [];
        const seen = new Set();
        const deduped = [];
        for (const item of filtered) {
          if (!item) continue;
          const key = toKey(item);
          if (seen.has(key)) continue;
          seen.add(key);
          deduped.push(item);
        }
        return (typeof limit === 'number' && isFinite(limit)) ? deduped.slice(0, limit) : deduped;
      },
      computeShortlistSet(limit = 35) {
        const toKey = (item) => `${String(item?.brand || '').toLowerCase()}|${String(item?.model || '').toLowerCase()}`;
        const shortlistSource = Array.isArray(STATE.data.rankedSource.shortlist35) ? STATE.data.rankedSource.shortlist35 : [];
        const shortlistKeys = new Set(shortlistSource.map(toKey));
        const filteredRaw = APP.computeFilteredSet(null);
        const filtered = Array.isArray(filteredRaw) ? filteredRaw : [];
        const shortlist = [];
        const seen = new Set();
        for (const item of filtered) {
          if (!item) continue;
          const key = toKey(item);
          if (shortlistKeys.size > 0 && !shortlistKeys.has(key)) continue;
          if (seen.has(key)) continue;
          seen.add(key);
          shortlist.push(item);
        }
        if (shortlist.length) {
          return (typeof limit === 'number' && isFinite(limit)) ? shortlist.slice(0, limit) : shortlist;
        }
        return APP.computeFilteredSet(limit);
      },
      findLaptopByKey(identifier) {
        if (!identifier) return null;
        const [brandRaw, modelRaw] = String(identifier).split('|');
        const brand = (brandRaw || '').trim().toLowerCase();
        const model = (modelRaw || '').trim().toLowerCase();
        if (!brand && !model) return null;

        const toKey = (item) => `${String(item?.brand || '').trim().toLowerCase()}|${String(item?.model || '').trim().toLowerCase()}`;
        const searchPools = [
          ...(Array.isArray(STATE.data.rankedSource.top10) ? STATE.data.rankedSource.top10 : []),
          ...(Array.isArray(STATE.data.rankedSource.shortlist35) ? STATE.data.rankedSource.shortlist35 : []),
          ...(Array.isArray(STATE.data.rankedSource.appendix65) ? STATE.data.rankedSource.appendix65 : []),
          ...(Array.isArray(STATE.data.allLaptops) ? STATE.data.allLaptops : []),
          ...(Array.isArray(STATE.data.fallbackLaptops) ? STATE.data.fallbackLaptops : [])
        ];

        for (const entry of searchPools) {
          if (!entry) continue;
          const key = toKey(entry);
          if (!key) continue;
          if (brand && model) {
            if (key === `${brand}|${model}`) return entry;
          } else if (brand && key.startsWith(`${brand}|`)) {
            return entry;
          } else if (model && key.endsWith(`|${model}`)) {
            return entry;
          }
        }
        return null;
      },
      computeTopPicks(data) {
        if (!Array.isArray(data) || !data.length) return [];
        const seg = STATE.ui.app.segment || 'All';
        const filtered = seg === 'All' ? data : data.filter(d => API_MODULE.hasSegment(d, seg));
        if (!filtered.length) return [];
        const vals = filtered.map(d => d.value_rating || 0);
        const minVal = Math.min(...vals, 0), maxVal = Math.max(...vals, 1);
        const norm = (v, min, max) => max > min ? (v - min) / (max - min) : 0;
        const weights = API_MODULE.getUseCaseWeights(seg);
        const scored = filtered.map(d => {
          const rel = APP.computeCycleYears(d);
          const relNorm = norm(rel, 3, 6);
          const valNorm = norm(d.value_rating || 0, minVal, maxVal);
          const scoreN = Number(d.score) / 100;
          const aiN = Number(d?.scores?.ai || 0) / 10;
          const thermN = Number(d?.scores?.thermals || 0) / 10;
          const portN = Number(d?.scores?.portability || 0) / 10;
          const combined = (weights.score * scoreN) + (weights.value * valNorm) + (weights.rel * relNorm)
                         + (weights.ai * aiN) + (weights.thermals * thermN) + (weights.portability * portN);
          return { ...d, relYears: rel, _rankScore: combined };
        }).sort((a, b) => b._rankScore - a._rankScore);
        return scored.slice(0, 3);
      },
      setupEventListeners() {
        const markInteract = () => { STATE.ui.app.interacted = true; };
        const resetMissionPicks = () => {
          STATE.ui.app.missionPickReady = false;
          STATE.ui.app.missionPicks = [];
        };
        document.getElementById('price-filter')?.addEventListener('input', e => {
          STATE.ui.app.price = Number(e.target.value);
          document.getElementById('price-value').textContent = e.target.value;
          resetMissionPicks();
          markInteract();
          UI_MODULE.renderAll();
        });
        document.querySelectorAll('.platform-filter').forEach(btn => btn.addEventListener('click', () => {
          document.querySelector('.platform-filter.active')?.classList.remove('active');
          btn.classList.add('active');
          STATE.ui.app.platform = btn.dataset.platform;
          resetMissionPicks();
          markInteract();
          UI_MODULE.renderAll();
          try { window.aiPodTelemetry?.emit?.('explorer.filter', { platform: STATE.ui.app.platform, ts: new Date().toISOString() }); } catch {}
        }));
        document.getElementById('sort-filter')?.addEventListener('change', e => {
          STATE.ui.app.sort = e.target.value;
          resetMissionPicks();
          markInteract();
          UI_MODULE.renderAll();
          try { window.aiPodTelemetry?.emit?.('explorer.sort', { sort: STATE.ui.app.sort, ts: new Date().toISOString() }); } catch {}
        });
        document.getElementById('brand-filter')?.addEventListener('change', e => {
          STATE.ui.app.brand = e.target.value;
          resetMissionPicks();
          markInteract();
          UI_MODULE.renderAll();
          try { window.aiPodTelemetry?.emit?.('explorer.brand', { brand: STATE.ui.app.brand, ts: new Date().toISOString() }); } catch {}
        });
        document.querySelectorAll('.segment-filter').forEach(btn => btn.addEventListener('click', () => {
          document.querySelector('.segment-filter.active')?.classList.remove('active');
          btn.classList.add('active');
          STATE.ui.app.segment = btn.dataset.seg;
          resetMissionPicks();
          markInteract();
          UI_MODULE.renderTopPicks(APP.computeFilteredSet());
          try { window.aiPodTelemetry?.emit?.('explorer.segment', { segment: STATE.ui.app.segment, ts: new Date().toISOString() }); } catch {}
        }));
        document.getElementById('top-picks')?.addEventListener('click', async (e) => {
          const target = e.target.closest('[data-action]');
          if (!target) return;
          const model = target.getAttribute('data-model');
          const laptop = STATE.data.allLaptops.find(x => x.model === model);
          const action = target.getAttribute('data-action');
          if (action === 'launch-mission-picks') {
            STATE.ui.app.missionPickReady = true;
            markInteract();
            UI_MODULE.renderTopPicks(APP.computeFilteredSet());
            try { window.aiPodTelemetry?.emit?.('explorer.action', { action: 'mission-picks', ts: new Date().toISOString() }); } catch {}
          } else if (action === 'compare' && model) {
            const idx = STATE.ui.app.radarSelection.indexOf(model);
            if (idx > -1) STATE.ui.app.radarSelection.splice(idx, 1); else if (STATE.ui.app.radarSelection.length < 3) STATE.ui.app.radarSelection.push(model);
            UI_MODULE.renderTopPicks(APP.computeFilteredSet());
            UI_MODULE.renderRadarChart();
            try { window.aiPodTelemetry?.emit?.('explorer.action', { action: 'compare', model, ts: new Date().toISOString() }); } catch {}
          } else if (action === 'tool' && laptop) {
            UI_MODULE.ensureToolkitExpanded();
            await API_MODULE.callAIAgent('longevity-analyst', { laptop: model, laptopData: laptop }, document.getElementById('toolkit-console'));
            try { window.aiPodTelemetry?.emit?.('explorer.action', { action: 'tool', model, ts: new Date().toISOString() }); } catch {}
          }
        });
        const ensureExpanded = () => UI_MODULE.ensureToolkitExpanded();
        const summaryTrigger = document.getElementById('toolkit-summary-expand');
        if (summaryTrigger) {
            summaryTrigger.addEventListener('click', () => {
                ensureExpanded();
            });
        }
        const minimizeBtn = document.getElementById('toolkit-minimize');
        minimizeBtn?.addEventListener('click', () => UI_MODULE.minimizeToFab());
        const deckBackdrop = document.getElementById('deck-backdrop');
        deckBackdrop?.addEventListener('click', () => UI_MODULE.toggleDeckModal(false));
        const fab = document.getElementById('aipod-fab');
        fab?.addEventListener('click', () => UI_MODULE.toggleFabPopover());
        const fabPopover = document.getElementById('aipod-fab-popover');
        const fabClose = document.getElementById('aipod-fab-close');
        fabClose?.addEventListener('click', () => UI_MODULE.toggleFabPopover(false));
        // Centralize branding via AI POD if available
        try {
            const b = window.AI_POD?.branding || {};
            const t = String(b.title || 'AI BRADAA');
            const s = String(b.subtitle || 'Powered by Kaa-Ching!');
            const tEl = fabPopover?.querySelector('.brand-text .title');
            const sEl = fabPopover?.querySelector('.brand-text .subtitle');
            if (tEl) tEl.textContent = t;
            if (sEl) sEl.textContent = s;
        } catch {}
        document.addEventListener('click', (e) => {
            if (!fabPopover) return;
            const target = e.target;
            if (!(target instanceof Element)) return;
            if (fabPopover.dataset.open === 'true') {
                if (!fabPopover.contains(target) && target !== fab) UI_MODULE.toggleFabPopover(false);
            }
        });
        document.getElementById('aipod-fab-list')?.addEventListener('click', (e) => {
            const row = e.target.closest?.('.fab-row');
            if (!row) return;
            const sectionId = row.getAttribute('data-section-id');
            UI_MODULE.toggleFabPopover(false);
            if (sectionId && document.getElementById(sectionId)) {
                const el = document.getElementById(sectionId);
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (sectionId === 'toolkit') UI_MODULE.toggleDeckModal(true, { preserveCollapse: true });
            } else {
                UI_MODULE.toggleDeckModal(true, { preserveCollapse: true });
            }
        });
        const toolkitSection = document.getElementById('toolkit');
        if (toolkitSection) {
            toolkitSection.addEventListener('mouseleave', () => {
                if (!STATE.ui.toolkit.collapsed && !STATE.ui.toolkit.deckOpen) UI_MODULE.toggleToolkitCollapsed(true);
            });
            const io = new IntersectionObserver(entries => {
                const entry = entries[0];
                if (!entry) return;
                if (entry.intersectionRatio < 0.25 && !STATE.ui.toolkit.collapsed && !STATE.ui.toolkit.deckOpen) {
                    UI_MODULE.toggleToolkitCollapsed(true);
                }
            }, { threshold: [0, 0.25, 0.5, 0.75, 1] });
            io.observe(toolkitSection);
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && STATE.ui.toolkit.deckOpen) {
                e.preventDefault();
                UI_MODULE.toggleDeckModal(false, { preserveCollapse: false });
            }
        });

        document.getElementById('find-match-btn')?.addEventListener('click', () => {
            const payload = {
                criteria: {
                    budget: document.getElementById('match-budget').value,
                    usecase: document.getElementById('match-usecase').value,
                    portability: document.getElementById('match-portability').value
                },
                laptops: STATE.data.allLaptops
            };
            API_MODULE.callAIAgent('findMatch', payload, document.getElementById('matchmaker-output'));
            try { window.aiPodTelemetry?.emit?.('matchmaker.select', { counts: { selections: 1 }, ts: new Date().toISOString() }); } catch {}
        });

        document.getElementById('laptop-selector-container')?.addEventListener('click', e => {
            if (!e.target.classList.contains('radar-selector')) return;
            const btn = e.target;
            const model = btn.dataset.model;
            const idx = STATE.ui.app.radarSelection.indexOf(model);
            if (idx > -1) {
                STATE.ui.app.radarSelection.splice(idx, 1);
            } else if (STATE.ui.app.radarSelection.length < 3) {
                STATE.ui.app.radarSelection.push(model);
            }
            UI_MODULE.renderLaptopSelector(APP.computeFilteredSet());
            UI_MODULE.renderRadarChart();
            try { window.aiPodTelemetry?.emit?.('comparison.select', { counts: { selected: STATE.ui.app.radarSelection.length }, ts: new Date().toISOString() }); } catch {}
        });

        document.querySelectorAll('.tool-selector-btn').forEach(btn => btn.addEventListener('click', (e) => {
            ensureExpanded();
            document.querySelectorAll('.tool-selector-btn.active').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            UI_MODULE.renderToolkitConsole(e.currentTarget.dataset.tool);
        }));

        document.getElementById('toolkit-console')?.addEventListener('click', async e => {
            if (!e.target.matches('[data-tool-action]')) return;
            e.preventDefault();
            const btn = e.target;
            const action = btn.dataset.toolAction;
            const outputEl = document.getElementById('toolkit-output');
            ensureExpanded();
            let payload = {};
            const inputs = document.querySelectorAll('#toolkit-console [id^="tool-input-"]');
            inputs.forEach(input => {
                const key = input.id.replace('tool-input-', '');
                payload[key] = input.value;
            });
            if (['performance-forecaster', 'longevity-analyst', 'upgrade-strategist'].includes(action)) {
                payload.laptopData = STATE.data.allLaptops.find(l => l.model === payload.laptop);
            }
            // Live mock state on buttons and ferrofluid
            try { UI_MODULE.updateToolkitBriefing?.('running', { action }); } catch {}
            btn.setAttribute('data-live', 'running');
            document.querySelector('.tool-selector-btn.active')?.setAttribute('data-live', 'running');
            const res = await API_MODULE.callAIAgent(action, payload, outputEl);
            const state = res?.ok ? 'success' : 'error';
            btn.setAttribute('data-live', state);
            document.querySelector('.tool-selector-btn.active')?.setAttribute('data-live', state);
            setTimeout(() => { btn.removeAttribute('data-live'); document.querySelector('.tool-selector-btn.active')?.removeAttribute('data-live'); }, 1400);
        });

        document.body.addEventListener('click', e => {
            const priceToggle = e.target.closest('[data-action="toggle-price-menu"]');
            document.querySelectorAll('.price-menu:not(.hidden)').forEach(m => {
                if (!priceToggle || m.id !== `price-menu-${priceToggle.dataset.index}`) {
                    m.classList.add('hidden');
                }
            });
            if (priceToggle) {
                const menu = document.getElementById(`price-menu-${priceToggle.dataset.index}`);
                if (menu) menu.classList.toggle('hidden');
            }
        });

        const navLinks = Array.from(document.querySelectorAll('.nav-button'));
        const sections = Array.from(document.querySelectorAll('main section'));
        const scrollToSection = (target) => {
          const el = typeof target === 'string' ? document.querySelector(target) : target;
          if (!el) return;
          const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          el.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'start' });
        };
        navLinks.forEach(btn => {
          btn.addEventListener('click', () => {
            const selector = btn.getAttribute('data-target');
            if (!selector) return;
            scrollToSection(selector);
            navLinks.forEach(link => link.classList.toggle('active', link === btn));
          });
        });
        const observer = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            const id = entry.target.id;
            navLinks.forEach(link => {
              const selector = link.getAttribute('data-target');
              const match = selector === `#${id}`;
              link.classList.toggle('active', match);
              link.setAttribute('aria-selected', match ? 'true' : 'false');
            });
          });
        }, { rootMargin: '-35% 0px -55% 0px', threshold: [0.2, 0.4, 0.6] });
        sections.forEach(section => observer.observe(section));
      },
      async initialize() {
        try {
          const raw = localStorage.getItem('AI_MISSION_BRIEFS_V1');
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') STATE.data.aiBriefCache = parsed;
          }
        } catch {}
        UI_MODULE.configureCharts();
        // Mobile deep link routing (non-destructive)
        try { window.AI_POD?.mobile?.deeplink?.route?.(window.location); } catch {}
        await API_MODULE.fetchMarketIntel();
        const tsEl = document.getElementById('camera-ts');
        if (tsEl) {
          try { tsEl.textContent = new Date().toLocaleString('en-MY', { timeZone: 'Asia/Kuala_Lumpur', hour12: false }); } catch {}
          try { window.aiPodTelemetry?.emit?.('camera.section.view', { ts: new Date().toISOString() }); } catch {}
        }
        // Ensure value_rating present for legacy entries
        try { STATE.data.allLaptops.forEach(l => { if (!('value_rating' in l)) { const p = Number(l.price)||0; const s = Number(l.score)||0; l.value_rating = p>0 ? Number((s / (p/1000)).toFixed(4)) : 0; } }); } catch {}
        STATE.data.sortedByRank = [...STATE.data.allLaptops].sort((a, b) => b.score - a.score).map((item, index) => ({ ...item, rank: index + 1 }));

        const brandSelect = document.getElementById('brand-filter');
        if (brandSelect) {
          brandSelect.innerHTML = '<option value="All" selected>All Brands</option>' + [...new Set(STATE.data.allLaptops.map(l => l.brand))].sort().map(b => `<option value="${b}">${b}</option>`).join('');
        }
        
        UI_MODULE.renderAll();
        UI_MODULE.renderRadarChart();
        UI_MODULE.renderToolkitConsole('deal-assassin');
        UI_MODULE.initFerrofluid();
        this.setupEventListeners();
        try { UI_MODULE['AI Bradaa Branding prototype v1'](); } catch {}
        try { UI_MODULE['AI Bradaa thinking prototype v1'](); } catch {}
        // Track non-deck AI tasks (e.g., tools wired directly via AI_POD.provider)
        window.addEventListener('aipod:task', (ev) => {
          const d = ev?.detail || {};
          if (d.state === 'start') {
            const label = d.label || d.task || 'AI Task';
            try { UI_MODULE.updateToolkitBriefing('running', { action: label }); } catch {}
            const job = UI_MODULE.queueJob({ task: label, scope: d.scope || 'deck', sectionId: 'toolkit', externalId: d.id });
            if (job?.meta) job.meta.externalId = d.id; else job.meta = { externalId: d.id };
          } else if (d.state === 'end') {
            const job = STATE.ui.toolkit.jobs.find(j => j.meta?.externalId === d.id);
            if (job) UI_MODULE.resolveJob(job.id, d.ok ? 'success' : 'error');
          }
        });
        
        // Intel is now lazy-loaded by IntersectionObserver in app/js/aipod/intel-cards.js
      }
  };
  
  document.addEventListener('DOMContentLoaded', () => APP.initialize());
  window.addEventListener('toolkit:ready', () => {
    UI_MODULE.renderToolkitPreview();
    // Intel soft-refresh (45m) when tab visible
    try {
      const INTEL_REFRESH_MS = 45 * 60 * 1000;
      let intelTimer = null;
      const refreshIntel = (reason) => {
        if (document.hidden) return;
        try { window.aiPodTelemetry?.emit?.('intel.refresh', { reason, ts: new Date().toISOString() }); } catch {}
        // Try dataset first, then fallback to AI agent
        (async () => {
          const ok = await UI_MODULE.refreshIntelDataset(reason);
          if (!ok) {
            try { await API_MODULE.callAIAgent('getFutureIntel'); } catch {}
          }
        })();
      };
      const startIntelTimer = () => {
        if (intelTimer) clearInterval(intelTimer);
        intelTimer = setInterval(() => refreshIntel('interval'), INTEL_REFRESH_MS);
      };
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) refreshIntel('visibility');
      });
      // initial
      refreshIntel('startup');
      startIntelTimer();
    } catch {}
  });
})();
</script>

<!-- Lottie library (SVG renderer) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<!-- AI Bradaa Soul initialiser (inner blob only; outer ring unchanged) -->
  <script src="./js/soul.js" defer></script>
  <script src="/ai_pod/prototypes/soul_v1/fsm.js" defer></script>
  <script src="/ai_pod/mobile/bridge/index.js" defer></script>
  <script src="/ai_pod/mobile/bridge/deepLinkRouter.js" defer></script>
  <script type="module" src="/ai_pod/adapters/aiClient.js"></script>
  <script src="/ai_pod/clients/geminiClient.js" defer></script>
  <script src="./js/aipod/provider-proxy.js" defer></script>
  <script type="module" src="./js/ai-pod-loader.js"></script>
</body>
</html>
